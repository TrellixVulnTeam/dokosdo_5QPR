{"version":3,"file":"erpnext.min.js","sources":["../../../apps/erpnext/erpnext/public/js/conf.js","../../../apps/erpnext/erpnext/public/js/utils.js","../../../apps/erpnext/erpnext/public/js/queries.js","../../../apps/erpnext/erpnext/public/js/sms_manager.js","../../../apps/erpnext/erpnext/public/js/utils/party.js","../../../apps/erpnext/erpnext/public/js/controllers/stock_controller.js","../../../apps/erpnext/erpnext/public/js/payment/payments.js","../../../apps/erpnext/erpnext/public/js/controllers/taxes_and_totals.js","../../../apps/erpnext/erpnext/public/js/controllers/transaction.js","../../../apps/erpnext/erpnext/public/js/utils/item_selector.js","../../../apps/erpnext/erpnext/public/js/help_links.js","../../../apps/erpnext/erpnext/public/js/utils/item_quick_entry.js","../../../apps/erpnext/erpnext/public/js/utils/customer_quick_entry.js","../../../apps/erpnext/erpnext/public/js/utils/dimension_tree_filter.js","../../../apps/erpnext/erpnext/public/js/telephony.js"],"sourcesContent":["// Copyright (c) 2015, Frappe Technologies Pvt. Ltd. and Contributors\n// License: GNU General Public License v3. See license.txt\n\nfrappe.provide('erpnext');\n\n// preferred modules for breadcrumbs\n$.extend(frappe.breadcrumbs.preferred, {\n\t\"Item Group\": \"Stock\",\n\t\"Customer Group\": \"Selling\",\n\t\"Supplier Group\": \"Buying\",\n\t\"Territory\": \"Selling\",\n\t\"Sales Person\": \"Selling\",\n\t\"Sales Partner\": \"Selling\",\n\t\"Brand\": \"Selling\",\n\t\"Maintenance Schedule\": \"Support\",\n\t\"Maintenance Visit\": \"Support\"\n});\n\n$.extend(frappe.breadcrumbs.module_map, {\n\t'ERPNext Integrations': 'Integrations',\n\t'Geo': 'Settings',\n\t'Portal': 'Website',\n\t'Utilities': 'Settings',\n\t'Shopping Cart': 'Website',\n\t'Contacts': 'CRM',\n\t'Accounts': 'Accounting'\n});\n","// Copyright (c) 2015, Frappe Technologies Pvt. Ltd. and Contributors\n// License: GNU General Public License v3. See license.txt\nfrappe.provide(\"erpnext\");\nfrappe.provide(\"erpnext.utils\");\n\n$.extend(erpnext, {\n\tget_currency: function(company) {\n\t\tif(!company && cur_frm)\n\t\t\tcompany = cur_frm.doc.company;\n\t\tif(company)\n\t\t\treturn frappe.get_doc(\":Company\", company).default_currency || frappe.boot.sysdefaults.currency;\n\t\telse\n\t\t\treturn frappe.boot.sysdefaults.currency;\n\t},\n\n\tget_presentation_currency_list: () => {\n\t\tconst docs = frappe.boot.docs;\n\t\tlet currency_list = docs.filter(d => d.doctype === \":Currency\").map(d => d.name);\n\t\tcurrency_list.unshift(\"\");\n\t\treturn currency_list;\n\t},\n\n\ttoggle_naming_series: function() {\n\t\tif(cur_frm.fields_dict.naming_series) {\n\t\t\tcur_frm.toggle_display(\"naming_series\", cur_frm.doc.__islocal?true:false);\n\t\t}\n\t},\n\n\thide_company: function() {\n\t\tif(cur_frm.fields_dict.company) {\n\t\t\tvar companies = Object.keys(locals[\":Company\"] || {});\n\t\t\tif(companies.length === 1) {\n\t\t\t\tif(!cur_frm.doc.company) cur_frm.set_value(\"company\", companies[0]);\n\t\t\t\tcur_frm.toggle_display(\"company\", false);\n\t\t\t} else if(erpnext.last_selected_company) {\n\t\t\t\tif(!cur_frm.doc.company) cur_frm.set_value(\"company\", erpnext.last_selected_company);\n\t\t\t}\n\t\t}\n\t},\n\n\tis_perpetual_inventory_enabled: function(company) {\n\t\tif(company) {\n\t\t\treturn frappe.get_doc(\":Company\", company).enable_perpetual_inventory\n\t\t}\n\t},\n\n\tstale_rate_allowed: () => {\n\t\treturn cint(frappe.boot.sysdefaults.allow_stale);\n\t},\n\n\tsetup_serial_no: function() {\n\t\tvar grid_row = cur_frm.open_grid_row();\n\t\tif(!grid_row || !grid_row.grid_form.fields_dict.serial_no ||\n\t\t\tgrid_row.grid_form.fields_dict.serial_no.get_status()!==\"Write\") return;\n\n\t\tvar $btn = $('<button class=\"btn btn-sm btn-default\">'+__(\"Add Serial No\")+'</button>')\n\t\t\t.appendTo($(\"<div>\")\n\t\t\t\t.css({\"margin-bottom\": \"10px\", \"margin-top\": \"10px\"})\n\t\t\t\t.appendTo(grid_row.grid_form.fields_dict.serial_no.$wrapper));\n\n\t\tvar me = this;\n\t\t$btn.on(\"click\", function() {\n\t\t\tlet callback = '';\n\t\t\tlet on_close = '';\n\n\t\t\tfrappe.model.get_value('Item', {'name':grid_row.doc.item_code}, 'has_serial_no',\n\t\t\t\t(data) => {\n\t\t\t\t\tif(data) {\n\t\t\t\t\t\tgrid_row.doc.has_serial_no = data.has_serial_no;\n\t\t\t\t\t\tme.show_serial_batch_selector(grid_row.frm, grid_row.doc,\n\t\t\t\t\t\t\tcallback, on_close, true);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t);\n\t\t});\n\t},\n\n\troute_to_adjustment_jv: (args) => {\n\t\tfrappe.model.with_doctype('Journal Entry', () => {\n\t\t\t// route to adjustment Journal Entry to handle Account Balance and Stock Value mismatch\n\t\t\tlet journal_entry = frappe.model.get_new_doc('Journal Entry');\n\n\t\t\targs.accounts.forEach((je_account) => {\n\t\t\t\tlet child_row = frappe.model.add_child(journal_entry, \"accounts\");\n\t\t\t\tchild_row.account = je_account.account;\n\t\t\t\tchild_row.debit_in_account_currency = je_account.debit_in_account_currency;\n\t\t\t\tchild_row.credit_in_account_currency = je_account.credit_in_account_currency;\n\t\t\t\tchild_row.party_type = \"\" ;\n\t\t\t});\n\t\t\tfrappe.set_route('Form','Journal Entry', journal_entry.name);\n\t\t});\n\t}\n});\n\n$.extend(erpnext.utils, {\n\tset_party_dashboard_indicators: function(frm) {\n\t\tif(frm.doc.__onload && frm.doc.__onload.dashboard_info) {\n\t\t\tvar company_wise_info = frm.doc.__onload.dashboard_info;\n\t\t\tif(company_wise_info.length > 1) {\n\t\t\t\tcompany_wise_info.forEach(function(info) {\n\t\t\t\t\terpnext.utils.add_indicator_for_multicompany(frm, info);\n\t\t\t\t});\n\t\t\t} else if (company_wise_info.length === 1) {\n\t\t\t\tfrm.dashboard.add_indicator(__('Annual Billing: {0}',\n\t\t\t\t\t[format_currency(company_wise_info[0].billing_this_year, company_wise_info[0].currency)]), 'blue');\n\t\t\t\tfrm.dashboard.add_indicator(__('Total Unpaid: {0}',\n\t\t\t\t\t[format_currency(company_wise_info[0].total_unpaid, company_wise_info[0].currency)]),\n\t\t\t\tcompany_wise_info[0].total_unpaid ? 'orange' : 'green');\n\n\t\t\t\tif(company_wise_info[0].loyalty_points) {\n\t\t\t\t\tfrm.dashboard.add_indicator(__('Loyalty Points: {0}',\n\t\t\t\t\t\t[company_wise_info[0].loyalty_points]), 'blue');\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\n\tadd_indicator_for_multicompany: function(frm, info) {\n\t\tfrm.dashboard.stats_area.removeClass('hidden');\n\t\tfrm.dashboard.stats_area_row.addClass('flex');\n\t\tfrm.dashboard.stats_area_row.css('flex-wrap', 'wrap');\n\n\t\tvar color = info.total_unpaid ? 'orange' : 'green';\n\n\t\tvar indicator = $('<div class=\"flex-column col-xs-6\">'+\n\t\t\t'<div style=\"margin-top:10px\"><h6>'+info.company+'</h6></div>'+\n\n\t\t\t'<div class=\"badge-link small\" style=\"margin-bottom:10px\"><span class=\"indicator blue\">'+\n\t\t\t'Annual Billing: '+format_currency(info.billing_this_year, info.currency)+'</span></div>'+\n\n\t\t\t'<div class=\"badge-link small\" style=\"margin-bottom:10px\">'+\n\t\t\t'<span class=\"indicator '+color+'\">Total Unpaid: '\n\t\t\t+format_currency(info.total_unpaid, info.currency)+'</span></div>'+\n\n\n\t\t\t'</div>').appendTo(frm.dashboard.stats_area_row);\n\n\t\tif(info.loyalty_points){\n\t\t\t$('<div class=\"badge-link small\" style=\"margin-bottom:10px\"><span class=\"indicator blue\">'+\n\t\t\t'Loyalty Points: '+info.loyalty_points+'</span></div>').appendTo(indicator);\n\t\t}\n\n\t\treturn indicator;\n\t},\n\n\tget_party_name: function(party_type) {\n\t\tvar dict = {'Customer': 'customer_name', 'Supplier': 'supplier_name', 'Employee': 'employee_name',\n\t\t\t'Member': 'member_name'};\n\t\treturn dict[party_type];\n\t},\n\n\tcopy_value_in_all_rows: function(doc, dt, dn, table_fieldname, fieldname) {\n\t\tvar d = locals[dt][dn];\n\t\tif(d[fieldname]){\n\t\t\tvar cl = doc[table_fieldname] || [];\n\t\t\tfor(var i = 0; i < cl.length; i++) {\n\t\t\t\tif(!cl[i][fieldname]) cl[i][fieldname] = d[fieldname];\n\t\t\t}\n\t\t}\n\t\trefresh_field(table_fieldname);\n\t},\n\n\tget_terms: function(tc_name, doc, callback) {\n\t\tif(tc_name) {\n\t\t\treturn frappe.call({\n\t\t\t\tmethod: 'erpnext.setup.doctype.terms_and_conditions.terms_and_conditions.get_terms_and_conditions',\n\t\t\t\targs: {\n\t\t\t\t\ttemplate_name: tc_name,\n\t\t\t\t\tdoc: doc\n\t\t\t\t},\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tcallback(r)\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t},\n\n\tmake_bank_account: function(doctype, docname) {\n\t\tfrappe.call({\n\t\t\tmethod: \"erpnext.accounts.doctype.bank_account.bank_account.make_bank_account\",\n\t\t\targs: {\n\t\t\t\tdoctype: doctype,\n\t\t\t\tdocname: docname\n\t\t\t},\n\t\t\tfreeze: true,\n\t\t\tcallback: function(r) {\n\t\t\t\tvar doclist = frappe.model.sync(r.message);\n\t\t\t\tfrappe.set_route(\"Form\", doclist[0].doctype, doclist[0].name);\n\t\t\t}\n\t\t})\n\t},\n\n\tadd_dimensions: function(report_name, index) {\n\t\tlet filters = frappe.query_reports[report_name].filters;\n\n\t\tfrappe.call({\n\t\t\tmethod: \"erpnext.accounts.doctype.accounting_dimension.accounting_dimension.get_dimensions\",\n\t\t\tcallback: function(r) {\n\t\t\t\tlet accounting_dimensions = r.message[0];\n\t\t\t\taccounting_dimensions.forEach((dimension) => {\n\t\t\t\t\tlet found = filters.some(el => el.fieldname === dimension['fieldname']);\n\n\t\t\t\t\tif (!found) {\n\t\t\t\t\t\tfilters.splice(index, 0, {\n\t\t\t\t\t\t\t\"fieldname\": dimension[\"fieldname\"],\n\t\t\t\t\t\t\t\"label\": __(dimension[\"label\"]),\n\t\t\t\t\t\t\t\"fieldtype\": \"Link\",\n\t\t\t\t\t\t\t\"options\": dimension[\"document_type\"]\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t},\n\n\tmake_auto_repeat: function(doctype, docname) {\n\t\tfrappe.call({\n\t\t\tmethod: \"frappe.automation.doctype.auto_repeat.auto_repeat.make_auto_repeat\",\n\t\t\targs: {\n\t\t\t\tdoctype: doctype,\n\t\t\t\tdocname: docname\n\t\t\t},\n\t\t\tcallback: function(r) {\n\t\t\t\tvar doclist = frappe.model.sync(r.message);\n\t\t\t\tfrappe.set_route(\"Form\", doclist[0].doctype, doclist[0].name);\n\t\t\t}\n\t\t})\n\t},\n\n\tmake_pricing_rule: function(doctype, docname) {\n\t\tfrappe.call({\n\t\t\tmethod: \"erpnext.accounts.doctype.pricing_rule.pricing_rule.make_pricing_rule\",\n\t\t\targs: {\n\t\t\t\tdoctype: doctype,\n\t\t\t\tdocname: docname\n\t\t\t},\n\t\t\tcallback: function(r) {\n\t\t\t\tvar doclist = frappe.model.sync(r.message);\n\t\t\t\tfrappe.set_route(\"Form\", doclist[0].doctype, doclist[0].name);\n\t\t\t}\n\t\t})\n\t},\n\n\t/**\n\t* Checks if the first row of a given child table is empty\n\t* @param child_table - Child table Doctype\n\t* @return {Boolean}\n\t**/\n\tfirst_row_is_empty: function(child_table){\n\t\tif($.isArray(child_table) && child_table.length > 0) {\n\t\t\treturn !child_table[0].item_code;\n\t\t}\n\t\treturn false;\n\t},\n\n\t/**\n\t* Removes the first row of a child table if it is empty\n\t* @param {_Frm} frm - The current form\n\t* @param {String} child_table_name - The child table field name\n\t* @return {Boolean}\n\t**/\n\tremove_empty_first_row: function(frm, child_table_name){\n\t\tconst rows = frm['doc'][child_table_name];\n\t\tif (this.first_row_is_empty(rows)){\n\t\t\tfrm['doc'][child_table_name] = rows.splice(1);\n\t\t}\n\t\treturn rows;\n\t},\n\tget_tree_options: function(option) {\n\t\t// get valid options for tree based on user permission & locals dict\n\t\tlet unscrub_option = frappe.model.unscrub(option);\n\t\tlet user_permission = frappe.defaults.get_user_permissions();\n\t\tlet options;\n\n\t\tif(user_permission && user_permission[unscrub_option]) {\n\t\t\toptions = user_permission[unscrub_option].map(perm => perm.doc);\n\t\t} else {\n\t\t\toptions = $.map(locals[`:${unscrub_option}`], function(c) { return c.name; }).sort();\n\t\t}\n\n\t\t// filter unique values, as there may be multiple user permissions for any value\n\t\treturn options.filter((value, index, self) => self.indexOf(value) === index);\n\t},\n\tget_tree_default: function(option) {\n\t\t// set default for a field based on user permission\n\t\tlet options = this.get_tree_options(option);\n\t\tif(options.includes(frappe.defaults.get_default(option))) {\n\t\t\treturn frappe.defaults.get_default(option);\n\t\t} else {\n\t\t\treturn options[0];\n\t\t}\n\t},\n\toverrides_parent_value_in_all_rows: function(doc, dt, dn, table_fieldname, fieldname, parent_fieldname) {\n\t\tif (doc[parent_fieldname]) {\n\t\t\tlet cl = doc[table_fieldname] || [];\n\t\t\tfor (let i = 0; i < cl.length; i++) {\n\t\t\t\tcl[i][fieldname] = doc[parent_fieldname];\n\t\t\t}\n\t\t\tfrappe.refresh_field(table_fieldname);\n\t\t}\n\t},\n\tcreate_new_doc: function (doctype, update_fields) {\n\t\tfrappe.model.with_doctype(doctype, function() {\n\t\t\tvar new_doc = frappe.model.get_new_doc(doctype);\n\t\t\tfor (let [key, value] of Object.entries(update_fields)) {\n\t\t\t\tnew_doc[key] = value;\n\t\t\t}\n\t\t\tfrappe.ui.form.make_quick_entry(doctype, null, null, new_doc);\n\t\t});\n\t}\n\n});\n\nerpnext.utils.select_alternate_items = function(opts) {\n\tconst frm = opts.frm;\n\tconst warehouse_field = opts.warehouse_field || 'warehouse';\n\tconst item_field = opts.item_field || 'item_code';\n\n\tthis.data = [];\n\tconst dialog = new frappe.ui.Dialog({\n\t\ttitle: __(\"Select Alternate Item\"),\n\t\tfields: [\n\t\t\t{fieldtype:'Section Break', label: __('Items')},\n\t\t\t{\n\t\t\t\tfieldname: \"alternative_items\", fieldtype: \"Table\", cannot_add_rows: true,\n\t\t\t\tin_place_edit: true, data: this.data,\n\t\t\t\tget_data: () => {\n\t\t\t\t\treturn this.data;\n\t\t\t\t},\n\t\t\t\tfields: [{\n\t\t\t\t\tfieldtype:'Data',\n\t\t\t\t\tfieldname:\"docname\",\n\t\t\t\t\thidden: 1\n\t\t\t\t}, {\n\t\t\t\t\tfieldtype:'Link',\n\t\t\t\t\tfieldname:\"item_code\",\n\t\t\t\t\toptions: 'Item',\n\t\t\t\t\tin_list_view: 1,\n\t\t\t\t\tread_only: 0,\n\t\t\t\t\tdisabled: 0,\n\t\t\t\t\tlabel: __('Item Code')\n\t\t\t\t}, {\n\t\t\t\t\tfieldtype:'Link',\n\t\t\t\t\tfieldname:\"alternate_item\",\n\t\t\t\t\toptions: 'Item',\n\t\t\t\t\tdefault: \"\",\n\t\t\t\t\tin_list_view: 1,\n\t\t\t\t\tlabel: __('Alternate Item'),\n\t\t\t\t\tonchange: function() {\n\t\t\t\t\t\tconst item_code = this.get_value();\n\t\t\t\t\t\tconst warehouse = this.grid_row.on_grid_fields_dict.warehouse.get_value();\n\t\t\t\t\t\tif (item_code && warehouse) {\n\t\t\t\t\t\t\tfrappe.call({\n\t\t\t\t\t\t\t\tmethod: \"erpnext.stock.utils.get_latest_stock_qty\",\n\t\t\t\t\t\t\t\targs: {\n\t\t\t\t\t\t\t\t\titem_code: item_code,\n\t\t\t\t\t\t\t\t\twarehouse: warehouse\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\tcallback: (r) => {\n\t\t\t\t\t\t\t\t\tthis.grid_row.on_grid_fields_dict\n\t\t\t\t\t\t\t\t\t\t.actual_qty.set_value(r.message || 0);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\tget_query: (e) => {\n\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\tquery: \"erpnext.stock.doctype.item_alternative.item_alternative.get_alternative_items\",\n\t\t\t\t\t\t\tfilters: {\n\t\t\t\t\t\t\t\titem_code: e.item_code\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\t\t\t\t}, {\n\t\t\t\t\tfieldtype:'Link',\n\t\t\t\t\tfieldname:\"warehouse\",\n\t\t\t\t\toptions: 'Warehouse',\n\t\t\t\t\tdefault: \"\",\n\t\t\t\t\tin_list_view: 1,\n\t\t\t\t\tlabel: __('Warehouse'),\n\t\t\t\t\tonchange: function() {\n\t\t\t\t\t\tconst warehouse = this.get_value();\n\t\t\t\t\t\tconst item_code = this.grid_row.on_grid_fields_dict.item_code.get_value();\n\t\t\t\t\t\tif (item_code && warehouse) {\n\t\t\t\t\t\t\tfrappe.call({\n\t\t\t\t\t\t\t\tmethod: \"erpnext.stock.utils.get_latest_stock_qty\",\n\t\t\t\t\t\t\t\targs: {\n\t\t\t\t\t\t\t\t\titem_code: item_code,\n\t\t\t\t\t\t\t\t\twarehouse: warehouse\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\tcallback: (r) => {\n\t\t\t\t\t\t\t\t\tthis.grid_row.on_grid_fields_dict\n\t\t\t\t\t\t\t\t\t\t.actual_qty.set_value(r.message || 0);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t}, {\n\t\t\t\t\tfieldtype:'Float',\n\t\t\t\t\tfieldname:\"actual_qty\",\n\t\t\t\t\tdefault: 0,\n\t\t\t\t\tread_only: 1,\n\t\t\t\t\tin_list_view: 1,\n\t\t\t\t\tlabel: __('Available Qty')\n\t\t\t\t}]\n\t\t\t},\n\t\t],\n\t\tprimary_action: function() {\n\t\t\tconst args = this.get_values()[\"alternative_items\"];\n\t\t\tconst alternative_items = args.filter(d => {\n\t\t\t\tif (d.alternate_item && d.item_code != d.alternate_item) {\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t});\n\n\t\t\talternative_items.forEach(d => {\n\t\t\t\tlet row = frappe.get_doc(opts.child_doctype, d.docname);\n\t\t\t\tlet qty = null;\n\t\t\t\tif (row.doctype === 'Work Order Item') {\n\t\t\t\t\tqty = row.required_qty;\n\t\t\t\t} else {\n\t\t\t\t\tqty = row.qty;\n\t\t\t\t}\n\t\t\t\trow[item_field] = d.alternate_item;\n\t\t\t\tfrm.script_manager.trigger(item_field, row.doctype, row.name)\n\t\t\t\t\t.then(() => {\n\t\t\t\t\t\tfrappe.model.set_value(row.doctype, row.name, 'qty', qty);\n\t\t\t\t\t\tfrappe.model.set_value(row.doctype, row.name,\n\t\t\t\t\t\t\topts.original_item_field, d.item_code);\n\t\t\t\t\t});\n\t\t\t});\n\n\t\t\trefresh_field(opts.child_docname);\n\t\t\tthis.hide();\n\t\t},\n\t\tprimary_action_label: __('Update')\n\t});\n\n\tfrm.doc[opts.child_docname].forEach(d => {\n\t\tif (!opts.condition || opts.condition(d)) {\n\t\t\tdialog.fields_dict.alternative_items.df.data.push({\n\t\t\t\t\"docname\": d.name,\n\t\t\t\t\"item_code\": d[item_field],\n\t\t\t\t\"warehouse\": d[warehouse_field],\n\t\t\t\t\"actual_qty\": d.actual_qty\n\t\t\t});\n\t\t}\n\t})\n\n\tthis.data = dialog.fields_dict.alternative_items.df.data;\n\tdialog.fields_dict.alternative_items.grid.refresh();\n\tdialog.show();\n}\n\nerpnext.utils.update_child_items = function(opts) {\n\tconst frm = opts.frm;\n\tconst cannot_add_row = (typeof opts.cannot_add_row === 'undefined') ? true : opts.cannot_add_row;\n\tconst child_docname = (typeof opts.cannot_add_row === 'undefined') ? \"items\" : opts.child_docname;\n\tconst child_meta = frappe.get_meta(`${frm.doc.doctype} Item`);\n\tconst get_precision = (fieldname) => child_meta.fields.find(f => f.fieldname == fieldname).precision;\n\n\tthis.data = [];\n\tconst fields = [{\n\t\tfieldtype:'Data',\n\t\tfieldname:\"docname\",\n\t\tread_only: 1,\n\t\thidden: 1,\n\t}, {\n\t\tfieldtype:'Link',\n\t\tfieldname:\"item_code\",\n\t\toptions: 'Item',\n\t\tin_list_view: 1,\n\t\tread_only: 0,\n\t\tdisabled: 0,\n\t\tlabel: __('Item Code')\n\t}, {\n\t\tfieldtype:'Link',\n\t\tfieldname:'uom',\n\t\toptions: 'UOM',\n\t\tread_only: 0,\n\t\tlabel: __('UOM'),\n\t\treqd: 1,\n\t\tonchange: function () {\n\t\t\tfrappe.call({\n\t\t\t\tmethod: \"erpnext.stock.get_item_details.get_conversion_factor\",\n\t\t\t\targs: { item_code: this.doc.item_code, uom: this.value },\n\t\t\t\tcallback: r => {\n\t\t\t\t\tif(!r.exc) {\n\t\t\t\t\t\tif (this.doc.conversion_factor == r.message.conversion_factor) return;\n\n\t\t\t\t\t\tconst docname = this.doc.docname;\n\t\t\t\t\t\tdialog.fields_dict.trans_items.df.data.some(doc => {\n\t\t\t\t\t\t\tif (doc.docname == docname) {\n\t\t\t\t\t\t\t\tdoc.conversion_factor = r.message.conversion_factor;\n\t\t\t\t\t\t\t\tdialog.fields_dict.trans_items.grid.refresh();\n\t\t\t\t\t\t\t\treturn true;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}, {\n\t\tfieldtype:'Float',\n\t\tfieldname:\"qty\",\n\t\tdefault: 0,\n\t\tread_only: 0,\n\t\tin_list_view: 1,\n\t\tlabel: __('Qty'),\n\t\tprecision: get_precision(\"qty\")\n\t}, {\n\t\tfieldtype:'Currency',\n\t\tfieldname:\"rate\",\n\t\toptions: \"currency\",\n\t\tdefault: 0,\n\t\tread_only: 0,\n\t\tin_list_view: 1,\n\t\tlabel: __('Rate'),\n\t\tprecision: get_precision(\"rate\")\n\t}];\n\n\tif (frm.doc.doctype == 'Sales Order' || frm.doc.doctype == 'Purchase Order' ) {\n\t\tfields.splice(2, 0, {\n\t\t\tfieldtype: 'Date',\n\t\t\tfieldname: frm.doc.doctype == 'Sales Order' ? \"delivery_date\" : \"schedule_date\",\n\t\t\tin_list_view: 1,\n\t\t\tlabel: frm.doc.doctype == 'Sales Order' ? __(\"Delivery Date\") : __(\"Reqd by date\"),\n\t\t\treqd: 1\n\t\t})\n\t\tfields.splice(3, 0, {\n\t\t\tfieldtype: 'Float',\n\t\t\tfieldname: \"conversion_factor\",\n\t\t\tin_list_view: 1,\n\t\t\tlabel: __(\"Conversion Factor\"),\n\t\t\tprecision: get_precision('conversion_factor')\n\t\t})\n\t}\n\n\tconst dialog = new frappe.ui.Dialog({\n\t\ttitle: __(\"Update Items\"),\n\t\tfields: [\n\t\t\t{\n\t\t\t\tfieldname: \"trans_items\",\n\t\t\t\tfieldtype: \"Table\",\n\t\t\t\tlabel: \"Items\",\n\t\t\t\tcannot_add_rows: cannot_add_row,\n\t\t\t\tin_place_edit: false,\n\t\t\t\treqd: 1,\n\t\t\t\tdata: this.data,\n\t\t\t\tget_data: () => {\n\t\t\t\t\treturn this.data;\n\t\t\t\t},\n\t\t\t\tfields: fields\n\t\t\t},\n\t\t],\n\t\tprimary_action: function() {\n\t\t\tconst trans_items = this.get_values()[\"trans_items\"];\n\t\t\tfrappe.call({\n\t\t\t\tmethod: 'erpnext.controllers.accounts_controller.update_child_qty_rate',\n\t\t\t\tfreeze: true,\n\t\t\t\targs: {\n\t\t\t\t\t'parent_doctype': frm.doc.doctype,\n\t\t\t\t\t'trans_items': trans_items,\n\t\t\t\t\t'parent_doctype_name': frm.doc.name,\n\t\t\t\t\t'child_docname': child_docname\n\t\t\t\t},\n\t\t\t\tcallback: function() {\n\t\t\t\t\tfrm.reload_doc();\n\t\t\t\t}\n\t\t\t});\n\t\t\tthis.hide();\n\t\t\trefresh_field(\"items\");\n\t\t},\n\t\tprimary_action_label: __('Update')\n\t});\n\n\tfrm.doc[opts.child_docname].forEach(d => {\n\t\tdialog.fields_dict.trans_items.df.data.push({\n\t\t\t\"docname\": d.name,\n\t\t\t\"name\": d.name,\n\t\t\t\"item_code\": d.item_code,\n\t\t\t\"delivery_date\": d.delivery_date,\n\t\t\t\"schedule_date\": d.schedule_date,\n\t\t\t\"conversion_factor\": d.conversion_factor,\n\t\t\t\"qty\": d.qty,\n\t\t\t\"rate\": d.rate,\n\t\t\t\"uom\": d.uom\n\t\t});\n\t\tthis.data = dialog.fields_dict.trans_items.df.data;\n\t\tdialog.fields_dict.trans_items.grid.refresh();\n\t})\n\tdialog.show();\n}\n\nerpnext.utils.map_current_doc = function(opts) {\n\tfunction _map() {\n\t\tif($.isArray(cur_frm.doc.items) && cur_frm.doc.items.length > 0) {\n\t\t\t// remove first item row if empty\n\t\t\tif(!cur_frm.doc.items[0].item_code) {\n\t\t\t\tcur_frm.doc.items = cur_frm.doc.items.splice(1);\n\t\t\t}\n\n\t\t\t// find the doctype of the items table\n\t\t\tvar items_doctype = frappe.meta.get_docfield(cur_frm.doctype, 'items').options;\n\n\t\t\t// find the link fieldname from items table for the given\n\t\t\t// source_doctype\n\t\t\tvar link_fieldname = null;\n\t\t\tfrappe.get_meta(items_doctype).fields.forEach(function(d) {\n\t\t\t\tif(d.options===opts.source_doctype) link_fieldname = d.fieldname; });\n\n\t\t\t// search in existing items if the source_name is already set and full qty fetched\n\t\t\tvar already_set = false;\n\t\t\tvar item_qty_map = {};\n\n\t\t\t$.each(cur_frm.doc.items, function(i, d) {\n\t\t\t\topts.source_name.forEach(function(src) {\n\t\t\t\t\tif(d[link_fieldname]==src) {\n\t\t\t\t\t\talready_set = true;\n\t\t\t\t\t\tif (item_qty_map[d.item_code])\n\t\t\t\t\t\t\titem_qty_map[d.item_code] += flt(d.qty);\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\titem_qty_map[d.item_code] = flt(d.qty);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\n\t\t\tif(already_set) {\n\t\t\t\topts.source_name.forEach(function(src) {\n\t\t\t\t\tfrappe.model.with_doc(opts.source_doctype, src, function(r) {\n\t\t\t\t\t\tvar source_doc = frappe.model.get_doc(opts.source_doctype, src);\n\t\t\t\t\t\t$.each(source_doc.items || [], function(i, row) {\n\t\t\t\t\t\t\tif(row.qty > flt(item_qty_map[row.item_code])) {\n\t\t\t\t\t\t\t\talready_set = false;\n\t\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})\n\t\t\t\t\t})\n\n\t\t\t\t\tif(already_set) {\n\t\t\t\t\t\tfrappe.msgprint(__(\"You have already selected items from {0} {1}\",\n\t\t\t\t\t\t\t[opts.source_doctype, src]));\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t})\n\t\t\t}\n\t\t}\n\n\t\treturn frappe.call({\n\t\t\t// Sometimes we hit the limit for URL length of a GET request\n\t\t\t// as we send the full target_doc. Hence this is a POST request.\n\t\t\ttype: \"POST\",\n\t\t\tmethod: 'frappe.model.mapper.map_docs',\n\t\t\targs: {\n\t\t\t\t\"method\": opts.method,\n\t\t\t\t\"source_names\": opts.source_name,\n\t\t\t\t\"target_doc\": cur_frm.doc,\n\t\t\t\t\"args\": opts.args\n\t\t\t},\n\t\t\tcallback: function(r) {\n\t\t\t\tif(!r.exc) {\n\t\t\t\t\tvar doc = frappe.model.sync(r.message);\n\t\t\t\t\tcur_frm.dirty();\n\t\t\t\t\tcur_frm.refresh();\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\tlet query_args = {};\n\tif (opts.get_query_filters) {\n\t\tquery_args.filters = opts.get_query_filters;\n\t}\n\n\tif (opts.get_query_method) {\n\t\tquery_args.query = opts.get_query_method;\n\t}\n\n\tif (query_args.filters || query_args.query) {\n\t\topts.get_query = () => query_args;\n\t}\n\n\tif (opts.source_doctype) {\n\t\tvar d = new frappe.ui.form.MultiSelectDialog({\n\t\t\tdoctype: opts.source_doctype,\n\t\t\ttarget: opts.target,\n\t\t\tdate_field: opts.date_field || undefined,\n\t\t\tsetters: opts.setters,\n\t\t\tget_query: opts.get_query,\n\t\t\tadd_filters_group: 1,\n\t\t\taction: function(selections, args) {\n\t\t\t\tlet values = selections;\n\t\t\t\tif(values.length === 0){\n\t\t\t\t\tfrappe.msgprint(__(\"Please select {0}\", [opts.source_doctype]))\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\topts.source_name = values;\n\t\t\t\topts.setters = args;\n\t\t\t\td.dialog.hide();\n\t\t\t\t_map();\n\t\t\t},\n\t\t});\n\n\t\treturn d;\n\t}\n\n\tif(opts.source_name) {\n\t\topts.source_name = [opts.source_name];\n\t\t_map();\n\t}\n}\n\nfrappe.form.link_formatters['Item'] = function(value, doc) {\n\tif (doc && value && doc.item_name && doc.item_name !== value && doc.item_code === value) {\n\t\treturn value + ': ' + doc.item_name;\n\t} else if (!value && doc.doctype && doc.item_name) {\n\t\t// format blank value in child table\n\t\treturn doc.item_name;\n\t} else {\n\t\t// if value is blank in report view or item code and name are the same, return as is\n\t\treturn value;\n\t}\n}\n\nfrappe.form.link_formatters['Employee'] = function(value, doc) {\n\tif(doc && doc.employee_name && doc.employee_name !== value) {\n\t\treturn value? value + ': ' + doc.employee_name: doc.employee_name;\n\t} else {\n\t\treturn value;\n\t}\n}\n\n// add description on posting time\n$(document).on('app_ready', function() {\n\tif(!frappe.datetime.is_timezone_same()) {\n\t\t$.each([\"Stock Reconciliation\", \"Stock Entry\", \"Stock Ledger Entry\",\n\t\t\t\"Delivery Note\", \"Purchase Receipt\", \"Sales Invoice\"], function(i, d) {\n\t\t\tfrappe.ui.form.on(d, \"onload\", function(frm) {\n\t\t\t\tcur_frm.set_df_property(\"posting_time\", \"description\",\n\t\t\t\t\tfrappe.sys_defaults.time_zone);\n\t\t\t});\n\t\t});\n\t}\n});","// Copyright (c) 2015, Frappe Technologies Pvt. Ltd. and Contributors\n// License: GNU General Public License v3. See license.txt\n\n// searches for enabled users\nfrappe.provide(\"erpnext.queries\");\n$.extend(erpnext.queries, {\n\tuser: function() {\n\t\treturn { query: \"frappe.core.doctype.user.user.user_query\" };\n\t},\n\n\tlead: function() {\n\t\treturn { query: \"erpnext.controllers.queries.lead_query\" };\n\t},\n\n\tcustomer: function() {\n\t\treturn { query: \"erpnext.controllers.queries.customer_query\" };\n\t},\n\n\tsupplier: function() {\n\t\treturn { query: \"erpnext.controllers.queries.supplier_query\" };\n\t},\n\n\titem: function(filters) {\n\t\tvar args = { query: \"erpnext.controllers.queries.item_query\" };\n\t\tif(filters) args[\"filters\"] = filters;\n\t\treturn args;\n\t},\n\n\tbom: function() {\n\t\treturn { query: \"erpnext.controllers.queries.bom\" };\n\t},\n\n\ttask: function() {\n\t\treturn { query: \"erpnext.projects.utils.query_task\" };\n\t},\n\n\tcustomer_filter: function(doc) {\n\t\tif(!doc.customer) {\n\t\t\tfrappe.throw(__(\"Please set {0}\", [__(frappe.meta.get_label(doc.doctype, \"customer\", doc.name))]));\n\t\t}\n\n\t\treturn { filters: { customer: doc.customer } };\n\t},\n\n\tcontact_query: function(doc) {\n\t\tif(frappe.dynamic_link) {\n\t\t\tif(!doc[frappe.dynamic_link.fieldname]) {\n\t\t\t\tfrappe.throw(__(\"Please set {0}\",\n\t\t\t\t\t[__(frappe.meta.get_label(doc.doctype, frappe.dynamic_link.fieldname, doc.name))]));\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tquery: 'frappe.contacts.doctype.contact.contact.contact_query',\n\t\t\t\tfilters: {\n\t\t\t\t\tlink_doctype: frappe.dynamic_link.doctype,\n\t\t\t\t\tlink_name: doc[frappe.dynamic_link.fieldname]\n\t\t\t\t}\n\t\t\t};\n\t\t}\n\t},\n\n\taddress_query: function(doc) {\n\t\tif(frappe.dynamic_link) {\n\t\t\tif(!doc[frappe.dynamic_link.fieldname]) {\n\t\t\t\tfrappe.throw(__(\"Please set {0}\",\n\t\t\t\t\t[__(frappe.meta.get_label(doc.doctype, frappe.dynamic_link.fieldname, doc.name))]));\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tquery: 'frappe.contacts.doctype.address.address.address_query',\n\t\t\t\tfilters: {\n\t\t\t\t\tlink_doctype: frappe.dynamic_link.doctype,\n\t\t\t\t\tlink_name: doc[frappe.dynamic_link.fieldname]\n\t\t\t\t}\n\t\t\t};\n\t\t}\n\t},\n\n\tcompany_address_query: function(doc) {\n\t\treturn {\n\t\t\tquery: 'frappe.contacts.doctype.address.address.address_query',\n\t\t\tfilters: { is_your_company_address: 1, link_doctype: 'Company', link_name: doc.company || '' }\n\t\t};\n\t},\n\n\tsupplier_filter: function(doc) {\n\t\tif(!doc.supplier) {\n\t\t\tfrappe.throw(__(\"Please set {0}\", [__(frappe.meta.get_label(doc.doctype, \"supplier\", doc.name))]));\n\t\t}\n\n\t\treturn { filters: { supplier: doc.supplier } };\n\t},\n\n\tlead_filter: function(doc) {\n\t\tif(!doc.lead) {\n\t\t\tfrappe.throw(__(\"Please specify a {0}\",\n\t\t\t\t[__(frappe.meta.get_label(doc.doctype, \"lead\", doc.name))]));\n\t\t}\n\n\t\treturn { filters: { lead: doc.lead } };\n\t},\n\n\tnot_a_group_filter: function() {\n\t\treturn { filters: { is_group: 0 } };\n\t},\n\n\temployee: function() {\n\t\treturn { query: \"erpnext.controllers.queries.employee_query\" }\n\t},\n\n\twarehouse: function(doc) {\n\t\treturn {\n\t\t\tfilters: [\n\t\t\t\t[\"Warehouse\", \"company\", \"in\", [\"\", cstr(doc.company)]],\n\t\t\t\t[\"Warehouse\", \"is_group\", \"=\",0]\n\n\t\t\t]\n\t\t}\n\t},\n\n\tget_filtered_dimensions: function(doc, child_fields, dimension, company) {\n\t\tlet account = '';\n\n\t\tchild_fields.forEach((field) => {\n\t\t\tif (!account) {\n\t\t\t\taccount = doc[field];\n\t\t\t}\n\t\t});\n\n\t\treturn {\n\t\t\tquery: \"erpnext.controllers.queries.get_filtered_dimensions\",\n\t\t\tfilters: {\n\t\t\t\t'dimension': dimension,\n\t\t\t\t'account': account,\n\t\t\t\t'company': company\n\t\t\t}\n\t\t};\n\t}\n});\n\nerpnext.queries.setup_queries = function(frm, options, query_fn) {\n\tvar me = this;\n\tvar set_query = function(doctype, parentfield) {\n\t\tvar link_fields = frappe.meta.get_docfields(doctype, frm.doc.name,\n\t\t\t{\"fieldtype\": \"Link\", \"options\": options});\n\t\t$.each(link_fields, function(i, df) {\n\t\t\tif(parentfield) {\n\t\t\t\tfrm.set_query(df.fieldname, parentfield, query_fn);\n\t\t\t} else {\n\t\t\t\tfrm.set_query(df.fieldname, query_fn);\n\t\t\t}\n\t\t});\n\t};\n\n\tset_query(frm.doc.doctype);\n\n\t// warehouse field in tables\n\t$.each(frappe.meta.get_docfields(frm.doc.doctype, frm.doc.name, {\"fieldtype\": \"Table\"}),\n\t\tfunction(i, df) {\n\t\t\tset_query(df.options, df.fieldname);\n\t\t});\n}\n\n/* \tif item code is selected in child table\n\tthen list down warehouses with its quantity\n\telse apply default filters.\n*/\nerpnext.queries.setup_warehouse_query = function(frm){\n\tfrm.set_query('warehouse', 'items', function(doc, cdt, cdn) {\n\t\tvar row  = locals[cdt][cdn];\n\t\tvar filters = erpnext.queries.warehouse(frm.doc);\n\t\tif(row.item_code){\n\t\t\t$.extend(filters, {\"query\":\"erpnext.controllers.queries.warehouse_query\"});\n\t\t\tfilters[\"filters\"].push([\"Bin\", \"item_code\", \"=\", row.item_code]);\n\t\t}\n\t\treturn filters\n\t});\n}\n","// Copyright (c) 2015, Frappe Technologies Pvt. Ltd. and Contributors\n// License: GNU General Public License v3. See license.txt\n\nerpnext.SMSManager = function SMSManager(doc) {\n\tvar me = this;\n\tthis.setup = function() {\n\t\tvar default_msg = {\n\t\t\t'Lead'\t\t\t\t: '',\n\t\t\t'Opportunity'\t\t\t: 'Your enquiry has been logged into the system. Ref No: ' + doc.name,\n\t\t\t'Quotation'\t\t\t: 'Quotation ' + doc.name + ' has been sent via email. Thanks!',\n\t\t\t'Sales Order'\t\t: 'Sales Order ' + doc.name + ' has been created against '\n\t\t\t\t\t\t+ (doc.quotation_no ? ('Quote No:' + doc.quotation_no) : '')\n\t\t\t\t\t\t+ (doc.po_no ? (' for your PO: ' + doc.po_no) : ''),\n\t\t\t'Delivery Note'\t\t: 'Items has been delivered against delivery note: ' + doc.name\n\t\t\t\t\t\t+ (doc.po_no ? (' for your PO: ' + doc.po_no) : ''),\n\t\t\t'Sales Invoice': 'Invoice ' + doc.name + ' has been sent via email '\n\t\t\t\t\t\t+ (doc.po_no ? (' for your PO: ' + doc.po_no) : ''),\n\t\t\t'Material Request'\t\t\t: 'Material Request ' + doc.name + ' has been raised in the system',\n\t\t\t'Purchase Order'\t: 'Purchase Order ' + doc.name + ' has been sent via email',\n\t\t\t'Purchase Receipt'\t: 'Items has been received against purchase receipt: ' + doc.name\n\t\t}\n\n\t\tif (in_list(['Sales Order', 'Delivery Note', 'Sales Invoice'], doc.doctype))\n\t\t\tthis.show(doc.contact_person, 'Customer', doc.customer, '', default_msg[doc.doctype]);\n\t\telse if (doc.doctype === 'Quotation')\n\t\t\tthis.show(doc.contact_person, 'Customer', doc.party_name, '', default_msg[doc.doctype]);\n\t\telse if (in_list(['Purchase Order', 'Purchase Receipt'], doc.doctype))\n\t\t\tthis.show(doc.contact_person, 'Supplier', doc.supplier, '', default_msg[doc.doctype]);\n\t\telse if (doc.doctype == 'Lead')\n\t\t\tthis.show('', '', '', doc.mobile_no, default_msg[doc.doctype]);\n\t\telse if (doc.doctype == 'Opportunity')\n\t\t\tthis.show('', '', '', doc.contact_no, default_msg[doc.doctype]);\n\t\telse if (doc.doctype == 'Material Request')\n\t\t\tthis.show('', '', '', '', default_msg[doc.doctype]);\n\n\t};\n\n\tthis.get_contact_number = function(contact, ref_doctype, ref_name) {\n\t\tfrappe.call({\n\t\t\tmethod: \"frappe.core.doctype.sms_settings.sms_settings.get_contact_number\",\n\t\t\targs: {\n\t\t\t\tcontact_name: contact,\n\t\t\t\tref_doctype: ref_doctype,\n\t\t\t\tref_name: ref_name\n\t\t\t},\n\t\t\tcallback: function(r) {\n\t\t\t\tif(r.exc) { frappe.msgprint(r.exc); return; }\n\t\t\t\tme.number = r.message;\n\t\t\t\tme.show_dialog();\n\t\t\t}\n\t\t});\n\t};\n\n\tthis.show = function(contact, ref_doctype, ref_name, mobile_nos, message) {\n\t\tthis.message = message;\n\t\tif (mobile_nos) {\n\t\t\tme.number = mobile_nos;\n\t\t\tme.show_dialog();\n\t\t} else if (contact){\n\t\t\tthis.get_contact_number(contact, ref_doctype, ref_name)\n\t\t} else {\n\t\t\tme.show_dialog();\n\t\t}\n\t}\n\tthis.show_dialog = function() {\n\t\tif(!me.dialog)\n\t\t\tme.make_dialog();\n\t\tme.dialog.set_values({\n\t\t\t'message': me.message,\n\t\t\t'number': me.number\n\t\t})\n\t\tme.dialog.show();\n\t}\n\tthis.make_dialog = function() {\n\t\tvar d = new frappe.ui.Dialog({\n\t\t\ttitle: 'Send SMS',\n\t\t\twidth: 400,\n\t\t\tfields: [\n\t\t\t\t{fieldname:'number', fieldtype:'Data', label:'Mobile Number', reqd:1},\n\t\t\t\t{fieldname:'message', fieldtype:'Text', label:'Message', reqd:1},\n\t\t\t\t{fieldname:'send', fieldtype:'Button', label:'Send'}\n\t\t\t]\n\t\t})\n\t\td.fields_dict.send.input.onclick = function() {\n\t\t\tvar btn = d.fields_dict.send.input;\n\t\t\tvar v = me.dialog.get_values();\n\t\t\tif(v) {\n\t\t\t\t$(btn).set_working();\n\t\t\t\tfrappe.call({\n\t\t\t\t\tmethod: \"frappe.core.doctype.sms_settings.sms_settings.send_sms\",\n\t\t\t\t\targs: {\n\t\t\t\t\t\treceiver_list: [v.number],\n\t\t\t\t\t\tmsg: v.message\n\t\t\t\t\t},\n\t\t\t\t\tcallback: function(r) {\n\t\t\t\t\t\t$(btn).done_working();\n\t\t\t\t\t\tif(r.exc) {frappe.msgprint(r.exc); return; }\n\t\t\t\t\t\tme.dialog.hide();\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t\tthis.dialog = d;\n\t}\n\tthis.setup();\n}\n","// Copyright (c) 2015, Frappe Technologies Pvt. Ltd. and Contributors\n// License: GNU General Public License v3. See license.txt\n\nfrappe.provide(\"erpnext.utils\");\n\nerpnext.utils.get_party_details = function(frm, method, args, callback) {\n\tif (!method) {\n\t\tmethod = \"erpnext.accounts.party.get_party_details\";\n\t}\n\n\tif (args) {\n\t\tif (in_list(['Sales Invoice', 'Sales Order', 'Delivery Note'], frm.doc.doctype)) {\n\t\t\tif (frm.doc.company_address && (!args.company_address)) {\n\t\t\t\targs.company_address = frm.doc.company_address;\n\t\t\t}\n\t\t}\n\n\t\tif (in_list(['Purchase Invoice', 'Purchase Order', 'Purchase Receipt'], frm.doc.doctype)) {\n\t\t\tif (frm.doc.shipping_address && (!args.shipping_address)) {\n\t\t\t\targs.shipping_address = frm.doc.shipping_address;\n\t\t\t}\n\t\t}\n\t}\n\n\tif (!args) {\n\t\tif ((frm.doctype != \"Purchase Order\" && frm.doc.customer)\n\t\t\t|| (frm.doc.party_name && in_list(['Quotation', 'Opportunity'], frm.doc.doctype))) {\n\n\t\t\tlet party_type = \"Customer\";\n\t\t\tif (frm.doc.quotation_to && frm.doc.quotation_to === \"Lead\") {\n\t\t\t\tparty_type = \"Lead\";\n\t\t\t}\n\n\t\t\targs = {\n\t\t\t\tparty: frm.doc.customer || frm.doc.party_name,\n\t\t\t\tparty_type: party_type,\n\t\t\t\tprice_list: frm.doc.selling_price_list\n\t\t\t};\n\t\t} else if (frm.doc.supplier) {\n\t\t\targs = {\n\t\t\t\tparty: frm.doc.supplier,\n\t\t\t\tparty_type: \"Supplier\",\n\t\t\t\tbill_date: frm.doc.bill_date,\n\t\t\t\tprice_list: frm.doc.buying_price_list\n\t\t\t};\n\t\t}\n\n\t\tif (in_list(['Sales Invoice', 'Sales Order', 'Delivery Note'], frm.doc.doctype)) {\n\t\t\tif (!args) {\n\t\t\t\targs = {\n\t\t\t\t\tparty: frm.doc.customer || frm.doc.party_name,\n\t\t\t\t\tparty_type: 'Customer'\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (frm.doc.company_address && (!args.company_address)) {\n\t\t\t\targs.company_address = frm.doc.company_address;\n\t\t\t}\n\n\t\t\tif (frm.doc.shipping_address_name &&(!args.shipping_address_name)) {\n\t\t\t\targs.shipping_address_name = frm.doc.shipping_address_name;\n\t\t\t}\n\t\t}\n\n\t\tif (in_list(['Purchase Invoice', 'Purchase Order', 'Purchase Receipt'], frm.doc.doctype)) {\n\t\t\tif (!args) {\n\t\t\t\targs = {\n\t\t\t\t\tparty: frm.doc.supplier,\n\t\t\t\t\tparty_type: 'Supplier'\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (frm.doc.shipping_address && (!args.shipping_address)) {\n\t\t\t\targs.shipping_address = frm.doc.shipping_address;\n\t\t\t}\n\t\t}\n\n\t\tif (args) {\n\t\t\targs.posting_date = frm.doc.posting_date || frm.doc.transaction_date;\n\t\t}\n\t}\n\tif (!args || !args.party) return;\n\n\tif (frappe.meta.get_docfield(frm.doc.doctype, \"taxes\")) {\n\t\tif (!erpnext.utils.validate_mandatory(frm, \"Posting / Transaction Date\",\n\t\t\targs.posting_date, args.party_type==\"Customer\" ? \"customer\": \"supplier\")) return;\n\t}\n\n\tif (!erpnext.utils.validate_mandatory(frm, \"Company\", frm.doc.company, args.party_type==\"Customer\" ? \"customer\": \"supplier\")) {\n\t\treturn;\n\t}\n\n\targs.currency = frm.doc.currency;\n\targs.company = frm.doc.company;\n\targs.doctype = frm.doc.doctype;\n\tfrappe.call({\n\t\tmethod: method,\n\t\targs: args,\n\t\tcallback: function(r) {\n\t\t\tif (r.message) {\n\t\t\t\tfrm.supplier_tds = r.message.supplier_tds;\n\t\t\t\tfrm.updating_party_details = true;\n\t\t\t\tfrappe.run_serially([\n\t\t\t\t\t() => frm.set_value(r.message),\n\t\t\t\t\t() => {\n\t\t\t\t\t\tfrm.updating_party_details = false;\n\t\t\t\t\t\tif (callback) callback();\n\t\t\t\t\t\tfrm.refresh();\n\t\t\t\t\t\terpnext.utils.add_item(frm);\n\t\t\t\t\t}\n\t\t\t\t]);\n\t\t\t}\n\t\t}\n\t});\n}\n\nerpnext.utils.add_item = function(frm) {\n\tif (frm.is_new()) {\n\t\tvar prev_route = frappe.get_prev_route();\n\t\tif (prev_route[1]==='Item' && !(frm.doc.items && frm.doc.items.length)) {\n\t\t\t// add row\n\t\t\tvar item = frm.add_child('items');\n\t\t\tfrm.refresh_field('items');\n\n\t\t\t// set item\n\t\t\tfrappe.model.set_value(item.doctype, item.name, 'item_code', prev_route[2]);\n\t\t}\n\t}\n}\n\nerpnext.utils.get_address_display = function(frm, address_field, display_field, is_your_company_address) {\n\tif (frm.updating_party_details) return;\n\n\tif (!address_field) {\n\t\tif (frm.doctype != \"Purchase Order\" && frm.doc.customer) {\n\t\t\taddress_field = \"customer_address\";\n\t\t} else if (frm.doc.supplier) {\n\t\t\taddress_field = \"supplier_address\";\n\t\t} else return;\n\t}\n\n\tif (!display_field) display_field = \"address_display\";\n\tif (frm.doc[address_field]) {\n\t\tfrappe.call({\n\t\t\tmethod: \"frappe.contacts.doctype.address.address.get_address_display\",\n\t\t\targs: {\"address_dict\": frm.doc[address_field] },\n\t\t\tcallback: function(r) {\n\t\t\t\tif (r.message) {\n\t\t\t\t\tfrm.set_value(display_field, r.message)\n\t\t\t\t}\n\t\t\t}\n\t\t})\n\t} else {\n\t\tfrm.set_value(display_field, '');\n\t}\n};\n\nerpnext.utils.set_taxes_from_address = function(frm, triggered_from_field, billing_address_field, shipping_address_field) {\n\tif (frm.updating_party_details) return;\n\n\tif (frappe.meta.get_docfield(frm.doc.doctype, \"taxes\")) {\n\t\tif (!erpnext.utils.validate_mandatory(frm, \"Lead / Customer / Supplier\",\n\t\t\tfrm.doc.customer || frm.doc.supplier || frm.doc.lead || frm.doc.party_name, triggered_from_field)) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (!erpnext.utils.validate_mandatory(frm, \"Posting / Transaction Date\",\n\t\t\tfrm.doc.posting_date || frm.doc.transaction_date, triggered_from_field)) {\n\t\t\treturn;\n\t\t}\n\t} else {\n\t\treturn;\n\t}\n\n\tfrappe.call({\n\t\tmethod: \"erpnext.accounts.party.get_address_tax_category\",\n\t\targs: {\n\t\t\t\"tax_category\": frm.doc.tax_category,\n\t\t\t\"billing_address\": frm.doc[billing_address_field],\n\t\t\t\"shipping_address\": frm.doc[shipping_address_field]\n\t\t},\n\t\tcallback: function(r) {\n\t\t\tif (!r.exc){\n\t\t\t\tif (frm.doc.tax_category != r.message) {\n\t\t\t\t\tfrm.set_value(\"tax_category\", r.message);\n\t\t\t\t} else {\n\t\t\t\t\terpnext.utils.set_taxes(frm, triggered_from_field);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t});\n};\n\nerpnext.utils.set_taxes = function(frm, triggered_from_field) {\n\tif (frappe.meta.get_docfield(frm.doc.doctype, \"taxes\")) {\n\t\tif (!erpnext.utils.validate_mandatory(frm, \"Company\", frm.doc.company, triggered_from_field)) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (!erpnext.utils.validate_mandatory(frm, \"Lead / Customer / Supplier\",\n\t\t\tfrm.doc.customer || frm.doc.supplier || frm.doc.lead || frm.doc.party_name, triggered_from_field)) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (!erpnext.utils.validate_mandatory(frm, \"Posting / Transaction Date\",\n\t\t\tfrm.doc.posting_date || frm.doc.transaction_date, triggered_from_field)) {\n\t\t\treturn;\n\t\t}\n\t} else {\n\t\treturn;\n\t}\n\n\tvar party_type, party;\n\tif (frm.doc.lead) {\n\t\tparty_type = 'Lead';\n\t\tparty = frm.doc.lead;\n\t} else if (frm.doc.customer) {\n\t\tparty_type = 'Customer';\n\t\tparty = frm.doc.customer;\n\t} else if (frm.doc.supplier) {\n\t\tparty_type = 'Supplier';\n\t\tparty = frm.doc.supplier;\n\t} else if (frm.doc.quotation_to){\n\t\tparty_type = frm.doc.quotation_to;\n\t\tparty = frm.doc.party_name;\n\t}\n\n\tif (!frm.doc.company) {\n\t\tfrappe.throw(__(\"Please select the company first\"));\n\t}\n\n\tfrappe.call({\n\t\tmethod: \"erpnext.accounts.party.set_taxes\",\n\t\targs: {\n\t\t\t\"party\": party,\n\t\t\t\"party_type\": party_type,\n\t\t\t\"posting_date\": frm.doc.posting_date || frm.doc.transaction_date,\n\t\t\t\"company\": frm.doc.company,\n\t\t\t\"customer_group\": frm.doc.customer_group,\n\t\t\t\"supplier_group\": frm.doc.supplier_group,\n\t\t\t\"tax_category\": frm.doc.tax_category,\n\t\t\t\"billing_address\": ((frm.doc.customer || frm.doc.lead) ? (frm.doc.customer_address) : (frm.doc.supplier_address)),\n\t\t\t\"shipping_address\": frm.doc.shipping_address_name\n\t\t},\n\t\tcallback: function(r) {\n\t\t\tif (r.message){\n\t\t\t\tfrm.set_value(\"taxes_and_charges\", r.message)\n\t\t\t}\n\t\t}\n\t});\n};\n\nerpnext.utils.get_contact_details = function(frm) {\n\tif (frm.updating_party_details) return;\n\n\tif (frm.doc[\"contact_person\"]) {\n\t\tfrappe.call({\n\t\t\tmethod: \"frappe.contacts.doctype.contact.contact.get_contact_details\",\n\t\t\targs: {contact: frm.doc.contact_person },\n\t\t\tcallback: function(r) {\n\t\t\t\tif (r.message)\n\t\t\t\t\tfrm.set_value(r.message);\n\t\t\t}\n\t\t})\n\t}\n}\n\nerpnext.utils.validate_mandatory = function(frm, label, value, trigger_on) {\n\tif (!value) {\n\t\tfrm.doc[trigger_on] = \"\";\n\t\trefresh_field(trigger_on);\n\t\tfrappe.throw({message:__(\"Please enter {0} first\", [label]), title:__(\"Mandatory\")});\n\t\treturn false;\n\t}\n\treturn true;\n}\n\nerpnext.utils.get_shipping_address = function(frm, callback){\n\tif (frm.doc.company) {\n\t\tif (!(frm.doc.inter_com_order_reference || frm.doc.internal_invoice_reference ||\n\t\t\tfrm.doc.internal_order_reference)) {\n\t\t\tif (callback) {\n\t\t\t\treturn callback();\n\t\t\t}\n\t\t}\n\t\tfrappe.call({\n\t\t\tmethod: \"erpnext.accounts.custom.address.get_shipping_address\",\n\t\t\targs: {\n\t\t\t\tcompany: frm.doc.company,\n\t\t\t\taddress: frm.doc.shipping_address\n\t\t\t},\n\t\t\tcallback: function(r){\n\t\t\t\tif (r.message){\n\t\t\t\t\tfrm.set_value(\"shipping_address\", r.message[0]) //Address title or name\n\t\t\t\t\tfrm.set_value(\"shipping_address_display\", r.message[1]) //Address to be displayed on the page\n\t\t\t\t}\n\n\t\t\t\tif (callback){\n\t\t\t\t\treturn callback();\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t} else {\n\t\tfrappe.msgprint(__(\"Select company first\"));\n\t}\n}","// Copyright (c) 2015, Frappe Technologies Pvt. Ltd. and Contributors\n// License: GNU General Public License v3. See license.txt\n\nfrappe.provide(\"erpnext.stock\");\n\nerpnext.stock.StockController = frappe.ui.form.Controller.extend({\n\tonload: function() {\n\t\t// warehouse query if company\n\t\tif (this.frm.fields_dict.company) {\n\t\t\tthis.setup_warehouse_query();\n\t\t}\n\t},\n\n\tsetup_warehouse_query: function() {\n\t\tvar me = this;\n\t\terpnext.queries.setup_queries(this.frm, \"Warehouse\", function() {\n\t\t\treturn erpnext.queries.warehouse(me.frm.doc);\n\t\t});\n\t},\n\n\tsetup_posting_date_time_check: function() {\n\t\t// make posting date default and read only unless explictly checked\n\t\tfrappe.ui.form.on(this.frm.doctype, 'set_posting_date_and_time_read_only', function(frm) {\n\t\t\tif(frm.doc.docstatus == 0 && frm.doc.set_posting_time) {\n\t\t\t\tfrm.set_df_property('posting_date', 'read_only', 0);\n\t\t\t\tfrm.set_df_property('posting_time', 'read_only', 0);\n\t\t\t} else {\n\t\t\t\tfrm.set_df_property('posting_date', 'read_only', 1);\n\t\t\t\tfrm.set_df_property('posting_time', 'read_only', 1);\n\t\t\t}\n\t\t})\n\n\t\tfrappe.ui.form.on(this.frm.doctype, 'set_posting_time', function(frm) {\n\t\t\tfrm.trigger('set_posting_date_and_time_read_only');\n\t\t});\n\n\t\tfrappe.ui.form.on(this.frm.doctype, 'refresh', function(frm) {\n\t\t\t// set default posting date / time\n\t\t\tif(frm.doc.docstatus==0) {\n\t\t\t\tif(!frm.doc.posting_date) {\n\t\t\t\t\tfrm.set_value('posting_date', frappe.datetime.nowdate());\n\t\t\t\t}\n\t\t\t\tif(!frm.doc.posting_time) {\n\t\t\t\t\tfrm.set_value('posting_time', frappe.datetime.now_time());\n\t\t\t\t}\n\t\t\t\tfrm.trigger('set_posting_date_and_time_read_only');\n\t\t\t}\n\t\t});\n\t},\n\n\tshow_stock_ledger: function() {\n\t\tvar me = this;\n\t\tif(this.frm.doc.docstatus > 0) {\n\t\t\tcur_frm.add_custom_button(__(\"Stock Ledger\"), function() {\n\t\t\t\tfrappe.route_options = {\n\t\t\t\t\tvoucher_no: me.frm.doc.name,\n\t\t\t\t\tfrom_date: me.frm.doc.posting_date,\n\t\t\t\t\tto_date: moment(me.frm.doc.modified).format('YYYY-MM-DD'),\n\t\t\t\t\tcompany: me.frm.doc.company,\n\t\t\t\t\tshow_cancelled_entries: me.frm.doc.docstatus === 2\n\t\t\t\t};\n\t\t\t\tfrappe.set_route(\"query-report\", \"Stock Ledger\");\n\t\t\t}, __(\"View\"));\n\t\t}\n\n\t},\n\n\tshow_general_ledger: function() {\n\t\tvar me = this;\n\t\tif(this.frm.doc.docstatus > 0) {\n\t\t\tcur_frm.add_custom_button(__('Accounting Ledger'), function() {\n\t\t\t\tfrappe.route_options = {\n\t\t\t\t\tvoucher_no: me.frm.doc.name,\n\t\t\t\t\tfrom_date: me.frm.doc.posting_date,\n\t\t\t\t\tto_date: moment(me.frm.doc.modified).format('YYYY-MM-DD'),\n\t\t\t\t\tcompany: me.frm.doc.company,\n\t\t\t\t\tgroup_by: \"Group by Voucher (Consolidated)\",\n\t\t\t\t\tshow_cancelled_entries: me.frm.doc.docstatus === 2\n\t\t\t\t};\n\t\t\t\tfrappe.set_route(\"query-report\", \"General Ledger\");\n\t\t\t}, __(\"View\"));\n\t\t}\n\t}\n});\n","// Copyright (c) 2015, Frappe Technologies Pvt. Ltd. and Contributors\n// License: GNU General Public License v3. See license.txt\n\nerpnext.payments = erpnext.stock.StockController.extend({\n\tmake_payment: function() {\n\t\tvar me = this;\n\n\t\tthis.dialog = new frappe.ui.Dialog({\n\t\t\ttitle: 'Payment'\n\t\t});\n\n\t\tthis.dialog.show();\n\t\tthis.$body = this.dialog.body;\n\t\tthis.set_payment_primary_action();\n\t\tthis.make_keyboard();\n\t\tthis.select_text()\n\t},\n\n\tselect_text: function(){\n\t\tvar me = this;\n\t\t$(this.$body).find('.form-control').click(function(){\n\t\t\t$(this).select();\n\t\t})\n\t},\n\n\tset_payment_primary_action: function(){\n\t\tvar me = this;\n\n\t\tthis.dialog.set_primary_action(__(\"Submit\"), function() {\n\t\t\t// Allow no ZERO payment\n\t\t\t$.each(me.frm.doc.payments, function (index, data) {\n\t\t\t\tif (data.amount != 0) {\n\t\t\t\t\tme.dialog.hide();\n\t\t\t\t\tme.submit_invoice();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t});\n\t\t})\n\t},\n\n\tmake_keyboard: function(){\n\t\tvar me = this;\n\t\t$(this.$body).empty();\n\t\t$(this.$body).html(frappe.render_template('pos_payment', this.frm.doc))\n\t\tthis.show_payment_details();\n\t\tthis.bind_keyboard_event()\n\t\tthis.clear_amount()\n\t},\n\n\tmake_multimode_payment: function(){\n\t\tvar me = this;\n\n\t\tif(this.frm.doc.change_amount > 0){\n\t\t\tme.payment_val = me.doc.outstanding_amount\n\t\t}\n\n\t\tthis.payments = frappe.model.add_child(this.frm.doc, 'Multi Mode Payment', \"payments\");\n\t\tthis.payments.mode_of_payment = this.dialog.fields_dict.mode_of_payment.get_value();\n\t\tthis.payments.amount = flt(this.payment_val);\n\t},\n\n\tshow_payment_details: function(){\n\t\tvar me = this;\n\t\tvar multimode_payments = $(this.$body).find('.multimode-payments').empty();\n\t\tif(this.frm.doc.payments.length){\n\t\t\t$.each(this.frm.doc.payments, function(index, data){\n\t\t\t\t$(frappe.render_template('payment_details', {\n\t\t\t\t\tmode_of_payment: data.mode_of_payment,\n\t\t\t\t\tamount: data.amount,\n\t\t\t\t\tidx: data.idx,\n\t\t\t\t\tcurrency: me.frm.doc.currency,\n\t\t\t\t\ttype: data.type\n\t\t\t\t})).appendTo(multimode_payments)\n\n\t\t\t\tif (data.type == 'Cash' && data.amount == me.frm.doc.paid_amount) {\n\t\t\t\t\tme.idx = data.idx;\n\t\t\t\t\tme.selected_mode = $(me.$body).find(repl(\"input[idx='%(idx)s']\",{'idx': me.idx}));\n\t\t\t\t\tme.highlight_selected_row();\n\t\t\t\t\tme.bind_amount_change_event();\n\t\t\t\t}\n\t\t\t})\n\t\t}else{\n\t\t\t$(\"<p>No payment mode selected in pos profile</p>\").appendTo(multimode_payments)\n\t\t}\n\t},\n\n\tset_outstanding_amount: function(){\n\t\tthis.selected_mode = $(this.$body).find(repl(\"input[idx='%(idx)s']\",{'idx': this.idx}));\n\t\tthis.highlight_selected_row()\n\t\tthis.payment_val = 0.0\n\t\tif(this.frm.doc.outstanding_amount > 0 && flt(this.selected_mode.val()) == 0.0){\n\t\t\t//When user first time click on row\n\t\t\tthis.payment_val = flt(this.frm.doc.outstanding_amount / this.frm.doc.conversion_rate, precision(\"outstanding_amount\"))\n\t\t\tthis.selected_mode.val(format_currency(this.payment_val, this.frm.doc.currency));\n\t\t\tthis.update_payment_amount()\n\t\t}else if(flt(this.selected_mode.val()) > 0){\n\t\t\t//If user click on existing row which has value\n\t\t\tthis.payment_val = flt(this.selected_mode.val());\n\t\t}\n\t\tthis.selected_mode.select()\n\t\tthis.bind_amount_change_event();\n\t},\n\n\tbind_keyboard_event: function(){\n\t\tvar me = this;\n\t\tthis.payment_val = '';\n\t\tthis.bind_form_control_event();\n\t\tthis.bind_numeric_keys_event();\n\t},\n\n\tbind_form_control_event: function(){\n\t\tvar me = this;\n\t\t$(this.$body).find('.pos-payment-row').click(function(){\n\t\t\tme.idx = $(this).attr(\"idx\");\n\t\t\tme.set_outstanding_amount()\n\t\t})\n\n\t\t$(this.$body).find('.form-control').click(function(){\n\t\t\tme.idx = $(this).attr(\"idx\");\n\t\t\tme.set_outstanding_amount();\n\t\t\tme.update_paid_amount(true);\n\t\t})\n\n\t\t$(this.$body).find('.write_off_amount').change(function(){\n\t\t\tme.write_off_amount(flt($(this).val()), precision(\"write_off_amount\"));\n\t\t})\n\n\t\t$(this.$body).find('.change_amount').change(function(){\n\t\t\tme.change_amount(flt($(this).val()), precision(\"change_amount\"));\n\t\t})\n\t},\n\n\thighlight_selected_row: function(){\n\t\tvar me = this;\n\t\tvar selected_row = $(this.$body).find(repl(\".pos-payment-row[idx='%(idx)s']\",{'idx': this.idx}));\n\t\t$(this.$body).find('.pos-payment-row').removeClass('selected-payment-mode')\n\t\tselected_row.addClass('selected-payment-mode')\n\t\t$(this.$body).find('.amount').attr('disabled', true);\n\t\tthis.selected_mode.attr('disabled', false);\n\t},\n\n\tbind_numeric_keys_event: function(){\n\t\tvar me = this;\n\t\t$(this.$body).find('.pos-keyboard-key').click(function(){\n\t\t\tme.payment_val += $(this).text();\n\t\t\tme.selected_mode.val(format_currency(me.payment_val, me.frm.doc.currency))\n\t\t\tme.idx = me.selected_mode.attr(\"idx\")\n\t\t\tme.update_paid_amount()\n\t\t})\n\n\t\t$(this.$body).find('.delete-btn').click(function(){\n\t\t\tme.payment_val =  cstr(flt(me.selected_mode.val())).slice(0, -1);\n\t\t\tme.selected_mode.val(format_currency(me.payment_val, me.frm.doc.currency));\n\t\t\tme.idx = me.selected_mode.attr(\"idx\")\n\t\t\tme.update_paid_amount();\n\t\t})\n\n\t},\n\n\tbind_amount_change_event: function(){\n\t\tvar me = this;\n\t\tthis.selected_mode.change(function(){\n\t\t\tme.payment_val =  flt($(this).val()) || 0.0;\n\t\t\tme.selected_mode.val(format_currency(me.payment_val, me.frm.doc.currency))\n\t\t\tme.idx = me.selected_mode.attr(\"idx\")\n\t\t\tme.update_payment_amount()\n\t\t})\n\t},\n\n\tclear_amount: function() {\n\t\tvar me = this;\n\t\t$(this.$body).find('.clr').click(function(e){\n\t\t\te.stopPropagation();\n\t\t\tme.idx = $(this).attr(\"idx\");\n\t\t\tme.selected_mode = $(me.$body).find(repl(\"input[idx='%(idx)s']\",{'idx': me.idx}));\n\t\t\tme.payment_val = 0.0;\n\t\t\tme.selected_mode.val(0.0);\n\t\t\tme.highlight_selected_row();\n\t\t\tme.update_payment_amount();\n\t\t})\n\t},\n\n\twrite_off_amount: function(write_off_amount) {\n\t\tvar me = this;\n\n\t\tthis.frm.doc.write_off_amount = flt(write_off_amount, precision(\"write_off_amount\"));\n\t\tthis.frm.doc.base_write_off_amount = flt(this.frm.doc.write_off_amount * this.frm.doc.conversion_rate,\n\t\t\tprecision(\"base_write_off_amount\"));\n\t\tthis.calculate_outstanding_amount(false)\n\t\tthis.show_amounts()\n\t},\n\n\tchange_amount: function(change_amount) {\n\t\tvar me = this;\n\n\t\tthis.frm.doc.change_amount = flt(change_amount, precision(\"change_amount\"));\n\t\tthis.calculate_write_off_amount()\n\t\tthis.show_amounts()\n\t},\n\n\tupdate_paid_amount: function(update_write_off) {\n\t\tvar me = this;\n\t\tif(in_list(['change_amount', 'write_off_amount'], this.idx)){\n\t\t\tvar value = me.selected_mode.val();\n\t\t\tif(me.idx == 'change_amount'){\n\t\t\t\tme.change_amount(value)\n\t\t\t} else{\n\t\t\t\tif(flt(value) == 0 && update_write_off && me.frm.doc.outstanding_amount > 0) {\n\t\t\t\t\tvalue = flt(me.frm.doc.outstanding_amount / me.frm.doc.conversion_rate, precision(me.idx));\n\t\t\t\t}\n\t\t\t\tme.write_off_amount(value)\n\t\t\t}\n\t\t}else{\n\t\t\tthis.update_payment_amount()\n\t\t}\n\t},\n\n\tupdate_payment_amount: function(){\n\t\tvar me = this;\n\n\t\t$.each(this.frm.doc.payments, function(index, data){\n\t\t\tif(cint(me.idx) == cint(data.idx)){\n\t\t\t\tdata.amount = flt(me.selected_mode.val(), 2)\n\t\t\t}\n\t\t})\n\n\t\tthis.calculate_outstanding_amount(false);\n\t\tthis.show_amounts();\n\t},\n\n\tshow_amounts: function(){\n\t\tvar me = this;\n\t\t$(this.$body).find(\".write_off_amount\").val(format_currency(this.frm.doc.write_off_amount, this.frm.doc.currency));\n\t\t$(this.$body).find('.paid_amount').text(format_currency(this.frm.doc.paid_amount, this.frm.doc.currency));\n\t\t$(this.$body).find('.change_amount').val(format_currency(this.frm.doc.change_amount, this.frm.doc.currency))\n\t\t$(this.$body).find('.outstanding_amount').text(format_currency(this.frm.doc.outstanding_amount, frappe.get_doc(\":Company\", this.frm.doc.company).default_currency))\n\t\tthis.update_invoice();\n\t}\n})","// Copyright (c) 2015, Frappe Technologies Pvt. Ltd. and Contributors\n// License: GNU General Public License v3. See license.txt\n\nerpnext.taxes_and_totals = erpnext.payments.extend({\n\tsetup: function() {\n\t\tthis.fetch_round_off_accounts();\n\t},\n\n\tapply_pricing_rule_on_item: function(item) {\n\t\tlet effective_item_rate = item.price_list_rate;\n\t\tlet item_rate = item.rate;\n\t\tif (in_list([\"Sales Order\", \"Quotation\"], item.parenttype) && item.blanket_order_rate) {\n\t\t\teffective_item_rate = item.blanket_order_rate;\n\t\t}\n\t\tif(item.margin_type == \"Percentage\"){\n\t\t\titem.rate_with_margin = flt(effective_item_rate)\n\t\t\t\t+ flt(effective_item_rate) * ( flt(item.margin_rate_or_amount) / 100);\n\t\t} else {\n\t\t\titem.rate_with_margin = flt(effective_item_rate) + flt(item.margin_rate_or_amount);\n\t\t}\n\t\titem.base_rate_with_margin = flt(item.rate_with_margin) * flt(this.frm.doc.conversion_rate);\n\n\t\titem_rate = flt(item.rate_with_margin , precision(\"rate\", item));\n\n\t\tif(item.discount_percentage){\n\t\t\titem.discount_amount = flt(item.rate_with_margin) * flt(item.discount_percentage) / 100;\n\t\t}\n\n\t\tif (item.discount_amount) {\n\t\t\titem_rate = flt((item.rate_with_margin) - (item.discount_amount), precision('rate', item));\n\t\t\titem.discount_percentage = 100 * flt(item.discount_amount) / flt(item.rate_with_margin);\n\t\t}\n\n\t\tfrappe.model.set_value(item.doctype, item.name, \"rate\", item_rate);\n\t},\n\n\tcalculate_taxes_and_totals: function(update_paid_amount) {\n\t\tthis.discount_amount_applied = false;\n\t\tthis._calculate_taxes_and_totals();\n\t\tthis.calculate_discount_amount();\n\n\t\t// Advance calculation applicable to Sales /Purchase Invoice\n\t\tif(in_list([\"Sales Invoice\", \"POS Invoice\", \"Purchase Invoice\"], this.frm.doc.doctype)\n\t\t\t&& this.frm.doc.docstatus < 2 && !this.frm.doc.is_return) {\n\t\t\tthis.calculate_total_advance(update_paid_amount);\n\t\t}\n\n\t\tif (in_list([\"Sales Invoice\", \"POS Invoice\"], this.frm.doc.doctype) && this.frm.doc.is_pos &&\n\t\t\tthis.frm.doc.is_return) {\n\t\t\tthis.update_paid_amount_for_return();\n\t\t}\n\n\t\t// Sales person's commission\n\t\tif(in_list([\"Quotation\", \"Sales Order\", \"Delivery Note\", \"Sales Invoice\", \"POS Invoice\"], this.frm.doc.doctype)) {\n\t\t\tthis.calculate_commission();\n\t\t\tthis.calculate_contribution();\n\t\t}\n\n\t\t// Update paid amount on return/debit note creation\n\t\tif(this.frm.doc.doctype === \"Purchase Invoice\" && this.frm.doc.is_return\n\t\t\t&& (this.frm.doc.grand_total > this.frm.doc.paid_amount)) {\n\t\t\tthis.frm.doc.paid_amount = flt(this.frm.doc.grand_total, precision(\"grand_total\"));\n\t\t}\n\n\t\tthis.frm.refresh_fields();\n\t},\n\n\tcalculate_discount_amount: function(){\n\t\tif (frappe.meta.get_docfield(this.frm.doc.doctype, \"discount_amount\")) {\n\t\t\tthis.set_discount_amount();\n\t\t\tthis.apply_discount_amount();\n\t\t}\n\t},\n\n\t_calculate_taxes_and_totals: function() {\n\t\tthis.validate_conversion_rate();\n\t\tthis.calculate_item_values();\n\t\tthis.initialize_taxes();\n\t\tthis.determine_exclusive_rate();\n\t\tthis.calculate_net_total();\n\t\tthis.calculate_taxes();\n\t\tthis.manipulate_grand_total_for_inclusive_tax();\n\t\tthis.calculate_totals();\n\t\tthis._cleanup();\n\t},\n\n\tvalidate_conversion_rate: function() {\n\t\tthis.frm.doc.conversion_rate = flt(this.frm.doc.conversion_rate, (cur_frm) ? precision(\"conversion_rate\") : 9);\n\t\tvar conversion_rate_label = frappe.meta.get_label(this.frm.doc.doctype, \"conversion_rate\",\n\t\t\tthis.frm.doc.name);\n\t\tvar company_currency = this.get_company_currency();\n\n\t\tif(!this.frm.doc.conversion_rate) {\n\t\t\tif(this.frm.doc.currency == company_currency) {\n\t\t\t\tthis.frm.set_value(\"conversion_rate\", 1);\n\t\t\t} else {\n\t\t\t\tconst subs = [__(conversion_rate_label), this.frm.doc.currency, company_currency];\n\t\t\t\tconst err_message = __('{0} is mandatory. Maybe Currency Exchange record is not created for {1} to {2}', subs);\n\t\t\t\tfrappe.throw(err_message);\n\t\t\t}\n\t\t}\n\t},\n\n\tcalculate_item_values: function() {\n\t\tvar me = this;\n\t\tif (!this.discount_amount_applied) {\n\t\t\t$.each(this.frm.doc[\"items\"] || [], function(i, item) {\n\t\t\t\tfrappe.model.round_floats_in(item);\n\t\t\t\titem.net_rate = item.rate;\n\n\t\t\t\tif ((!item.qty) && me.frm.doc.is_return) {\n\t\t\t\t\titem.amount = flt(item.rate * -1, precision(\"amount\", item));\n\t\t\t\t} else {\n\t\t\t\t\titem.amount = flt(item.rate * item.qty, precision(\"amount\", item));\n\t\t\t\t}\n\n\t\t\t\titem.net_amount = item.amount;\n\t\t\t\titem.item_tax_amount = 0.0;\n\t\t\t\titem.total_weight = flt(item.weight_per_unit * item.stock_qty);\n\n\t\t\t\tme.set_in_company_currency(item, [\"price_list_rate\", \"rate\", \"amount\", \"net_rate\", \"net_amount\"]);\n\t\t\t});\n\t\t}\n\t},\n\n\tset_in_company_currency: function(doc, fields) {\n\t\tvar me = this;\n\t\t$.each(fields, function(i, f) {\n\t\t\tdoc[\"base_\"+f] = flt(flt(doc[f], precision(f, doc)) * me.frm.doc.conversion_rate, precision(\"base_\" + f, doc));\n\t\t});\n\t},\n\n\tinitialize_taxes: function() {\n\t\tvar me = this;\n\n\t\t$.each(this.frm.doc[\"taxes\"] || [], function(i, tax) {\n\t\t\ttax.item_wise_tax_detail = {};\n\t\t\tvar tax_fields = [\"total\", \"tax_amount_after_discount_amount\",\n\t\t\t\t\"tax_amount_for_current_item\", \"grand_total_for_current_item\",\n\t\t\t\t\"tax_fraction_for_current_item\", \"grand_total_fraction_for_current_item\"];\n\n\t\t\tif (cstr(tax.charge_type) != \"Actual\" &&\n\t\t\t\t!(me.discount_amount_applied && me.frm.doc.apply_discount_on==\"Grand Total\")) {\n\t\t\t\ttax_fields.push(\"tax_amount\");\n\t\t\t}\n\n\t\t\t$.each(tax_fields, function(i, fieldname) { tax[fieldname] = 0.0; });\n\n\t\t\tif (!this.discount_amount_applied && cur_frm) {\n\t\t\t\tcur_frm.cscript.validate_taxes_and_charges(tax.doctype, tax.name);\n\t\t\t\tme.validate_inclusive_tax(tax);\n\t\t\t}\n\t\t\tfrappe.model.round_floats_in(tax);\n\t\t});\n\t},\n\n\tfetch_round_off_accounts: function() {\n\t\tlet me = this;\n\t\tfrappe.flags.round_off_applicable_accounts = [];\n\n\t\tif (me.frm.doc.company) {\n\t\t\treturn frappe.call({\n\t\t\t\t\"method\": \"erpnext.controllers.taxes_and_totals.get_round_off_applicable_accounts\",\n\t\t\t\t\"args\": {\n\t\t\t\t\t\"company\": me.frm.doc.company,\n\t\t\t\t\t\"account_list\": frappe.flags.round_off_applicable_accounts\n\t\t\t\t},\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tfrappe.flags.round_off_applicable_accounts.push(...r.message);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t},\n\n\tdetermine_exclusive_rate: function() {\n\t\tvar me = this;\n\n\t\tvar has_inclusive_tax = false;\n\t\t$.each(me.frm.doc[\"taxes\"] || [], function(i, row) {\n\t\t\tif(cint(row.included_in_print_rate)) has_inclusive_tax = true;\n\t\t});\n\t\tif(has_inclusive_tax==false) return;\n\n\t\t$.each(me.frm.doc[\"items\"] || [], function(n, item) {\n\t\t\tvar item_tax_map = me._load_item_tax_rate(item.item_tax_rate);\n\t\t\tvar cumulated_tax_fraction = 0.0;\n\t\t\tvar total_inclusive_tax_amount_per_qty = 0;\n\n\t\t\t$.each(me.frm.doc[\"taxes\"] || [], function(i, tax) {\n\t\t\t\tvar current_tax_fraction = me.get_current_tax_fraction(tax, item_tax_map);\n\t\t\t\ttax.tax_fraction_for_current_item = current_tax_fraction[0];\n\t\t\t\tvar inclusive_tax_amount_per_qty = current_tax_fraction[1];\n\n\t\t\t\tif(i==0) {\n\t\t\t\t\ttax.grand_total_fraction_for_current_item = 1 + tax.tax_fraction_for_current_item;\n\t\t\t\t} else {\n\t\t\t\t\ttax.grand_total_fraction_for_current_item =\n\t\t\t\t\t\tme.frm.doc[\"taxes\"][i-1].grand_total_fraction_for_current_item +\n\t\t\t\t\t\ttax.tax_fraction_for_current_item;\n\t\t\t\t}\n\n\t\t\t\tcumulated_tax_fraction += tax.tax_fraction_for_current_item;\n\t\t\t\ttotal_inclusive_tax_amount_per_qty += inclusive_tax_amount_per_qty * flt(item.qty);\n\t\t\t});\n\n\t\t\tif(!me.discount_amount_applied && item.qty && (total_inclusive_tax_amount_per_qty || cumulated_tax_fraction)) {\n\t\t\t\tvar amount = flt(item.amount) - total_inclusive_tax_amount_per_qty;\n\t\t\t\titem.net_amount = flt(amount / (1 + cumulated_tax_fraction));\n\t\t\t\titem.net_rate = item.qty ? flt(item.net_amount / item.qty, precision(\"net_rate\", item)) : 0;\n\n\t\t\t\tme.set_in_company_currency(item, [\"net_rate\", \"net_amount\"]);\n\t\t\t}\n\t\t});\n\t},\n\n\tget_current_tax_fraction: function(tax, item_tax_map) {\n\t\t// Get tax fraction for calculating tax exclusive amount\n\t\t// from tax inclusive amount\n\t\tvar current_tax_fraction = 0.0;\n\t\tvar inclusive_tax_amount_per_qty = 0;\n\n\t\tif(cint(tax.included_in_print_rate)) {\n\t\t\tvar tax_rate = this._get_tax_rate(tax, item_tax_map);\n\n\t\t\tif(tax.charge_type == \"On Net Total\") {\n\t\t\t\tcurrent_tax_fraction = (tax_rate / 100.0);\n\n\t\t\t} else if(tax.charge_type == \"On Previous Row Amount\") {\n\t\t\t\tcurrent_tax_fraction = (tax_rate / 100.0) *\n\t\t\t\t\tthis.frm.doc[\"taxes\"][cint(tax.row_id) - 1].tax_fraction_for_current_item;\n\n\t\t\t} else if(tax.charge_type == \"On Previous Row Total\") {\n\t\t\t\tcurrent_tax_fraction = (tax_rate / 100.0) *\n\t\t\t\t\tthis.frm.doc[\"taxes\"][cint(tax.row_id) - 1].grand_total_fraction_for_current_item;\n\t\t\t} else if (tax.charge_type == \"On Item Quantity\") {\n\t\t\t\t\tinclusive_tax_amount_per_qty = flt(tax_rate);\n\t\t\t}\n\t\t}\n\n\t\tif(tax.add_deduct_tax && tax.add_deduct_tax == \"Deduct\") {\n\t\t\tcurrent_tax_fraction *= -1;\n\t\t\tinclusive_tax_amount_per_qty *= -1;\n\t\t}\n\t\treturn [current_tax_fraction, inclusive_tax_amount_per_qty];\n\t},\n\n\t_get_tax_rate: function(tax, item_tax_map) {\n\t\tif (item_tax_map.length) {\n\t\t\tconst item_tax = item_tax_map.filter(f => f.account === tax.account_head)\n\t\t\treturn item_tax.length ?\n\t\t\t\tflt(item_tax[0].rate, precision(\"rate\", tax)) : tax.rate;\n\t\t} else {\n\t\t\treturn tax.rate;\n\t\t}\n\t},\n\n\tcalculate_net_total: function() {\n\t\tvar me = this;\n\t\tthis.frm.doc.total_qty = this.frm.doc.total = this.frm.doc.base_total = this.frm.doc.net_total = this.frm.doc.base_net_total = 0.0;\n\n\t\t$.each(this.frm.doc[\"items\"] || [], function(i, item) {\n\t\t\tme.frm.doc.total += item.amount;\n\t\t\tme.frm.doc.total_qty += item.qty;\n\t\t\tme.frm.doc.base_total += item.base_amount;\n\t\t\tme.frm.doc.net_total += item.net_amount;\n\t\t\tme.frm.doc.base_net_total += item.base_net_amount;\n\t\t\t});\n\n\t\tfrappe.model.round_floats_in(this.frm.doc, [\"total\", \"base_total\", \"net_total\", \"base_net_total\"]);\n\t},\n\n\tcalculate_taxes: function() {\n\t\tvar me = this;\n\t\tthis.frm.doc.rounding_adjustment = 0;\n\t\tvar actual_tax_dict = {};\n\n\t\t// maintain actual tax rate based on idx\n\t\t$.each(this.frm.doc[\"taxes\"] || [], function(i, tax) {\n\t\t\tif (tax.charge_type == \"Actual\") {\n\t\t\t\tactual_tax_dict[tax.idx] = flt(tax.tax_amount, precision(\"tax_amount\", tax));\n\t\t\t}\n\t\t});\n\n\t\t$.each(this.frm.doc[\"items\"] || [], function(n, item) {\n\t\t\tvar item_tax_map = me._load_item_tax_rate(item.item_tax_rate);\n\t\t\t$.each(me.frm.doc[\"taxes\"] || [], function(i, tax) {\n\t\t\t\t// tax_amount represents the amount of tax for the current step\n\t\t\t\tvar current_tax_amount = me.get_current_tax_amount(item, tax, item_tax_map);\n\n\t\t\t\t// Adjust divisional loss to the last item\n\t\t\t\tif (tax.charge_type == \"Actual\") {\n\t\t\t\t\tactual_tax_dict[tax.idx] -= current_tax_amount;\n\t\t\t\t\tif (n == me.frm.doc[\"items\"].length - 1) {\n\t\t\t\t\t\tcurrent_tax_amount += actual_tax_dict[tax.idx];\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// accumulate tax amount into tax.tax_amount\n\t\t\t\tif (tax.charge_type != \"Actual\" &&\n\t\t\t\t\t!(me.discount_amount_applied && me.frm.doc.apply_discount_on==\"Grand Total\")) {\n\t\t\t\t\ttax.tax_amount += current_tax_amount;\n\t\t\t\t}\n\n\t\t\t\t// store tax_amount for current item as it will be used for\n\t\t\t\t// charge type = 'On Previous Row Amount'\n\t\t\t\ttax.tax_amount_for_current_item = current_tax_amount;\n\n\t\t\t\t// tax amount after discount amount\n\t\t\t\ttax.tax_amount_after_discount_amount += current_tax_amount;\n\n\t\t\t\t// for buying\n\t\t\t\tif(tax.category) {\n\t\t\t\t\t// if just for valuation, do not add the tax amount in total\n\t\t\t\t\t// hence, setting it as 0 for further steps\n\t\t\t\t\tcurrent_tax_amount = (tax.category == \"Valuation\") ? 0.0 : current_tax_amount;\n\n\t\t\t\t\tcurrent_tax_amount *= (tax.add_deduct_tax == \"Deduct\") ? -1.0 : 1.0;\n\t\t\t\t}\n\n\t\t\t\t// note: grand_total_for_current_item contains the contribution of\n\t\t\t\t// item's amount, previously applied tax and the current tax on that item\n\t\t\t\tif(i==0) {\n\t\t\t\t\ttax.grand_total_for_current_item = flt(item.net_amount + current_tax_amount);\n\t\t\t\t} else {\n\t\t\t\t\ttax.grand_total_for_current_item =\n\t\t\t\t\t\tflt(me.frm.doc[\"taxes\"][i-1].grand_total_for_current_item + current_tax_amount);\n\t\t\t\t}\n\n\t\t\t\t// set precision in the last item iteration\n\t\t\t\tif (n == me.frm.doc[\"items\"].length - 1) {\n\t\t\t\t\tme.round_off_totals(tax);\n\n\t\t\t\t\t// in tax.total, accumulate grand total for each item\n\t\t\t\t\tme.set_cumulative_total(i, tax);\n\n\t\t\t\t\tme.set_in_company_currency(tax,\n\t\t\t\t\t\t[\"total\", \"tax_amount\", \"tax_amount_after_discount_amount\"]);\n\n\t\t\t\t\t// adjust Discount Amount loss in last tax iteration\n\t\t\t\t\tif ((i == me.frm.doc[\"taxes\"].length - 1) && me.discount_amount_applied\n\t\t\t\t\t\t&& me.frm.doc.apply_discount_on == \"Grand Total\" && me.frm.doc.discount_amount) {\n\t\t\t\t\t\tme.frm.doc.rounding_adjustment = flt(me.frm.doc.grand_total -\n\t\t\t\t\t\t\tflt(me.frm.doc.discount_amount) - tax.total, precision(\"rounding_adjustment\"));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t},\n\n\tset_cumulative_total: function(row_idx, tax) {\n\t\tvar tax_amount = tax.tax_amount_after_discount_amount;\n\t\tif (tax.category == 'Valuation') {\n\t\t\ttax_amount = 0;\n\t\t}\n\n\t\tif (tax.add_deduct_tax == \"Deduct\") { tax_amount = -1*tax_amount; }\n\n\t\tif(row_idx==0) {\n\t\t\ttax.total = flt(this.frm.doc.net_total + tax_amount, precision(\"total\", tax));\n\t\t} else {\n\t\t\ttax.total = flt(this.frm.doc[\"taxes\"][row_idx-1].total + tax_amount, precision(\"total\", tax));\n\t\t}\n\t},\n\n\t_load_item_tax_rate: function(item_tax_rate) {\n\t\treturn item_tax_rate ? JSON.parse(item_tax_rate) : [];\n\t},\n\n\tget_current_tax_amount: function(item, tax, item_tax_map) {\n\t\tvar tax_rate = this._get_tax_rate(tax, item_tax_map);\n\t\tvar current_tax_amount = 0.0;\n\n\t\t// To set row_id by default as previous row.\n\t\tif([\"On Previous Row Amount\", \"On Previous Row Total\"].includes(tax.charge_type)) {\n\t\t\tif (tax.idx === 1) {\n\t\t\t\tfrappe.throw(\n\t\t\t\t\t__(\"Cannot select charge type as 'On Previous Row Amount' or 'On Previous Row Total' for first row\"));\n\t\t\t}\n\t\t\tif (!tax.row_id) {\n\t\t\t\ttax.row_id = tax.idx - 1;\n\t\t\t}\n\t\t}\n\n\t\tif(tax.charge_type == \"Actual\") {\n\t\t\t// distribute the tax amount proportionally to each item row\n\t\t\tvar actual = flt(tax.tax_amount, precision(\"tax_amount\", tax));\n\t\t\tcurrent_tax_amount = this.frm.doc.net_total ?\n\t\t\t\t((item.net_amount / this.frm.doc.net_total) * actual) : 0.0;\n\n\t\t} else if(tax.charge_type == \"On Net Total\") {\n\t\t\tcurrent_tax_amount = (tax_rate / 100.0) * item.net_amount;\n\t\t} else if(tax.charge_type == \"On Previous Row Amount\") {\n\t\t\tcurrent_tax_amount = (tax_rate / 100.0) *\n\t\t\t\tthis.frm.doc[\"taxes\"][cint(tax.row_id) - 1].tax_amount_for_current_item;\n\n\t\t} else if(tax.charge_type == \"On Previous Row Total\") {\n\t\t\tcurrent_tax_amount = (tax_rate / 100.0) *\n\t\t\t\tthis.frm.doc[\"taxes\"][cint(tax.row_id) - 1].grand_total_for_current_item;\n\t\t} else if (tax.charge_type == \"On Item Quantity\") {\n\t\t\tcurrent_tax_amount = tax_rate * item.qty;\n\t\t}\n\n\t\tcurrent_tax_amount = this.get_final_tax_amount(tax, current_tax_amount);\n\t\tthis.set_item_wise_tax(item, tax, tax_rate, current_tax_amount);\n\n\t\treturn current_tax_amount;\n\t},\n\n\tget_final_tax_amount: function(tax, current_tax_amount) {\n\t\tif (frappe.flags.round_off_applicable_accounts.includes(tax.account_head)) {\n\t\t\tcurrent_tax_amount = Math.round(current_tax_amount);\n\t\t}\n\n\t\treturn current_tax_amount;\n\t},\n\n\tset_item_wise_tax: function(item, tax, tax_rate, current_tax_amount) {\n\t\t// store tax breakup for each item\n\t\tlet tax_detail = tax.item_wise_tax_detail;\n\t\tlet key = item.item_code || item.item_name;\n\n\t\tlet item_wise_tax_amount = current_tax_amount * this.frm.doc.conversion_rate;\n\t\tif (tax_detail && tax_detail[key])\n\t\t\titem_wise_tax_amount += tax_detail[key][1];\n\n\t\ttax_detail[key] = [tax_rate, flt(item_wise_tax_amount, precision(\"base_tax_amount\", tax))];\n\t},\n\n\tround_off_totals: function(tax) {\n\t\ttax.tax_amount = flt(tax.tax_amount, precision(\"tax_amount\", tax));\n\t\ttax.tax_amount_after_discount_amount = flt(tax.tax_amount_after_discount_amount, precision(\"tax_amount\", tax));\n\t},\n\n\tmanipulate_grand_total_for_inclusive_tax: function() {\n\t\tvar me = this;\n\t\t// if fully inclusive taxes and diff\n\t\tif (this.frm.doc[\"taxes\"] && this.frm.doc[\"taxes\"].length) {\n\t\t\tvar any_inclusive_tax = false;\n\t\t\t$.each(this.frm.doc.taxes || [], function(i, d) {\n\t\t\t\tif(cint(d.included_in_print_rate)) any_inclusive_tax = true;\n\t\t\t});\n\t\t\tif (any_inclusive_tax) {\n\t\t\t\tvar last_tax = me.frm.doc[\"taxes\"].slice(-1)[0];\n\t\t\t\tvar non_inclusive_tax_amount = frappe.utils.sum($.map(this.frm.doc.taxes || [],\n\t\t\t\t\tfunction(d) {\n\t\t\t\t\t\tif(!d.included_in_print_rate) {\n\t\t\t\t\t\t\treturn flt(d.tax_amount_after_discount_amount);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t));\n\t\t\t\tlet diff = me.frm.doc.total + non_inclusive_tax_amount\n\t\t\t\t\t- flt(last_tax.total, precision(\"grand_total\"));\n\n\t\t\t\tif(me.discount_amount_applied && me.frm.doc.discount_amount) {\n\t\t\t\t\tdiff -= flt(me.frm.doc.discount_amount);\n\t\t\t\t}\n\n\t\t\t\tdiff = flt(diff, precision(\"rounding_adjustment\"));\n\n\t\t\t\tif ( diff && Math.abs(diff) <= (5.0 / Math.pow(10, precision(\"tax_amount\", last_tax))) ) {\n\t\t\t\t\tme.frm.doc.rounding_adjustment = diff;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\n\tcalculate_totals: function() {\n\t\t// Changing sequence can cause rounding_adjustmentng issue and on-screen discrepency\n\t\tvar me = this;\n\t\tvar tax_count = this.frm.doc[\"taxes\"] ? this.frm.doc[\"taxes\"].length : 0;\n\t\tthis.frm.doc.grand_total = flt(tax_count\n\t\t\t? this.frm.doc[\"taxes\"][tax_count - 1].total + flt(this.frm.doc.rounding_adjustment)\n\t\t\t: this.frm.doc.net_total);\n\n\t\tif(in_list([\"Quotation\", \"Sales Order\", \"Delivery Note\", \"Sales Invoice\"], this.frm.doc.doctype)) {\n\t\t\tthis.frm.doc.base_grand_total = (this.frm.doc.total_taxes_and_charges) ?\n\t\t\t\tflt(this.frm.doc.grand_total * this.frm.doc.conversion_rate) : this.frm.doc.base_net_total;\n\t\t} else {\n\t\t\t// other charges added/deducted\n\t\t\tthis.frm.doc.taxes_and_charges_added = this.frm.doc.taxes_and_charges_deducted = 0.0;\n\t\t\tif(tax_count) {\n\t\t\t\t$.each(this.frm.doc[\"taxes\"] || [], function(i, tax) {\n\t\t\t\t\tif (in_list([\"Valuation and Total\", \"Total\"], tax.category)) {\n\t\t\t\t\t\tif(tax.add_deduct_tax == \"Add\") {\n\t\t\t\t\t\t\tme.frm.doc.taxes_and_charges_added += flt(tax.tax_amount_after_discount_amount);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tme.frm.doc.taxes_and_charges_deducted += flt(tax.tax_amount_after_discount_amount);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\t\tfrappe.model.round_floats_in(this.frm.doc,\n\t\t\t\t\t[\"taxes_and_charges_added\", \"taxes_and_charges_deducted\"]);\n\t\t\t}\n\n\t\t\tthis.frm.doc.base_grand_total = flt((this.frm.doc.taxes_and_charges_added || this.frm.doc.taxes_and_charges_deducted) ?\n\t\t\t\tflt(this.frm.doc.grand_total * this.frm.doc.conversion_rate) : this.frm.doc.base_net_total);\n\n\t\t\tthis.set_in_company_currency(this.frm.doc,\n\t\t\t\t[\"taxes_and_charges_added\", \"taxes_and_charges_deducted\"]);\n\t\t}\n\n\t\tthis.frm.doc.total_taxes_and_charges = flt(this.frm.doc.grand_total - this.frm.doc.net_total\n\t\t\t- flt(this.frm.doc.rounding_adjustment), precision(\"total_taxes_and_charges\"));\n\n\t\tthis.set_in_company_currency(this.frm.doc, [\"total_taxes_and_charges\", \"rounding_adjustment\"]);\n\n\t\t// Round grand total as per precision\n\t\tfrappe.model.round_floats_in(this.frm.doc, [\"grand_total\", \"base_grand_total\"]);\n\n\t\t// rounded totals\n\t\tthis.set_rounded_total();\n\t},\n\n\tset_rounded_total: function() {\n\t\tvar disable_rounded_total = 0;\n\t\tif(frappe.meta.get_docfield(this.frm.doc.doctype, \"disable_rounded_total\", this.frm.doc.name)) {\n\t\t\tdisable_rounded_total = this.frm.doc.disable_rounded_total;\n\t\t} else if (frappe.sys_defaults.disable_rounded_total) {\n\t\t\tdisable_rounded_total = frappe.sys_defaults.disable_rounded_total;\n\t\t}\n\n\t\tif (cint(disable_rounded_total)) {\n\t\t\tthis.frm.doc.rounded_total = 0;\n\t\t\tthis.frm.doc.base_rounded_total = 0;\n\t\t\treturn;\n\t\t}\n\n\t\tif(frappe.meta.get_docfield(this.frm.doc.doctype, \"rounded_total\", this.frm.doc.name)) {\n\t\t\tthis.frm.doc.rounded_total = round_based_on_smallest_currency_fraction(this.frm.doc.grand_total,\n\t\t\t\tthis.frm.doc.currency, precision(\"rounded_total\"));\n\t\t\tthis.frm.doc.rounding_adjustment += flt(this.frm.doc.rounded_total - this.frm.doc.grand_total,\n\t\t\t\tprecision(\"rounding_adjustment\"));\n\n\t\t\tthis.set_in_company_currency(this.frm.doc, [\"rounding_adjustment\", \"rounded_total\"]);\n\t\t}\n\t},\n\n\t_cleanup: function() {\n\t\tthis.frm.doc.base_in_words = this.frm.doc.in_words = \"\";\n\n\t\tif(this.frm.doc[\"items\"] && this.frm.doc[\"items\"].length) {\n\t\t\tif(!frappe.meta.get_docfield(this.frm.doc[\"items\"][0].doctype, \"item_tax_amount\", this.frm.doctype)) {\n\t\t\t\t$.each(this.frm.doc[\"items\"] || [], function(i, item) {\n\t\t\t\t\tdelete item[\"item_tax_amount\"];\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tif(this.frm.doc[\"taxes\"] && this.frm.doc[\"taxes\"].length) {\n\t\t\tvar temporary_fields = [\"tax_amount_for_current_item\", \"grand_total_for_current_item\",\n\t\t\t\t\"tax_fraction_for_current_item\", \"grand_total_fraction_for_current_item\"];\n\n\t\t\tif(!frappe.meta.get_docfield(this.frm.doc[\"taxes\"][0].doctype, \"tax_amount_after_discount_amount\", this.frm.doctype)) {\n\t\t\t\ttemporary_fields.push(\"tax_amount_after_discount_amount\");\n\t\t\t}\n\n\t\t\t$.each(this.frm.doc[\"taxes\"] || [], function(i, tax) {\n\t\t\t\t$.each(temporary_fields, function(i, fieldname) {\n\t\t\t\t\tdelete tax[fieldname];\n\t\t\t\t});\n\n\t\t\t\ttax.item_wise_tax_detail = JSON.stringify(tax.item_wise_tax_detail);\n\t\t\t});\n\t\t}\n\t},\n\n\tset_discount_amount: function() {\n\t\tif(this.frm.doc.additional_discount_percentage) {\n\t\t\tthis.frm.doc.discount_amount = flt(flt(this.frm.doc[frappe.scrub(this.frm.doc.apply_discount_on)])\n\t\t\t\t* this.frm.doc.additional_discount_percentage / 100, precision(\"discount_amount\"));\n\t\t}\n\t},\n\n\tapply_discount_amount: function() {\n\t\tvar me = this;\n\t\tvar distributed_amount = 0.0;\n\t\tthis.frm.doc.base_discount_amount = 0.0;\n\n\t\tif (this.frm.doc.discount_amount) {\n\t\t\tif(!this.frm.doc.apply_discount_on)\n\t\t\t\tfrappe.throw(__(\"Please select Apply Discount On\"));\n\n\t\t\tthis.frm.doc.base_discount_amount = flt(this.frm.doc.discount_amount * this.frm.doc.conversion_rate,\n\t\t\t\tprecision(\"base_discount_amount\"));\n\n\t\t\tvar total_for_discount_amount = this.get_total_for_discount_amount();\n\t\t\tvar net_total = 0;\n\t\t\t// calculate item amount after Discount Amount\n\t\t\tif (total_for_discount_amount) {\n\t\t\t\t$.each(this.frm.doc[\"items\"] || [], function(i, item) {\n\t\t\t\t\tdistributed_amount = flt(me.frm.doc.discount_amount) * item.net_amount / total_for_discount_amount;\n\t\t\t\t\titem.net_amount = flt(item.net_amount - distributed_amount,\n\t\t\t\t\t\tprecision(\"base_amount\", item));\n\t\t\t\t\tnet_total += item.net_amount;\n\n\t\t\t\t\t// discount amount rounding loss adjustment if no taxes\n\t\t\t\t\tif ((!(me.frm.doc.taxes || []).length || total_for_discount_amount==me.frm.doc.net_total || (me.frm.doc.apply_discount_on == \"Net Total\"))\n\t\t\t\t\t\t\t&& i == (me.frm.doc.items || []).length - 1) {\n\t\t\t\t\t\tvar discount_amount_loss = flt(me.frm.doc.net_total - net_total\n\t\t\t\t\t\t\t- me.frm.doc.discount_amount, precision(\"net_total\"));\n\t\t\t\t\t\titem.net_amount = flt(item.net_amount + discount_amount_loss,\n\t\t\t\t\t\t\tprecision(\"net_amount\", item));\n\t\t\t\t\t}\n\t\t\t\t\titem.net_rate = item.qty ? flt(item.net_amount / item.qty, precision(\"net_rate\", item)) : 0;\n\t\t\t\t\tme.set_in_company_currency(item, [\"net_rate\", \"net_amount\"]);\n\t\t\t\t});\n\n\t\t\t\tthis.discount_amount_applied = true;\n\t\t\t\tthis._calculate_taxes_and_totals();\n\t\t\t}\n\t\t}\n\t},\n\n\tget_total_for_discount_amount: function() {\n\t\tif(this.frm.doc.apply_discount_on == \"Net Total\") {\n\t\t\treturn this.frm.doc.net_total;\n\t\t} else {\n\t\t\tvar total_actual_tax = 0.0;\n\t\t\tvar actual_taxes_dict = {};\n\n\t\t\t$.each(this.frm.doc[\"taxes\"] || [], function(i, tax) {\n\t\t\t\tif (in_list([\"Actual\", \"On Item Quantity\"], tax.charge_type)) {\n\t\t\t\t\tvar tax_amount = (tax.category == \"Valuation\") ? 0.0 : tax.tax_amount;\n\t\t\t\t\ttax_amount *= (tax.add_deduct_tax == \"Deduct\") ? -1.0 : 1.0;\n\t\t\t\t\tactual_taxes_dict[tax.idx] = tax_amount;\n\t\t\t\t} else if (actual_taxes_dict[tax.row_id] !== null) {\n\t\t\t\t\tvar actual_tax_amount = flt(actual_taxes_dict[tax.row_id]) * flt(tax.rate) / 100;\n\t\t\t\t\tactual_taxes_dict[tax.idx] = actual_tax_amount;\n\t\t\t\t}\n\t\t\t});\n\n\t\t\t$.each(actual_taxes_dict, function(key, value) {\n\t\t\t\tif (value) total_actual_tax += value;\n\t\t\t});\n\n\t\t\treturn flt(this.frm.doc.grand_total - total_actual_tax, precision(\"grand_total\"));\n\t\t}\n\t},\n\n\tcalculate_total_advance: function(update_paid_amount) {\n\t\tvar total_allocated_amount = frappe.utils.sum($.map(this.frm.doc[\"advances\"] || [], function(adv) {\n\t\t\treturn flt(adv.allocated_amount, precision(\"allocated_amount\", adv));\n\t\t}));\n\t\tthis.frm.doc.total_advance = flt(total_allocated_amount, precision(\"total_advance\"));\n\n\t\tthis.calculate_outstanding_amount(update_paid_amount);\n\t},\n\n\tis_internal_invoice: function() {\n\t\tif (['Sales Invoice', 'Purchase Invoice'].includes(this.frm.doc.doctype)) {\n\t\t\tif (this.frm.doc.company === this.frm.doc.represents_company) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t},\n\n\tcalculate_outstanding_amount: function(update_paid_amount) {\n\t\t// NOTE:\n\t\t// paid_amount and write_off_amount is only for POS/Loyalty Point Redemption Invoice\n\t\t// total_advance is only for non POS Invoice\n\t\tif(in_list([\"Sales Invoice\", \"POS Invoice\"], this.frm.doc.doctype) && this.frm.doc.is_return){\n\t\t\tthis.calculate_paid_amount();\n\t\t}\n\n\t\tif (this.frm.doc.is_return || (this.frm.doc.docstatus > 0) || this.is_internal_invoice()) return;\n\n\t\tfrappe.model.round_floats_in(this.frm.doc, [\"grand_total\", \"total_advance\", \"write_off_amount\"]);\n\n\t\tif(in_list([\"Sales Invoice\", \"POS Invoice\", \"Purchase Invoice\"], this.frm.doc.doctype)) {\n\t\t\tvar grand_total = this.frm.doc.rounded_total || this.frm.doc.grand_total;\n\n\t\t\tif(this.frm.doc.party_account_currency == this.frm.doc.currency) {\n\t\t\t\tvar total_amount_to_pay = flt((grand_total - this.frm.doc.total_advance\n\t\t\t\t\t- this.frm.doc.write_off_amount), precision(\"grand_total\"));\n\t\t\t} else {\n\t\t\t\tvar total_amount_to_pay = flt(\n\t\t\t\t\t(flt(grand_total*this.frm.doc.conversion_rate, precision(\"grand_total\"))\n\t\t\t\t\t\t- this.frm.doc.total_advance - this.frm.doc.base_write_off_amount),\n\t\t\t\t\tprecision(\"base_grand_total\")\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tfrappe.model.round_floats_in(this.frm.doc, [\"paid_amount\"]);\n\t\t\tthis.set_in_company_currency(this.frm.doc, [\"paid_amount\"]);\n\n\t\t\tif(this.frm.refresh_field){\n\t\t\t\tthis.frm.refresh_field(\"paid_amount\");\n\t\t\t\tthis.frm.refresh_field(\"base_paid_amount\");\n\t\t\t}\n\n\t\t\tif(in_list([\"Sales Invoice\", \"POS Invoice\"], this.frm.doc.doctype)) {\n\t\t\t\tlet total_amount_for_payment = (this.frm.doc.redeem_loyalty_points && this.frm.doc.loyalty_amount)\n\t\t\t\t\t? flt(total_amount_to_pay - this.frm.doc.loyalty_amount, precision(\"base_grand_total\"))\n\t\t\t\t\t: total_amount_to_pay;\n\t\t\t\tthis.set_default_payment(total_amount_for_payment, update_paid_amount);\n\t\t\t\tthis.calculate_paid_amount();\n\t\t\t}\n\t\t\tthis.calculate_change_amount();\n\n\t\t\tvar paid_amount = (this.frm.doc.party_account_currency == this.frm.doc.currency) ?\n\t\t\t\tthis.frm.doc.paid_amount : this.frm.doc.base_paid_amount;\n\t\t\tthis.frm.doc.outstanding_amount =  flt(total_amount_to_pay - flt(paid_amount) +\n\t\t\t\tflt(this.frm.doc.change_amount * this.frm.doc.conversion_rate), precision(\"outstanding_amount\"));\n\t\t}\n\t},\n\n\tupdate_paid_amount_for_return: function() {\n\t\tvar grand_total = this.frm.doc.rounded_total || this.frm.doc.grand_total;\n\n\t\tif(this.frm.doc.party_account_currency == this.frm.doc.currency) {\n\t\t\tvar total_amount_to_pay = flt((grand_total - this.frm.doc.total_advance\n\t\t\t\t- this.frm.doc.write_off_amount), precision(\"grand_total\"));\n\t\t} else {\n\t\t\tvar total_amount_to_pay = flt(\n\t\t\t\t(flt(grand_total*this.frm.doc.conversion_rate, precision(\"grand_total\"))\n\t\t\t\t\t- this.frm.doc.total_advance - this.frm.doc.base_write_off_amount),\n\t\t\t\tprecision(\"base_grand_total\")\n\t\t\t);\n\t\t}\n\n\t\tthis.frm.doc.payments.find(pay => {\n\t\t\tif (pay.default) {\n\t\t\t\tpay.amount = total_amount_to_pay;\n\t\t\t} else {\n\t\t\t\tpay.amount = 0.0\n\t\t\t}\n\t\t});\n\t\tthis.frm.refresh_fields();\n\n\t\tthis.calculate_paid_amount();\n\t},\n\n\tset_default_payment: function(total_amount_to_pay, update_paid_amount) {\n\t\tvar me = this;\n\t\tvar payment_status = true;\n\t\tif(this.frm.doc.is_pos && (update_paid_amount===undefined || update_paid_amount)) {\n\t\t\t$.each(this.frm.doc['payments'] || [], function(index, data) {\n\t\t\t\tif(data.default && payment_status && total_amount_to_pay > 0) {\n\t\t\t\t\tlet base_amount = flt(total_amount_to_pay, precision(\"base_amount\", data));\n\t\t\t\t\tfrappe.model.set_value(data.doctype, data.name, \"base_amount\", base_amount);\n\t\t\t\t\tlet amount = flt(total_amount_to_pay / me.frm.doc.conversion_rate, precision(\"amount\", data));\n\t\t\t\t\tfrappe.model.set_value(data.doctype, data.name, \"amount\", amount);\n\t\t\t\t} else if(me.frm.doc.paid_amount) {\n\t\t\t\t\tfrappe.model.set_value(data.doctype, data.name, \"amount\", 0.0);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t},\n\n\tcalculate_paid_amount: function() {\n\t\tvar me = this;\n\t\tvar paid_amount = 0.0;\n\t\tvar base_paid_amount = 0.0;\n\t\tif(this.frm.doc.is_pos) {\n\t\t\t$.each(this.frm.doc['payments'] || [], function(index, data){\n\t\t\t\tdata.base_amount = flt(data.amount * me.frm.doc.conversion_rate, precision(\"base_amount\", data));\n\t\t\t\tpaid_amount += data.amount;\n\t\t\t\tbase_paid_amount += data.base_amount;\n\t\t\t});\n\t\t} else if(!this.frm.doc.is_return){\n\t\t\tthis.frm.doc.payments = [];\n\t\t}\n\t\tif (this.frm.doc.redeem_loyalty_points && this.frm.doc.loyalty_amount) {\n\t\t\tbase_paid_amount += this.frm.doc.loyalty_amount;\n\t\t\tpaid_amount += flt(this.frm.doc.loyalty_amount / me.frm.doc.conversion_rate, precision(\"paid_amount\"));\n\t\t}\n\n\t\tthis.frm.set_value('paid_amount', flt(paid_amount, precision(\"paid_amount\")));\n\t\tthis.frm.set_value('base_paid_amount', flt(base_paid_amount, precision(\"base_paid_amount\")));\n\t},\n\n\tcalculate_change_amount: function(){\n\t\tthis.frm.doc.change_amount = 0.0;\n\t\tthis.frm.doc.base_change_amount = 0.0;\n\t\tif(in_list([\"Sales Invoice\", \"POS Invoice\"], this.frm.doc.doctype)\n\t\t\t&& this.frm.doc.paid_amount > this.frm.doc.grand_total && !this.frm.doc.is_return) {\n\n\t\t\tvar payment_types = $.map(this.frm.doc.payments, function(d) { return d.type; });\n\t\t\tif (in_list(payment_types, 'Cash')) {\n\t\t\t\tvar grand_total = this.frm.doc.rounded_total || this.frm.doc.grand_total;\n\t\t\t\tvar base_grand_total = this.frm.doc.base_rounded_total || this.frm.doc.base_grand_total;\n\n\t\t\t\tthis.frm.doc.change_amount = flt(this.frm.doc.paid_amount - grand_total +\n\t\t\t\t\tthis.frm.doc.write_off_amount, precision(\"change_amount\"));\n\n\t\t\t\tthis.frm.doc.base_change_amount = flt(this.frm.doc.base_paid_amount -\n\t\t\t\t\tbase_grand_total + this.frm.doc.base_write_off_amount,\n\t\t\t\t\tprecision(\"base_change_amount\"));\n\t\t\t}\n\t\t}\n\t},\n\n\tcalculate_write_off_amount: function(){\n\t\tif(this.frm.doc.paid_amount > this.frm.doc.grand_total){\n\t\t\tthis.frm.doc.write_off_amount = flt(this.frm.doc.grand_total - this.frm.doc.paid_amount\n\t\t\t\t+ this.frm.doc.change_amount, precision(\"write_off_amount\"));\n\n\t\t\tthis.frm.doc.base_write_off_amount = flt(this.frm.doc.write_off_amount * this.frm.doc.conversion_rate,\n\t\t\t\tprecision(\"base_write_off_amount\"));\n\t\t}else{\n\t\t\tthis.frm.doc.paid_amount = 0.0;\n\t\t}\n\t\tthis.calculate_outstanding_amount(false);\n\t}\n});\n","// Copyright (c) 2015, Frappe Technologies Pvt. Ltd. and Contributors\n// License: GNU General Public License v3. See license.txt\n\nfrappe.provide('erpnext.accounts.dimensions');\n\nerpnext.TransactionController = erpnext.taxes_and_totals.extend({\n\tsetup: function() {\n\t\tthis._super();\n\t\tfrappe.flags.hide_serial_batch_dialog = true;\n\t\tfrappe.ui.form.on(this.frm.doctype + \" Item\", \"rate\", function(frm, cdt, cdn) {\n\t\t\tvar item = frappe.get_doc(cdt, cdn);\n\t\t\tvar has_margin_field = frappe.meta.has_field(cdt, 'margin_type');\n\n\t\t\tfrappe.model.round_floats_in(item, [\"rate\", \"price_list_rate\"]);\n\n\t\t\tif(item.price_list_rate) {\n\t\t\t\tif(item.rate > item.price_list_rate && has_margin_field) {\n\t\t\t\t\t// if rate is greater than price_list_rate, set margin\n\t\t\t\t\t// or set discount\n\t\t\t\t\titem.discount_percentage = 0;\n\t\t\t\t\titem.margin_type = 'Amount';\n\t\t\t\t\titem.margin_rate_or_amount = flt(item.rate - item.price_list_rate,\n\t\t\t\t\t\tprecision(\"margin_rate_or_amount\", item));\n\t\t\t\t\titem.rate_with_margin = item.rate;\n\t\t\t\t} else {\n\t\t\t\t\titem.discount_percentage = flt((1 - item.rate / item.price_list_rate) * 100.0,\n\t\t\t\t\t\tprecision(\"discount_percentage\", item));\n\t\t\t\t\titem.discount_amount = flt(item.price_list_rate) - flt(item.rate);\n\t\t\t\t\titem.margin_type = '';\n\t\t\t\t\titem.margin_rate_or_amount = 0;\n\t\t\t\t\titem.rate_with_margin = 0;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\titem.discount_percentage = 0.0;\n\t\t\t\titem.margin_type = '';\n\t\t\t\titem.margin_rate_or_amount = 0;\n\t\t\t\titem.rate_with_margin = 0;\n\t\t\t}\n\t\t\titem.base_rate_with_margin = item.rate_with_margin * flt(frm.doc.conversion_rate);\n\n\t\t\tcur_frm.cscript.set_gross_profit(item);\n\t\t\tcur_frm.cscript.calculate_taxes_and_totals();\n\t\t\tcur_frm.cscript.calculate_stock_uom_rate(frm, cdt, cdn);\n\t\t});\n\n\n\n\t\tfrappe.ui.form.on(this.frm.cscript.tax_table, \"rate\", function(frm, cdt, cdn) {\n\t\t\tcur_frm.cscript.calculate_taxes_and_totals();\n\t\t});\n\n\t\tfrappe.ui.form.on(this.frm.cscript.tax_table, \"tax_amount\", function(frm, cdt, cdn) {\n\t\t\tcur_frm.cscript.calculate_taxes_and_totals();\n\t\t});\n\n\t\tfrappe.ui.form.on(this.frm.cscript.tax_table, \"row_id\", function(frm, cdt, cdn) {\n\t\t\tcur_frm.cscript.calculate_taxes_and_totals();\n\t\t});\n\n\t\tfrappe.ui.form.on(this.frm.cscript.tax_table, \"included_in_print_rate\", function(frm, cdt, cdn) {\n\t\t\tcur_frm.cscript.set_dynamic_labels();\n\t\t\tcur_frm.cscript.calculate_taxes_and_totals();\n\t\t});\n\n\t\tfrappe.ui.form.on(this.frm.doctype, \"apply_discount_on\", function(frm) {\n\t\t\tif(frm.doc.additional_discount_percentage) {\n\t\t\t\tfrm.trigger(\"additional_discount_percentage\");\n\t\t\t} else {\n\t\t\t\tcur_frm.cscript.calculate_taxes_and_totals();\n\t\t\t}\n\t\t});\n\n\t\tfrappe.ui.form.on(this.frm.doctype, \"additional_discount_percentage\", function(frm) {\n\t\t\tif(!frm.doc.apply_discount_on) {\n\t\t\t\tfrappe.msgprint(__(\"Please set 'Apply Additional Discount On'\"));\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tfrm.via_discount_percentage = true;\n\n\t\t\tif(frm.doc.additional_discount_percentage && frm.doc.discount_amount) {\n\t\t\t\t// Reset discount amount and net / grand total\n\t\t\t\tfrm.doc.discount_amount = 0;\n\t\t\t\tfrm.cscript.calculate_taxes_and_totals();\n\t\t\t}\n\n\t\t\tvar total = flt(frm.doc[frappe.model.scrub(frm.doc.apply_discount_on)]);\n\t\t\tvar discount_amount = flt(total*flt(frm.doc.additional_discount_percentage) / 100,\n\t\t\t\tprecision(\"discount_amount\"));\n\n\t\t\tfrm.set_value(\"discount_amount\", discount_amount)\n\t\t\t\t.then(() => delete frm.via_discount_percentage);\n\t\t});\n\n\t\tfrappe.ui.form.on(this.frm.doctype, \"discount_amount\", function(frm) {\n\t\t\tfrm.cscript.set_dynamic_labels();\n\n\t\t\tif (!frm.via_discount_percentage) {\n\t\t\t\tfrm.doc.additional_discount_percentage = 0;\n\t\t\t}\n\n\t\t\tfrm.cscript.calculate_taxes_and_totals();\n\t\t});\n\n\t\tfrappe.ui.form.on(this.frm.doctype + \" Item\", {\n\t\t\titems_add: function(frm, cdt, cdn) {\n\t\t\t\tvar item = frappe.get_doc(cdt, cdn);\n\t\t\t\tif (!item.warehouse && frm.doc.set_warehouse) {\n\t\t\t\t\titem.warehouse = frm.doc.set_warehouse;\n\t\t\t\t}\n\n\t\t\t\tif (!item.target_warehouse && frm.doc.set_target_warehouse) {\n\t\t\t\t\titem.target_warehouse = frm.doc.set_target_warehouse;\n\t\t\t\t}\n\n\t\t\t\tif (!item.from_warehouse && frm.doc.set_from_warehouse) {\n\t\t\t\t\titem.from_warehouse = frm.doc.set_from_warehouse;\n\t\t\t\t}\n\n\t\t\t\terpnext.accounts.dimensions.copy_dimension_from_first_row(frm, cdt, cdn, 'items');\n\t\t\t}\n\t\t});\n\n\t\tvar me = this;\n\t\tif(this.frm.fields_dict[\"items\"].grid.get_field('batch_no')) {\n\t\t\tthis.frm.set_query(\"batch_no\", \"items\", function(doc, cdt, cdn) {\n\t\t\t\treturn me.set_query_for_batch(doc, cdt, cdn);\n\t\t\t});\n\t\t}\n\n\t\tif(\n\t\t\tthis.frm.docstatus < 2\n\t\t\t&& this.frm.fields_dict[\"payment_terms_template\"]\n\t\t\t&& this.frm.fields_dict[\"payment_schedule\"]\n\t\t\t&& this.frm.doc.payment_terms_template\n\t\t\t&& !this.frm.doc.payment_schedule.length\n\t\t){\n\t\t\tthis.frm.trigger(\"payment_terms_template\");\n\t\t}\n\n\t\tif(this.frm.fields_dict[\"taxes\"]) {\n\t\t\tthis[\"taxes_remove\"] = this.calculate_taxes_and_totals;\n\t\t}\n\n\t\tif(this.frm.fields_dict[\"items\"]) {\n\t\t\tthis[\"items_remove\"] = this.calculate_net_weight;\n\t\t}\n\n\t\tif(this.frm.fields_dict[\"recurring_print_format\"]) {\n\t\t\tthis.frm.set_query(\"recurring_print_format\", function(doc) {\n\t\t\t\treturn{\n\t\t\t\t\tfilters: [\n\t\t\t\t\t\t['Print Format', 'doc_type', '=', cur_frm.doctype],\n\t\t\t\t\t]\n\t\t\t\t};\n\t\t\t});\n\t\t}\n\n\t\tif(this.frm.fields_dict[\"return_against\"]) {\n\t\t\tthis.frm.set_query(\"return_against\", function(doc) {\n\t\t\t\tvar filters = {\n\t\t\t\t\t\"docstatus\": 1,\n\t\t\t\t\t\"is_return\": 0,\n\t\t\t\t\t\"company\": doc.company\n\t\t\t\t};\n\t\t\t\tif (me.frm.fields_dict[\"customer\"] && doc.customer) filters[\"customer\"] = doc.customer;\n\t\t\t\tif (me.frm.fields_dict[\"supplier\"] && doc.supplier) filters[\"supplier\"] = doc.supplier;\n\n\t\t\t\treturn {\n\t\t\t\t\tfilters: filters\n\t\t\t\t};\n\t\t\t});\n\t\t}\n\n\t\tif (this.frm.fields_dict[\"items\"].grid.get_field(\"expense_account\")) {\n\t\t\tthis.frm.set_query(\"expense_account\", \"items\", function(doc) {\n\t\t\t\treturn {\n\t\t\t\t\tfilters: {\n\t\t\t\t\t\t\"company\": doc.company\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t});\n\t\t}\n\n\t\tif(frappe.meta.get_docfield(this.frm.doc.doctype, \"pricing_rules\")) {\n\t\t\tthis.frm.set_indicator_formatter('pricing_rule', function(doc) {\n\t\t\t\treturn (doc.rule_applied) ? \"green\" : \"red\";\n\t\t\t});\n\t\t}\n\n\t\tlet batch_no_field = this.frm.get_docfield(\"items\", \"batch_no\");\n\t\tif (batch_no_field) {\n\t\t\tbatch_no_field.get_route_options_for_new_doc = function(row) {\n\t\t\t\treturn {\n\t\t\t\t\t\"item\": row.doc.item_code\n\t\t\t\t}\n\t\t\t};\n\t\t}\n\n\t\tif (this.frm.fields_dict[\"items\"].grid.get_field('blanket_order')) {\n\t\t\tthis.frm.set_query(\"blanket_order\", \"items\", function(doc, cdt, cdn) {\n\t\t\t\tvar item = locals[cdt][cdn];\n\t\t\t\treturn {\n\t\t\t\t\tquery: \"erpnext.controllers.queries.get_blanket_orders\",\n\t\t\t\t\tfilters: {\n\t\t\t\t\t\t\"company\": doc.company,\n\t\t\t\t\t\t\"blanket_order_type\": doc.doctype === \"Sales Order\" ? \"Selling\" : \"Purchasing\",\n\t\t\t\t\t\t\"item\": item.item_code\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tif(this.frm.fields_dict.taxes_and_charges) {\n\t\t\tthis.frm.set_query(\"taxes_and_charges\", function() {\n\t\t\t\treturn {\n\t\t\t\t\tfilters: {\n\t\t\t\t\t\t'company': me.frm.doc.company,\n\t\t\t\t\t\t'disabled': 0\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t},\n\tonload: function() {\n\t\tvar me = this;\n\n\t\tif(this.frm.doc.__islocal) {\n\t\t\tvar currency = frappe.defaults.get_user_default(\"currency\");\n\n\t\t\tlet set_value = (fieldname, value) => {\n\t\t\t\tif(me.frm.fields_dict[fieldname] && !me.frm.doc[fieldname]) {\n\t\t\t\t\treturn me.frm.set_value(fieldname, value);\n\t\t\t\t}\n\t\t\t};\n\n\t\t\tthis.frm.trigger('set_default_internal_warehouse');\n\n\t\t\treturn frappe.run_serially([\n\t\t\t\t() => set_value('currency', currency),\n\t\t\t\t() => set_value('price_list_currency', currency),\n\t\t\t\t() => set_value('status', 'Draft'),\n\t\t\t\t() => set_value('is_subcontracted', 'No'),\n\t\t\t\t() => {\n\t\t\t\t\tif(this.frm.doc.company && !this.frm.doc.amended_from) {\n\t\t\t\t\t\tthis.frm.trigger(\"company\");\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t]);\n\t\t}\n\t},\n\n\tis_return: function() {\n\t\tif(!this.frm.doc.is_return && this.frm.doc.return_against) {\n\t\t\tthis.frm.set_value('return_against', '');\n\t\t}\n\t},\n\n\tsetup_quality_inspection: function() {\n\t\tif(!in_list([\"Delivery Note\", \"Sales Invoice\", \"Purchase Receipt\", \"Purchase Invoice\"], this.frm.doc.doctype)) {\n\t\t\treturn;\n\t\t}\n\t\tvar me = this;\n\t\tvar inspection_type = in_list([\"Purchase Receipt\", \"Purchase Invoice\"], this.frm.doc.doctype)\n\t\t\t? \"Incoming\" : \"Outgoing\";\n\n\t\tvar quality_inspection_field = this.frm.get_docfield(\"items\", \"quality_inspection\");\n\t\tquality_inspection_field.get_route_options_for_new_doc = function(row) {\n\t\t\tif(me.frm.is_new()) return;\n\t\t\treturn {\n\t\t\t\t\"inspection_type\": inspection_type,\n\t\t\t\t\"reference_type\": me.frm.doc.doctype,\n\t\t\t\t\"reference_name\": me.frm.doc.name,\n\t\t\t\t\"item_code\": row.doc.item_code,\n\t\t\t\t\"description\": row.doc.description,\n\t\t\t\t\"item_serial_no\": row.doc.serial_no ? row.doc.serial_no.split(\"\\n\")[0] : null,\n\t\t\t\t\"batch_no\": row.doc.batch_no\n\t\t\t}\n\t\t}\n\n\t\tthis.frm.set_query(\"quality_inspection\", \"items\", function(doc, cdt, cdn) {\n\t\t\tvar d = locals[cdt][cdn];\n\t\t\treturn {\n\t\t\t\tfilters: {\n\t\t\t\t\tdocstatus: 1,\n\t\t\t\t\tinspection_type: inspection_type,\n\t\t\t\t\treference_name: doc.name,\n\t\t\t\t\titem_code: d.item_code\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t},\n\n\tmake_payment_request: function() {\n\t\tvar me = this;\n\n\t\tfrappe.call({\n\t\t\tmethod:\"erpnext.accounts.doctype.payment_request.payment_request.make_payment_request\",\n\t\t\targs: {\n\t\t\t\tdt: me.frm.doc.doctype,\n\t\t\t\tdn: me.frm.doc.name,\n\t\t\t\trecipient_id: me.frm.doc.contact_email,\n\t\t\t\tparty_type: \"Customer\",\n\t\t\t\tparty: me.frm.doc.customer\n\t\t\t},\n\t\t\tcallback: function(r) {\n\t\t\t\tif(!r.exc){\n\t\t\t\t\tvar doc = frappe.model.sync(r.message);\n\t\t\t\t\tfrappe.set_route(\"Form\", r.message.doctype, r.message.name);\n\t\t\t\t}\n\t\t\t}\n\t\t})\n\t},\n\n\tonload_post_render: function() {\n\t\tif(this.frm.doc.__islocal && !(this.frm.doc.taxes || []).length\n\t\t\t&& !(this.frm.doc.__onload ? this.frm.doc.__onload.load_after_mapping : false)) {\n\t\t\tfrappe.after_ajax(() => this.apply_default_taxes());\n\t\t} else if(this.frm.doc.__islocal && this.frm.doc.company && this.frm.doc[\"items\"]\n\t\t\t&& !this.frm.doc.is_pos) {\n\t\t\tfrappe.after_ajax(() => this.calculate_taxes_and_totals());\n\t\t}\n\t\tif(frappe.meta.get_docfield(this.frm.doc.doctype + \" Item\", \"item_code\")) {\n\t\t\tthis.setup_item_selector();\n\t\t\tthis.frm.get_field(\"items\").grid.set_multiple_add(\"item_code\", \"qty\");\n\t\t}\n\t},\n\n\trefresh: function() {\n\t\terpnext.toggle_naming_series();\n\t\terpnext.hide_company();\n\t\tthis.set_dynamic_labels();\n\t\tthis.setup_sms();\n\t\tthis.setup_quality_inspection();\n\t\tlet scan_barcode_field = this.frm.get_field('scan_barcode');\n\t\tif (scan_barcode_field && scan_barcode_field.get_value()) {\n\t\t\tscan_barcode_field.set_value(\"\");\n\t\t\tscan_barcode_field.set_new_description(\"\");\n\n\t\t\tif (frappe.is_mobile()) {\n\t\t\t\tif (scan_barcode_field.$input_wrapper.find('.input-group').length) return;\n\n\t\t\t\tlet $input_group = $('<div class=\"input-group\">');\n\t\t\t\tscan_barcode_field.$input_wrapper.find('.control-input').append($input_group);\n\t\t\t\t$input_group.append(scan_barcode_field.$input);\n\t\t\t\t$(`<span class=\"input-group-btn\" style=\"vertical-align: top\">\n\t\t\t\t\t\t<button class=\"btn btn-default border\" type=\"button\">\n\t\t\t\t\t\t\t<i class=\"fas fa-camera-retro text-muted\"></i>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</span>`)\n\t\t\t\t\t.on('click', '.btn', () => {\n\t\t\t\t\t\tfrappe.barcode.scan_barcode().then(barcode => {\n\t\t\t\t\t\t\tscan_barcode_field.set_value(barcode);\n\t\t\t\t\t\t});\n\t\t\t\t\t})\n\t\t\t\t\t.appendTo($input_group);\n\t\t\t}\n\t\t}\n\t},\n\n\tscan_barcode: function() {\n\t\tlet scan_barcode_field = this.frm.fields_dict[\"scan_barcode\"];\n\n\t\tlet show_description = function(idx, exist = null) {\n\t\t\tif (exist) {\n\t\t\t\tfrappe.show_alert({\n\t\t\t\t\tmessage: __('Row #{0}: Qty increased by 1', [idx]),\n\t\t\t\t\tindicator: 'green'\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tfrappe.show_alert({\n\t\t\t\t\tmessage: __('Row #{0}: Item added', [idx]),\n\t\t\t\t\tindicator: 'green'\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tif(this.frm.doc.scan_barcode) {\n\t\t\tfrappe.call({\n\t\t\t\tmethod: \"erpnext.selling.page.point_of_sale.point_of_sale.search_serial_or_batch_or_barcode_number\",\n\t\t\t\targs: { search_value: this.frm.doc.scan_barcode }\n\t\t\t}).then(r => {\n\t\t\t\tconst data = r && r.message;\n\t\t\t\tif (!data || Object.keys(data).length === 0) {\n\t\t\t\t\tfrappe.show_alert({\n\t\t\t\t\t\tmessage: __('Cannot find Item with this Barcode'),\n\t\t\t\t\t\tindicator: 'red'\n\t\t\t\t\t});\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tlet cur_grid = this.frm.fields_dict.items.grid;\n\n\t\t\t\tlet row_to_modify = null;\n\t\t\t\tconst existing_item_row = this.frm.doc.items.find(d => d.item_code === data.item_code);\n\t\t\t\tconst blank_item_row = this.frm.doc.items.find(d => !d.item_code);\n\n\t\t\t\tif (existing_item_row) {\n\t\t\t\t\trow_to_modify = existing_item_row;\n\t\t\t\t} else if (blank_item_row) {\n\t\t\t\t\trow_to_modify = blank_item_row;\n\t\t\t\t}\n\n\t\t\t\tif (!row_to_modify) {\n\t\t\t\t\t// add new row\n\t\t\t\t\trow_to_modify = frappe.model.add_child(this.frm.doc, cur_grid.doctype, 'items');\n\t\t\t\t}\n\n\t\t\t\tshow_description(row_to_modify.idx, row_to_modify.item_code);\n\n\t\t\t\tthis.frm.from_barcode = this.frm.from_barcode ? this.frm.from_barcode + 1 : 1;\n\t\t\t\tfrappe.model.set_value(row_to_modify.doctype, row_to_modify.name, {\n\t\t\t\t\titem_code: data.item_code,\n\t\t\t\t\tqty: (row_to_modify.qty || 0) + 1\n\t\t\t\t});\n\n\t\t\t\t['serial_no', 'batch_no', 'barcode'].forEach(field => {\n\t\t\t\t\tif (data[field] && frappe.meta.has_field(row_to_modify.doctype, field)) {\n\t\t\t\t\t\tlet value = (row_to_modify[field] && field === \"serial_no\") ? row_to_modify[field] + '\\n' + data[field] : data[field];\n\t\t\t\t\t\tfrappe.model.set_value(row_to_modify.doctype,\n\t\t\t\t\t\t\trow_to_modify.name, field, value);\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\t\tscan_barcode_field.set_value('');\n\t\t\t\trefresh_field(\"items\");\n\t\t\t});\n\t\t}\n\t\treturn false;\n\t},\n\n\tapply_default_taxes: function() {\n\t\tvar me = this;\n\t\tvar taxes_and_charges_field = frappe.meta.get_docfield(me.frm.doc.doctype, \"taxes_and_charges\",\n\t\t\tme.frm.doc.name);\n\n\t\tif (!this.frm.doc.taxes_and_charges && this.frm.doc.taxes && this.frm.doc.taxes.length > 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (taxes_and_charges_field) {\n\t\t\treturn frappe.call({\n\t\t\t\tmethod: \"erpnext.controllers.accounts_controller.get_default_taxes_and_charges\",\n\t\t\t\targs: {\n\t\t\t\t\t\"master_doctype\": taxes_and_charges_field.options,\n\t\t\t\t\t\"tax_template\": me.frm.doc.taxes_and_charges || \"\",\n\t\t\t\t\t\"company\": me.frm.doc.company,\n\t\t\t\t\t\"tax_category\": me.frm.doc.tax_category\n\t\t\t\t},\n\t\t\t\tdebounce: 2000,\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tif(!r.exc && r.message) {\n\t\t\t\t\t\tfrappe.run_serially([\n\t\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\t\t// directly set in doc, so as not to call triggers\n\t\t\t\t\t\t\t\tif(r.message.taxes_and_charges) {\n\t\t\t\t\t\t\t\t\tme.frm.doc.taxes_and_charges = r.message.taxes_and_charges;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t// set taxes table\n\t\t\t\t\t\t\t\tif(r.message.taxes) {\n\t\t\t\t\t\t\t\t\tme.frm.set_value(\"taxes\", r.message.taxes);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t() => me.set_dynamic_labels(),\n\t\t\t\t\t\t\t() => me.calculate_taxes_and_totals()\n\t\t\t\t\t\t]);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t},\n\n\tsetup_sms: function() {\n\t\tvar me = this;\n\t\tlet blacklist = ['Purchase Invoice', 'BOM'];\n\t\tif(this.frm.doc.docstatus===1 && !in_list([\"Lost\", \"Stopped\", \"Closed\"], this.frm.doc.status)\n\t\t\t&& !blacklist.includes(this.frm.doctype)) {\n\t\t\tthis.frm.page.add_menu_item(__('Send SMS'), function() { me.send_sms(); });\n\t\t}\n\t},\n\n\tsend_sms: function() {\n\t\tvar sms_man = new erpnext.SMSManager(this.frm.doc);\n\t},\n\n\tbarcode: function(doc, cdt, cdn) {\n\t\tvar d = locals[cdt][cdn];\n\t\tif(d.barcode==\"\" || d.barcode==null) {\n\t\t\t// barcode cleared, remove item\n\t\t\td.item_code = \"\";\n\t\t}\n\n\t\tthis.frm.from_barcode = this.frm.from_barcode ? this.frm.from_barcode + 1 : 1;\n\t\tthis.item_code(doc, cdt, cdn);\n\t},\n\n\titem_code: function(doc, cdt, cdn) {\n\t\tvar me = this;\n\t\tvar item = frappe.get_doc(cdt, cdn);\n\t\tvar update_stock = 0, show_batch_dialog = 0;\n\t\tif(['Sales Invoice'].includes(this.frm.doc.doctype)) {\n\t\t\tupdate_stock = cint(me.frm.doc.update_stock);\n\t\t\tshow_batch_dialog = update_stock;\n\n\t\t} else if((this.frm.doc.doctype === 'Purchase Receipt' && me.frm.doc.is_return) ||\n\t\t\tthis.frm.doc.doctype === 'Delivery Note') {\n\t\t\tshow_batch_dialog = 1;\n\t\t}\n\t\t// clear barcode if setting item (else barcode will take priority)\n\t\tif (this.frm.from_barcode == 0) {\n\t\t\titem.barcode = null;\n\t\t}\n\t\tthis.frm.from_barcode = this.frm.from_barcode - 1 >= 0 ? this.frm.from_barcode - 1 : 0;\n\n\t\tif(item.item_code || item.barcode || item.serial_no) {\n\t\t\tif(!this.validate_company_and_party()) {\n\t\t\t\tthis.frm.fields_dict[\"items\"].grid.grid_rows[item.idx - 1].remove();\n\t\t\t} else {\n\t\t\t\treturn this.frm.call({\n\t\t\t\t\tmethod: \"erpnext.stock.get_item_details.get_item_details\",\n\t\t\t\t\tchild: item,\n\t\t\t\t\targs: {\n\t\t\t\t\t\tdoc: me.frm.doc,\n\t\t\t\t\t\targs: {\n\t\t\t\t\t\t\titem_code: item.item_code,\n\t\t\t\t\t\t\tbarcode: item.barcode,\n\t\t\t\t\t\t\tserial_no: item.serial_no,\n\t\t\t\t\t\t\tbatch_no: item.batch_no,\n\t\t\t\t\t\t\tset_warehouse: me.frm.doc.set_warehouse,\n\t\t\t\t\t\t\twarehouse: item.warehouse,\n\t\t\t\t\t\t\tcustomer: me.frm.doc.customer || me.frm.doc.party_name,\n\t\t\t\t\t\t\tquotation_to: me.frm.doc.quotation_to,\n\t\t\t\t\t\t\tsupplier: me.frm.doc.supplier,\n\t\t\t\t\t\t\tcurrency: me.frm.doc.currency,\n\t\t\t\t\t\t\tupdate_stock: update_stock,\n\t\t\t\t\t\t\tconversion_rate: me.frm.doc.conversion_rate,\n\t\t\t\t\t\t\tprice_list: me.frm.doc.selling_price_list || me.frm.doc.buying_price_list,\n\t\t\t\t\t\t\tprice_list_currency: me.frm.doc.price_list_currency,\n\t\t\t\t\t\t\tplc_conversion_rate: me.frm.doc.plc_conversion_rate,\n\t\t\t\t\t\t\tcompany: me.frm.doc.company,\n\t\t\t\t\t\t\torder_type: me.frm.doc.order_type,\n\t\t\t\t\t\t\tis_pos: cint(me.frm.doc.is_pos),\n\t\t\t\t\t\t\tis_return: cint(me.frm.doc.is_return),\n\t\t\t\t\t\t\tis_subcontracted: me.frm.doc.is_subcontracted,\n\t\t\t\t\t\t\ttransaction_date: me.frm.doc.transaction_date || me.frm.doc.posting_date,\n\t\t\t\t\t\t\tignore_pricing_rule: me.frm.doc.ignore_pricing_rule,\n\t\t\t\t\t\t\tdoctype: me.frm.doc.doctype,\n\t\t\t\t\t\t\tname: me.frm.doc.name,\n\t\t\t\t\t\t\tproject: item.project || me.frm.doc.project,\n\t\t\t\t\t\t\tqty: item.qty || 1,\n\t\t\t\t\t\t\tstock_qty: item.stock_qty,\n\t\t\t\t\t\t\tconversion_factor: item.conversion_factor,\n\t\t\t\t\t\t\tweight_per_unit: item.weight_per_unit,\n\t\t\t\t\t\t\tweight_uom: item.weight_uom,\n\t\t\t\t\t\t\tmanufacturer: item.manufacturer,\n\t\t\t\t\t\t\tstock_uom: item.stock_uom,\n\t\t\t\t\t\t\tpos_profile: cint(me.frm.doc.is_pos) ? me.frm.doc.pos_profile : '',\n\t\t\t\t\t\t\tcost_center: item.cost_center,\n\t\t\t\t\t\t\ttax_category: me.frm.doc.tax_category,\n\t\t\t\t\t\t\titem_tax_template: item.item_tax_template,\n\t\t\t\t\t\t\tchild_docname: item.name\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\n\t\t\t\t\tcallback: function(r) {\n\t\t\t\t\t\tif(!r.exc) {\n\t\t\t\t\t\t\tfrappe.run_serially([\n\t\t\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\t\t\tvar d = locals[cdt][cdn];\n\t\t\t\t\t\t\t\t\tme.add_taxes_from_item_tax_template(d.item_tax_rate);\n\t\t\t\t\t\t\t\t\tif (d.free_item_data) {\n\t\t\t\t\t\t\t\t\t\tme.apply_product_discount(d);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\t\t\t// for internal customer instead of pricing rule directly apply valuation rate on item\n\t\t\t\t\t\t\t\t\tif (me.frm.doc.is_internal_customer || me.frm.doc.is_internal_supplier) {\n\t\t\t\t\t\t\t\t\t\tme.get_incoming_rate(item, me.frm.posting_date, me.frm.posting_time,\n\t\t\t\t\t\t\t\t\t\t\tme.frm.doc.doctype, me.frm.doc.company);\n\t\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\t\tme.frm.script_manager.trigger(\"price_list_rate\", cdt, cdn);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\t\t\tif (me.frm.doc.is_internal_customer || me.frm.doc.is_internal_supplier) {\n\t\t\t\t\t\t\t\t\t\tme.calculate_taxes_and_totals();\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t() => me.toggle_conversion_factor(item),\n\t\t\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\t\t\tif (show_batch_dialog)\n\t\t\t\t\t\t\t\t\t\treturn frappe.db.get_value(\"Item\", item.item_code, [\"has_batch_no\", \"has_serial_no\"])\n\t\t\t\t\t\t\t\t\t\t\t.then((r) => {\n\t\t\t\t\t\t\t\t\t\t\t\tif (r.message &&\n\t\t\t\t\t\t\t\t\t\t\t\t\t(r.message.has_batch_no || r.message.has_serial_no)) {\n\t\t\t\t\t\t\t\t\t\t\t\t\tfrappe.flags.hide_serial_batch_dialog = false;\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\t\t\t// check if batch serial selector is disabled or not\n\t\t\t\t\t\t\t\t\tif (show_batch_dialog && !frappe.flags.hide_serial_batch_dialog)\n\t\t\t\t\t\t\t\t\t\treturn frappe.db.get_single_value('Stock Settings', 'disable_serial_no_and_batch_selector')\n\t\t\t\t\t\t\t\t\t\t\t.then((value) => {\n\t\t\t\t\t\t\t\t\t\t\t\tif (value) {\n\t\t\t\t\t\t\t\t\t\t\t\t\tfrappe.flags.hide_serial_batch_dialog = true;\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\t\t\tif(show_batch_dialog && !frappe.flags.hide_serial_batch_dialog) {\n\t\t\t\t\t\t\t\t\t\tvar d = locals[cdt][cdn];\n\t\t\t\t\t\t\t\t\t\t$.each(r.message, function(k, v) {\n\t\t\t\t\t\t\t\t\t\t\tif(!d[k]) d[k] = v;\n\t\t\t\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\t\t\t\tif (d.has_batch_no && d.has_serial_no) {\n\t\t\t\t\t\t\t\t\t\t\td.batch_no = undefined;\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\terpnext.show_serial_batch_selector(me.frm, d, (item) => {\n\t\t\t\t\t\t\t\t\t\t\tme.frm.script_manager.trigger('qty', item.doctype, item.name);\n\t\t\t\t\t\t\t\t\t\t\tif (!me.frm.doc.set_warehouse)\n\t\t\t\t\t\t\t\t\t\t\t\tme.frm.script_manager.trigger('warehouse', item.doctype, item.name);\n\t\t\t\t\t\t\t\t\t\t}, undefined, !frappe.flags.hide_serial_batch_dialog);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t() => me.conversion_factor(doc, cdt, cdn, true),\n\t\t\t\t\t\t\t\t() => me.remove_pricing_rule(item),\n\t\t\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\t\t\tif (item.apply_rule_on_other_items) {\n\t\t\t\t\t\t\t\t\t\tlet key = item.name;\n\t\t\t\t\t\t\t\t\t\tme.apply_rule_on_other_items({key: item});\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\t\t\tconst d = locals[cdt][cdn];\n\t\t\t\t\t\t\t\t\tif (d.is_down_payment_item) {\n\t\t\t\t\t\t\t\t\t\tme.frm.script_manager.trigger('is_down_payment_item', d.doctype, d.name);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t]);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t},\n\n\tprice_list_rate: function(doc, cdt, cdn) {\n\t\tvar item = frappe.get_doc(cdt, cdn);\n\t\tfrappe.model.round_floats_in(item, [\"price_list_rate\", \"discount_percentage\"]);\n\n\t\t// check if child doctype is Sales Order Item/Qutation Item and calculate the rate\n\t\tif (in_list([\"Quotation Item\", \"Sales Order Item\", \"Delivery Note Item\", \"Sales Invoice Item\", \"POS Invoice Item\", \"Purchase Invoice Item\", \"Purchase Order Item\", \"Purchase Receipt Item\"]), cdt)\n\t\t\tthis.apply_pricing_rule_on_item(item);\n\t\telse\n\t\t\titem.rate = flt(item.price_list_rate * (1 - item.discount_percentage / 100.0),\n\t\t\t\tprecision(\"rate\", item));\n\n\t\tthis.calculate_taxes_and_totals();\n\t},\n\n\tmargin_rate_or_amount: function(doc, cdt, cdn) {\n\t\t// calculated the revised total margin and rate on margin rate changes\n\t\tlet item = frappe.get_doc(cdt, cdn);\n\t\tthis.apply_pricing_rule_on_item(item);\n\t\tthis.calculate_taxes_and_totals();\n\t\tcur_frm.refresh_fields();\n\t},\n\n\tmargin_type: function(doc, cdt, cdn) {\n\t\t// calculate the revised total margin and rate on margin type changes\n\t\tlet item = frappe.get_doc(cdt, cdn);\n\t\tif (!item.margin_type) {\n\t\t\tfrappe.model.set_value(cdt, cdn, \"margin_rate_or_amount\", 0);\n\t\t} else {\n\t\t\tthis.apply_pricing_rule_on_item(item, doc, cdt, cdn);\n\t\t\tthis.calculate_taxes_and_totals();\n\t\t\tcur_frm.refresh_fields();\n\t\t}\n\t},\n\n\tget_incoming_rate: function(item, posting_date, posting_time, voucher_type, company) {\n\n\t\tlet item_args = {\n\t\t\t'item_code': item.item_code,\n\t\t\t'warehouse': in_list('Purchase Receipt', 'Purchase Invoice') ? item.from_warehouse : item.warehouse,\n\t\t\t'posting_date': posting_date,\n\t\t\t'posting_time': posting_time,\n\t\t\t'qty': item.qty * item.conversion_factor,\n\t\t\t'serial_no': item.serial_no,\n\t\t\t'voucher_type': voucher_type,\n\t\t\t'company': company,\n\t\t\t'allow_zero_valuation_rate': item.allow_zero_valuation_rate\n\t\t}\n\n\t\tfrappe.call({\n\t\t\tmethod: 'erpnext.stock.utils.get_incoming_rate',\n\t\t\targs: {\n\t\t\t\targs: item_args\n\t\t\t},\n\t\t\tcallback: function(r) {\n\t\t\t\tfrappe.model.set_value(item.doctype, item.name, 'rate', r.message * item.conversion_factor);\n\t\t\t}\n\t\t});\n\t},\n\n\tadd_taxes_from_item_tax_template: function(item_tax_map) {\n\t\tlet me = this;\n\n\t\tif(item_tax_map && cint(frappe.defaults.get_default(\"add_taxes_from_item_tax_template\"))) {\n\t\t\tif(typeof (item_tax_map) == \"string\") {\n\t\t\t\titem_tax_map = JSON.parse(item_tax_map);\n\t\t\t}\n\n\t\t\titem_tax_map.map(tax => {\n\t\t\t\tlet found = (me.frm.doc.taxes || []).find(d => d.account_head === tax.account);\n\t\t\t\tif(!found) {\n\t\t\t\t\tlet child = frappe.model.add_child(me.frm.doc, \"taxes\");\n\t\t\t\t\tchild.charge_type = \"On Net Total\";\n\t\t\t\t\tchild.account_head = tax.account;\n\t\t\t\t\tchild.description = tax.description;\n\t\t\t\t\tchild.rate = 0;\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t},\n\n\tserial_no: function(doc, cdt, cdn) {\n\t\tvar me = this;\n\t\tvar item = frappe.get_doc(cdt, cdn);\n\n\t\tif (item && item.serial_no) {\n\t\t\tif (!item.item_code) {\n\t\t\t\tthis.frm.trigger(\"item_code\", cdt, cdn);\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// Replacing all occurences of comma with carriage return\n\t\t\t\titem.serial_no = item.serial_no.replace(/,/g, '\\n');\n\t\t\t\titem.conversion_factor = item.conversion_factor || 1;\n\t\t\t\trefresh_field(\"serial_no\", item.name, item.parentfield);\n\t\t\t\tif (!doc.is_return && cint(frappe.user_defaults.set_qty_in_transactions_based_on_serial_no_input)) {\n\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\tme.update_qty(cdt, cdn);\n\t\t\t\t\t}, 10000);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\n\tupdate_qty: function(cdt, cdn) {\n\t\tvar valid_serial_nos = [];\n\t\tvar serialnos = [];\n\t\tvar item = frappe.get_doc(cdt, cdn);\n\t\tserialnos = item.serial_no.split(\"\\n\");\n\t\tfor (var i = 0; i < serialnos.length; i++) {\n\t\t\tif (serialnos[i] != \"\") {\n\t\t\t\tvalid_serial_nos.push(serialnos[i]);\n\t\t\t}\n\t\t}\n\t\tfrappe.model.set_value(item.doctype, item.name,\n\t\t\t\"qty\", valid_serial_nos.length / item.conversion_factor);\n\t\tfrappe.model.set_value(item.doctype, item.name, \"stock_qty\", valid_serial_nos.length);\n\t},\n\n\tvalidate: function() {\n\t\tthis.calculate_taxes_and_totals(false);\n\t},\n\n\tupdate_stock: function() {\n\t\tthis.frm.trigger('set_default_internal_warehouse');\n\t},\n\n\tset_default_internal_warehouse: function() {\n\t\tlet me = this;\n\t\tif ((this.frm.doc.doctype === 'Sales Invoice' && me.frm.doc.update_stock)\n\t\t\t|| this.frm.doc.doctype == 'Delivery Note') {\n\t\t\tif (this.frm.doc.is_internal_customer && this.frm.doc.company === this.frm.doc.represents_company) {\n\t\t\t\tfrappe.db.get_value('Company', this.frm.doc.company, 'default_in_transit_warehouse', function(value) {\n\t\t\t\t\tme.frm.set_value('set_target_warehouse', value.default_in_transit_warehouse);\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tif ((this.frm.doc.doctype === 'Purchase Invoice' && me.frm.doc.update_stock)\n\t\t\t|| this.frm.doc.doctype == 'Purchase Receipt') {\n\t\t\tif (this.frm.doc.is_internal_supplier && this.frm.doc.company === this.frm.doc.represents_company) {\n\t\t\t\tfrappe.db.get_value('Company', this.frm.doc.company, 'default_in_transit_warehouse', function(value) {\n\t\t\t\t\tme.frm.set_value('set_from_warehouse', value.default_in_transit_warehouse);\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t},\n\n\tcompany: function() {\n\t\tvar me = this;\n\t\tvar set_pricing = function() {\n\t\t\tif(me.frm.doc.company && me.frm.fields_dict.currency) {\n\t\t\t\tvar company_currency = me.get_company_currency();\n\t\t\t\tvar company_doc = frappe.get_doc(\":Company\", me.frm.doc.company);\n\n\t\t\t\tif (!me.frm.doc.currency) {\n\t\t\t\t\tme.frm.set_value(\"currency\", company_currency);\n\t\t\t\t}\n\n\t\t\t\tif (me.frm.doc.currency == company_currency) {\n\t\t\t\t\tme.frm.set_value(\"conversion_rate\", 1.0);\n\t\t\t\t}\n\t\t\t\tif (me.frm.doc.price_list_currency == company_currency) {\n\t\t\t\t\tme.frm.set_value('plc_conversion_rate', 1.0);\n\t\t\t\t}\n\t\t\t\tif (company_doc.default_letter_head) {\n\t\t\t\t\tif(me.frm.fields_dict.letter_head) {\n\t\t\t\t\t\tme.frm.set_value(\"letter_head\", company_doc.default_letter_head);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tlet selling_doctypes_for_tc = [\"Sales Invoice\", \"Quotation\", \"Sales Order\", \"Delivery Note\"];\n\t\t\t\tif (company_doc.default_selling_terms && frappe.meta.has_field(me.frm.doc.doctype, \"tc_name\") &&\n\t\t\t\tselling_doctypes_for_tc.indexOf(me.frm.doc.doctype) != -1) {\n\t\t\t\t\tme.frm.set_value(\"tc_name\", company_doc.default_selling_terms);\n\t\t\t\t}\n\t\t\t\tlet buying_doctypes_for_tc = [\"Request for Quotation\", \"Supplier Quotation\", \"Purchase Order\",\n\t\t\t\t\t\"Material Request\", \"Purchase Receipt\"];\n\t\t\t\t// Purchase Invoice is excluded as per issue #3345\n\t\t\t\tif (company_doc.default_buying_terms && frappe.meta.has_field(me.frm.doc.doctype, \"tc_name\") &&\n\t\t\t\tbuying_doctypes_for_tc.indexOf(me.frm.doc.doctype) != -1) {\n\t\t\t\t\tme.frm.set_value(\"tc_name\", company_doc.default_buying_terms);\n\t\t\t\t}\n\n\t\t\t\tfrappe.run_serially([\n\t\t\t\t\t() => me.frm.script_manager.trigger(\"currency\"),\n\t\t\t\t\t() => me.update_item_tax_map(),\n\t\t\t\t\t() => me.apply_default_taxes(),\n\t\t\t\t\t() => me.apply_pricing_rule()\n\t\t\t\t]);\n\t\t\t}\n\t\t}\n\n\t\tvar set_party_account = function(set_pricing) {\n\t\t\tif (in_list([\"Sales Invoice\", \"Purchase Invoice\"], me.frm.doc.doctype)) {\n\t\t\t\tif(me.frm.doc.doctype==\"Sales Invoice\") {\n\t\t\t\t\tvar party_type = \"Customer\";\n\t\t\t\t\tvar party_account_field = 'debit_to';\n\t\t\t\t} else {\n\t\t\t\t\tvar party_type = \"Supplier\";\n\t\t\t\t\tvar party_account_field = 'credit_to';\n\t\t\t\t}\n\n\t\t\t\tvar party = me.frm.doc[frappe.model.scrub(party_type)];\n\t\t\t\tif(party && me.frm.doc.company) {\n\t\t\t\t\treturn frappe.call({\n\t\t\t\t\t\tmethod: \"erpnext.accounts.party.get_party_account\",\n\t\t\t\t\t\targs: {\n\t\t\t\t\t\t\tcompany: me.frm.doc.company,\n\t\t\t\t\t\t\tparty_type: party_type,\n\t\t\t\t\t\t\tparty: party\n\t\t\t\t\t\t},\n\t\t\t\t\t\tcallback: function(r) {\n\t\t\t\t\t\t\tif(!r.exc && r.message) {\n\t\t\t\t\t\t\t\tme.frm.set_value(party_account_field, r.message);\n\t\t\t\t\t\t\t\tset_pricing();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tset_pricing();\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tset_pricing();\n\t\t\t}\n\n\t\t}\n\n\t\tif (this.frm.doc.posting_date) var date = this.frm.doc.posting_date;\n\t\telse var date = this.frm.doc.transaction_date;\n\n\t\tif (frappe.meta.get_docfield(this.frm.doctype, \"shipping_address\") &&\n\t\t\tin_list(['Purchase Order', 'Purchase Receipt', 'Purchase Invoice'], this.frm.doctype)) {\n\t\t\terpnext.utils.get_shipping_address(this.frm, function(){\n\t\t\t\tset_party_account(set_pricing);\n\t\t\t});\n\n\t\t\t// Get default company billing address in Purchase Invoice, Order and Receipt\n\t\t\tif (this.frm.doc.company) {\n\t\t\t\tfrappe.call({\n\t\t\t\t\t'method': 'frappe.contacts.doctype.address.address.get_default_address',\n\t\t\t\t\t'args': {\n\t\t\t\t\t\t'doctype': 'Company',\n\t\t\t\t\t\t'name': this.frm.doc.company\n\t\t\t\t\t},\n\t\t\t\t\t'callback': function(r) {\n\t\t\t\t\t\tme.frm.set_value('billing_address', r.message);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t} else {\n\t\t\tset_party_account(set_pricing);\n\t\t}\n\n\t\tif(this.frm.doc.company) {\n\t\t\terpnext.last_selected_company = this.frm.doc.company;\n\t\t}\n\t},\n\n\ttransaction_date: function() {\n\t\tif (this.frm.doc.transaction_date) {\n\t\t\tthis.frm.transaction_date = this.frm.doc.transaction_date;\n\t\t\tfrappe.ui.form.trigger(this.frm.doc.doctype, \"currency\");\n\t\t}\n\t},\n\n\tposting_date: function() {\n\t\tvar me = this;\n\t\tif (this.frm.doc.posting_date) {\n\t\t\tthis.frm.posting_date = this.frm.doc.posting_date;\n\n\t\t\tif ((this.frm.doc.doctype == \"Sales Invoice\" && this.frm.doc.customer) ||\n\t\t\t\t(this.frm.doc.doctype == \"Purchase Invoice\" && this.frm.doc.supplier)) {\n\t\t\t\treturn frappe.call({\n\t\t\t\t\tmethod: \"erpnext.accounts.party.get_due_date\",\n\t\t\t\t\targs: {\n\t\t\t\t\t\t\"posting_date\": me.frm.doc.posting_date,\n\t\t\t\t\t\t\"party_type\": me.frm.doc.doctype == \"Sales Invoice\" ? \"Customer\" : \"Supplier\",\n\t\t\t\t\t\t\"bill_date\": me.frm.doc.bill_date,\n\t\t\t\t\t\t\"party\": me.frm.doc.doctype == \"Sales Invoice\" ? me.frm.doc.customer : me.frm.doc.supplier,\n\t\t\t\t\t\t\"company\": me.frm.doc.company\n\t\t\t\t\t},\n\t\t\t\t\tcallback: function(r, rt) {\n\t\t\t\t\t\tif(r.message) {\n\t\t\t\t\t\t\tme.frm.doc.due_date = r.message;\n\t\t\t\t\t\t\trefresh_field(\"due_date\");\n\t\t\t\t\t\t\tfrappe.ui.form.trigger(me.frm.doc.doctype, \"currency\");\n\t\t\t\t\t\t\tme.recalculate_terms();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t} else {\n\t\t\t\tfrappe.ui.form.trigger(me.frm.doc.doctype, \"currency\");\n\t\t\t}\n\t\t}\n\t},\n\n\tdue_date: function() {\n\t\t// due_date is to be changed, payment terms template and/or payment schedule must\n\t\t// be removed as due_date is automatically changed based on payment terms\n\t\tif (this.frm.doc.due_date && !this.frm.updating_party_details && !this.frm.doc.is_pos) {\n\t\t\tif (this.frm.doc.payment_terms_template ||\n\t\t\t\t(this.frm.doc.payment_schedule && this.frm.doc.payment_schedule.length)) {\n\t\t\t\tvar message1 = \"\";\n\t\t\t\tvar message2 = \"\";\n\t\t\t\tvar final_message = __(\"Please clear the\");\n\n\t\t\t\tif (this.frm.doc.payment_terms_template) {\n\t\t\t\t\tmessage1 = __(\"selected Payment Terms Template\");\n\t\t\t\t\tfinal_message = final_message + \" \" + message1;\n\t\t\t\t}\n\n\t\t\t\tif ((this.frm.doc.payment_schedule || []).length) {\n\t\t\t\t\tmessage2 = __(\"Payment Schedule Table\");\n\t\t\t\t\tif (message1.length !== 0) message2 = __(\"and\") + \" \" + message2;\n\t\t\t\t\tfinal_message = final_message + \" \" + message2;\n\t\t\t\t}\n\t\t\t\tfrappe.msgprint(final_message);\n\t\t\t}\n\t\t}\n\t},\n\n\tbill_date: function() {\n\t\tthis.posting_date();\n\t},\n\n\trecalculate_terms: function() {\n\t\tconst doc = this.frm.doc;\n\t\tif (doc.payment_terms_template) {\n\t\t\tthis.payment_terms_template();\n\t\t} else if (doc.payment_schedule) {\n\t\t\tconst me = this;\n\t\t\tdoc.payment_schedule.forEach(\n\t\t\t\tfunction(term) {\n\t\t\t\t\tif (term.payment_term) {\n\t\t\t\t\t\tme.payment_term(doc, term.doctype, term.name);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tfrappe.model.set_value(\n\t\t\t\t\t\t\tterm.doctype, term.name, 'due_date',\n\t\t\t\t\t\t\tdoc.posting_date || doc.transaction_date\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t);\n\t\t}\n\t},\n\n\tget_company_currency: function() {\n\t\treturn erpnext.get_currency(this.frm.doc.company);\n\t},\n\n\tcontact_person: function() {\n\t\terpnext.utils.get_contact_details(this.frm);\n\t},\n\n\tcurrency: function() {\n\t\t/* manqala 19/09/2016: let the translation date be whichever of the transaction_date or posting_date is available */\n\t\tvar transaction_date = this.frm.doc.transaction_date || this.frm.doc.posting_date;\n\t\t/* end manqala */\n\t\tvar me = this;\n\t\tthis.set_dynamic_labels();\n\t\tvar company_currency = this.get_company_currency();\n\t\t// Added `ignore_pricing_rule` to determine if document is loading after mapping from another doc\n\t\tif(this.frm.doc.currency && this.frm.doc.currency !== company_currency\n\t\t\t\t&& !this.frm.doc.ignore_pricing_rule) {\n\n\t\t\tthis.get_exchange_rate(transaction_date, this.frm.doc.currency, company_currency,\n\t\t\t\tfunction(exchange_rate) {\n\t\t\t\t\tif(exchange_rate != me.frm.doc.conversion_rate) {\n\t\t\t\t\t\tme.set_margin_amount_based_on_currency(exchange_rate);\n\t\t\t\t\t\tme.set_actual_charges_based_on_currency(exchange_rate);\n\t\t\t\t\t\tme.frm.set_value(\"conversion_rate\", exchange_rate);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t} else {\n\t\t\tthis.conversion_rate();\n\t\t}\n\t},\n\n\tconversion_rate: function() {\n\t\tconst me = this.frm;\n\t\tif(this.frm.doc.currency === this.get_company_currency()) {\n\t\t\tthis.frm.set_value(\"conversion_rate\", 1.0);\n\t\t}\n\t\tif(this.frm.doc.currency === this.frm.doc.price_list_currency &&\n\t\t\tthis.frm.doc.plc_conversion_rate !== this.frm.doc.conversion_rate) {\n\t\t\tthis.frm.set_value(\"plc_conversion_rate\", this.frm.doc.conversion_rate);\n\t\t}\n\n\t\tif(flt(this.frm.doc.conversion_rate)>0.0) {\n\t\t\tif(this.frm.doc.ignore_pricing_rule) {\n\t\t\t\tthis.calculate_taxes_and_totals();\n\t\t\t} else if (!this.in_apply_price_list){\n\t\t\t\tthis.apply_price_list();\n\t\t\t}\n\n\t\t}\n\t\t// Make read only if Accounts Settings doesn't allow stale rates\n\t\tthis.frm.set_df_property(\"conversion_rate\", \"read_only\", erpnext.stale_rate_allowed() ? 0 : 1);\n\t},\n\n\tshipping_rule: function() {\n\t\tvar me = this;\n\t\tif(this.frm.doc.shipping_rule) {\n\t\t\treturn this.frm.call({\n\t\t\t\tdoc: this.frm.doc,\n\t\t\t\tmethod: \"apply_shipping_rule\",\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tif(!r.exc) {\n\t\t\t\t\t\tme.calculate_taxes_and_totals();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}).fail(() => this.frm.set_value('shipping_rule', ''));\n\t\t}\n\t\telse {\n\t\t\tme.calculate_taxes_and_totals();\n\t\t}\n\t},\n\n\tset_margin_amount_based_on_currency: function(exchange_rate) {\n\t\tif (in_list([\"Quotation\", \"Sales Order\", \"Delivery Note\", \"Sales Invoice\", \"Purchase Invoice\", \"Purchase Order\", \"Purchase Receipt\"]), this.frm.doc.doctype) {\n\t\t\tvar me = this;\n\t\t\t$.each(this.frm.doc.items || [], function(i, d) {\n\t\t\t\tif(d.margin_type == \"Amount\") {\n\t\t\t\t\tfrappe.model.set_value(d.doctype, d.name, \"margin_rate_or_amount\",\n\t\t\t\t\t\tflt(d.margin_rate_or_amount) / flt(exchange_rate));\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t},\n\n\tset_actual_charges_based_on_currency: function(exchange_rate) {\n\t\tvar me = this;\n\t\t$.each(this.frm.doc.taxes || [], function(i, d) {\n\t\t\tif(d.charge_type == \"Actual\") {\n\t\t\t\tfrappe.model.set_value(d.doctype, d.name, \"tax_amount\",\n\t\t\t\t\tflt(d.tax_amount) / flt(exchange_rate));\n\t\t\t}\n\t\t});\n\t},\n\n\tget_exchange_rate: function(transaction_date, from_currency, to_currency, callback) {\n\t\tvar args;\n\t\tif ([\"Quotation\", \"Sales Order\", \"Delivery Note\", \"Sales Invoice\"].includes(this.frm.doctype)) {\n\t\t\targs = \"for_selling\";\n\t\t}\n\t\telse if ([\"Purchase Order\", \"Purchase Receipt\", \"Purchase Invoice\"].includes(this.frm.doctype)) {\n\t\t\targs = \"for_buying\";\n\t\t}\n\n\t\tif (!transaction_date || !from_currency || !to_currency) return;\n\t\treturn frappe.call({\n\t\t\tmethod: \"erpnext.setup.utils.get_exchange_rate\",\n\t\t\targs: {\n\t\t\t\ttransaction_date: transaction_date,\n\t\t\t\tfrom_currency: from_currency,\n\t\t\t\tto_currency: to_currency,\n\t\t\t\targs: args\n\t\t\t},\n\t\t\tfreeze: true,\n\t\t\tfreeze_message: __(\"Fetching exchange rates ...\"),\n\t\t\tcallback: function(r) {\n\t\t\t\tcallback(flt(r.message));\n\t\t\t}\n\t\t});\n\t},\n\n\tprice_list_currency: function() {\n\t\tvar me=this;\n\t\tthis.set_dynamic_labels();\n\n\t\tvar company_currency = this.get_company_currency();\n\t\t// Added `ignore_pricing_rule` to determine if document is loading after mapping from another doc\n\t\tif(this.frm.doc.price_list_currency !== company_currency  && !this.frm.doc.ignore_pricing_rule) {\n\t\t\tthis.get_exchange_rate(this.frm.doc.posting_date, this.frm.doc.price_list_currency, company_currency,\n\t\t\t\tfunction(exchange_rate) {\n\t\t\t\t\tme.frm.set_value(\"plc_conversion_rate\", exchange_rate);\n\t\t\t\t});\n\t\t} else {\n\t\t\tthis.plc_conversion_rate();\n\t\t}\n\t},\n\n\tplc_conversion_rate: function() {\n\t\tif(this.frm.doc.price_list_currency === this.get_company_currency()) {\n\t\t\tthis.frm.set_value(\"plc_conversion_rate\", 1.0);\n\t\t} else if(this.frm.doc.price_list_currency === this.frm.doc.currency\n\t\t\t&& this.frm.doc.plc_conversion_rate && cint(this.frm.doc.plc_conversion_rate) != 1 &&\n\t\t\tcint(this.frm.doc.plc_conversion_rate) != cint(this.frm.doc.conversion_rate)) {\n\t\t\tthis.frm.set_value(\"conversion_rate\", this.frm.doc.plc_conversion_rate);\n\t\t}\n\n\t\tif(!this.in_apply_price_list) {\n\t\t\tthis.apply_price_list(null, true);\n\t\t}\n\t},\n\n\tuom: function(doc, cdt, cdn) {\n\t\tvar me = this;\n\t\tvar item = frappe.get_doc(cdt, cdn);\n\t\tif(item.item_code && item.uom) {\n\t\t\treturn this.frm.call({\n\t\t\t\tmethod: \"erpnext.stock.get_item_details.get_conversion_factor\",\n\t\t\t\tchild: item,\n\t\t\t\targs: {\n\t\t\t\t\titem_code: item.item_code,\n\t\t\t\t\tuom: item.uom\n\t\t\t\t},\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tif(!r.exc) {\n\t\t\t\t\t\tme.conversion_factor(me.frm.doc, cdt, cdn);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\tme.calculate_stock_uom_rate(doc, cdt, cdn);\n\t},\n\n\tconversion_factor: function(doc, cdt, cdn, dont_fetch_price_list_rate) {\n\t\tif(frappe.meta.get_docfield(cdt, \"stock_qty\", cdn)) {\n\t\t\tvar item = frappe.get_doc(cdt, cdn);\n\t\t\tfrappe.model.round_floats_in(item, [\"qty\", \"conversion_factor\"]);\n\t\t\titem.stock_qty = flt(item.qty * item.conversion_factor, precision(\"stock_qty\", item));\n\t\t\trefresh_field(\"stock_qty\", item.name, item.parentfield);\n\t\t\tthis.toggle_conversion_factor(item);\n\n\t\t\tif(doc.doctype != \"Material Request\") {\n\t\t\t\titem.total_weight = flt(item.stock_qty * item.weight_per_unit);\n\t\t\t\trefresh_field(\"total_weight\", item.name, item.parentfield);\n\t\t\t\tthis.calculate_net_weight();\n\t\t\t}\n\n\t\t\t// for handling customization not to fetch price list rate\n\t\t\tif(frappe.flags.dont_fetch_price_list_rate) {\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\tif (!dont_fetch_price_list_rate &&\n\t\t\t\tfrappe.meta.has_field(doc.doctype, \"price_list_currency\")) {\n\t\t\t\tthis.apply_price_list(item, true);\n\t\t\t}\n\t\t\tthis.calculate_stock_uom_rate(doc, cdt, cdn);\n\t\t}\n\t},\n\n\tbatch_no: function(doc, cdt, cdn) {\n\t\tlet item = frappe.get_doc(cdt, cdn);\n\t\tthis.apply_price_list(item, true);\n\t},\n\n\ttoggle_conversion_factor: function(item) {\n\t\t// toggle read only property for conversion factor field if the uom and stock uom are same\n\t\tif(this.frm.get_field('items').grid.fields_map.conversion_factor) {\n\t\t\tthis.frm.fields_dict.items.grid.toggle_enable(\"conversion_factor\",\n\t\t\t\t((item.uom != item.stock_uom) && !frappe.meta.get_docfield(cur_frm.fields_dict.items.grid.doctype, \"conversion_factor\").read_only)? true: false);\n\t\t}\n\n\t},\n\n\tqty: function(doc, cdt, cdn) {\n\t\tlet item = frappe.get_doc(cdt, cdn);\n\t\tthis.conversion_factor(doc, cdt, cdn, true);\n\t\tthis.calculate_stock_uom_rate(doc, cdt, cdn);\n\t\tthis.apply_pricing_rule(item, true);\n\t},\n\n\tcalculate_stock_uom_rate: function(doc, cdt, cdn) {\n\t\tlet item = frappe.get_doc(cdt, cdn);\n\t\titem.stock_uom_rate = flt(item.rate)/flt(item.conversion_factor);\t\n\t\trefresh_field(\"stock_uom_rate\", item.name, item.parentfield);\n\t},\n\n\tservice_stop_date: function(frm, cdt, cdn) {\n\t\tvar child = locals[cdt][cdn];\n\n\t\tif(child.service_stop_date) {\n\t\t\tlet start_date = Date.parse(child.service_start_date);\n\t\t\tlet end_date = Date.parse(child.service_end_date);\n\t\t\tlet stop_date = Date.parse(child.service_stop_date);\n\n\t\t\tif(stop_date < start_date) {\n\t\t\t\tfrappe.model.set_value(cdt, cdn, \"service_stop_date\", \"\");\n\t\t\t\tfrappe.throw(__(\"Service Stop Date cannot be before Service Start Date\"));\n\t\t\t} else if (stop_date > end_date) {\n\t\t\t\tfrappe.model.set_value(cdt, cdn, \"service_stop_date\", \"\");\n\t\t\t\tfrappe.throw(__(\"Service Stop Date cannot be after Service End Date\"));\n\t\t\t}\n\t\t}\n\t},\n\n\tservice_start_date: function(frm, cdt, cdn) {\n\t\tvar child = locals[cdt][cdn];\n\n\t\tif(child.service_start_date) {\n\t\t\tfrappe.call({\n\t\t\t\t\"method\": \"erpnext.stock.get_item_details.calculate_service_end_date\",\n\t\t\t\targs: {\"args\": child},\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tfrappe.model.set_value(cdt, cdn, \"service_end_date\", r.message.service_end_date);\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\t},\n\n\tcalculate_net_weight: function(){\n\t\t/* Calculate Total Net Weight then further applied shipping rule to calculate shipping charges.*/\n\t\tvar me = this;\n\t\tthis.frm.doc.total_net_weight= 0.0;\n\n\t\t$.each(this.frm.doc[\"items\"] || [], function(i, item) {\n\t\t\tme.frm.doc.total_net_weight += flt(item.total_weight);\n\t\t});\n\t\trefresh_field(\"total_net_weight\");\n\t\tthis.shipping_rule();\n\t},\n\n\tset_dynamic_labels: function() {\n\t\t// What TODO? should we make price list system non-mandatory?\n\t\tthis.frm.toggle_reqd(\"plc_conversion_rate\",\n\t\t\t!!(this.frm.doc.price_list_name && this.frm.doc.price_list_currency));\n\n\t\tvar company_currency = this.get_company_currency();\n\t\tthis.change_form_labels(company_currency);\n\t\tthis.change_grid_labels(company_currency);\n\t\tthis.frm.refresh_fields();\n\t},\n\n\tchange_form_labels: function(company_currency) {\n\t\tvar me = this;\n\n\t\tthis.frm.set_currency_labels([\"base_total\", \"base_net_total\", \"base_total_taxes_and_charges\",\n\t\t\t\"base_discount_amount\", \"base_grand_total\", \"base_rounded_total\", \"base_in_words\",\n\t\t\t\"base_taxes_and_charges_added\", \"base_taxes_and_charges_deducted\", \"total_amount_to_pay\",\n\t\t\t\"base_paid_amount\", \"base_write_off_amount\", \"base_change_amount\", \"base_operating_cost\",\n\t\t\t\"base_raw_material_cost\", \"base_total_cost\", \"base_scrap_material_cost\",\n\t\t\t\"base_rounding_adjustment\"], company_currency);\n\n\t\tthis.frm.set_currency_labels([\"total\", \"net_total\", \"total_taxes_and_charges\", \"discount_amount\",\n\t\t\t\"grand_total\", \"taxes_and_charges_added\", \"taxes_and_charges_deducted\",\n\t\t\t\"rounded_total\", \"in_words\", \"paid_amount\", \"write_off_amount\", \"operating_cost\",\n\t\t\t\"scrap_material_cost\", \"rounding_adjustment\", \"raw_material_cost\",\n\t\t\t\"total_cost\"], this.frm.doc.currency);\n\n\t\tthis.frm.set_currency_labels([\"outstanding_amount\", \"total_advance\"],\n\t\t\tthis.frm.doc.party_account_currency);\n\n\t\tcur_frm.set_df_property(\"conversion_rate\", \"description\", \"1 \" + this.frm.doc.currency\n\t\t\t+ \" = [?] \" + company_currency);\n\n\t\tif(this.frm.doc.price_list_currency && this.frm.doc.price_list_currency!=company_currency) {\n\t\t\tcur_frm.set_df_property(\"plc_conversion_rate\", \"description\", \"1 \"\n\t\t\t\t+ this.frm.doc.price_list_currency + \" = [?] \" + company_currency);\n\t\t}\n\n\t\t// toggle fields\n\t\tthis.frm.toggle_display([\"conversion_rate\", \"base_total\", \"base_net_total\",\n\t\t\t\"base_total_taxes_and_charges\", \"base_taxes_and_charges_added\", \"base_taxes_and_charges_deducted\",\n\t\t\t\"base_grand_total\", \"base_rounded_total\", \"base_in_words\", \"base_discount_amount\",\n\t\t\t\"base_paid_amount\", \"base_write_off_amount\", \"base_operating_cost\", \"base_raw_material_cost\",\n\t\t\t\"base_total_cost\", \"base_scrap_material_cost\", \"base_rounding_adjustment\"],\n\t\tthis.frm.doc.currency != company_currency);\n\n\t\tthis.frm.toggle_display([\"plc_conversion_rate\", \"price_list_currency\"],\n\t\t\tthis.frm.doc.price_list_currency != company_currency);\n\n\t\tvar show = cint(cur_frm.doc.discount_amount) ||\n\t\t\t\t((cur_frm.doc.taxes || []).filter(function(d) {return d.included_in_print_rate===1}).length);\n\n\t\tif(frappe.meta.get_docfield(cur_frm.doctype, \"net_total\"))\n\t\t\tcur_frm.toggle_display(\"net_total\", show);\n\n\t\tif(frappe.meta.get_docfield(cur_frm.doctype, \"base_net_total\"))\n\t\t\tcur_frm.toggle_display(\"base_net_total\", (show && (me.frm.doc.currency != company_currency)));\n\n\t},\n\n\tchange_grid_labels: function(company_currency) {\n\t\tvar me = this;\n\n\t\tthis.frm.set_currency_labels([\"base_rate\", \"base_net_rate\", \"base_price_list_rate\", \"base_amount\", \"base_net_amount\", \"base_rate_with_margin\"],\n\t\t\tcompany_currency, \"items\");\n\n\t\tthis.frm.set_currency_labels([\"rate\", \"net_rate\", \"price_list_rate\", \"amount\", \"net_amount\", \"stock_uom_rate\", \"rate_with_margin\"],\n\t\t\tthis.frm.doc.currency, \"items\");\n\n\t\tif(this.frm.fields_dict[\"operations\"]) {\n\t\t\tthis.frm.set_currency_labels([\"operating_cost\", \"hour_rate\"], this.frm.doc.currency, \"operations\");\n\t\t\tthis.frm.set_currency_labels([\"base_operating_cost\", \"base_hour_rate\"], company_currency, \"operations\");\n\n\t\t\tvar item_grid = this.frm.fields_dict[\"operations\"].grid;\n\t\t\t$.each([\"base_operating_cost\", \"base_hour_rate\"], function(i, fname) {\n\t\t\t\tif(frappe.meta.get_docfield(item_grid.doctype, fname))\n\t\t\t\t\titem_grid.set_column_disp(fname, me.frm.doc.currency != company_currency);\n\t\t\t});\n\t\t}\n\n\t\tif(this.frm.fields_dict[\"scrap_items\"]) {\n\t\t\tthis.frm.set_currency_labels([\"rate\", \"amount\"], this.frm.doc.currency, \"scrap_items\");\n\t\t\tthis.frm.set_currency_labels([\"base_rate\", \"base_amount\"], company_currency, \"scrap_items\");\n\n\t\t\tvar item_grid = this.frm.fields_dict[\"scrap_items\"].grid;\n\t\t\t$.each([\"base_rate\", \"base_amount\"], function(i, fname) {\n\t\t\t\tif(frappe.meta.get_docfield(item_grid.doctype, fname))\n\t\t\t\t\titem_grid.set_column_disp(fname, me.frm.doc.currency != company_currency);\n\t\t\t});\n\t\t}\n\n\t\tif(this.frm.fields_dict[\"taxes\"]) {\n\t\t\tthis.frm.set_currency_labels([\"tax_amount\", \"total\", \"tax_amount_after_discount\"], this.frm.doc.currency, \"taxes\");\n\n\t\t\tthis.frm.set_currency_labels([\"base_tax_amount\", \"base_total\", \"base_tax_amount_after_discount\"], company_currency, \"taxes\");\n\t\t}\n\n\t\tif(this.frm.fields_dict[\"advances\"]) {\n\t\t\tthis.frm.set_currency_labels([\"advance_amount\", \"allocated_amount\"],\n\t\t\t\tthis.frm.doc.party_account_currency, \"advances\");\n\t\t}\n\n\t\t// toggle columns\n\t\tvar item_grid = this.frm.fields_dict[\"items\"].grid;\n\t\t$.each([\"base_rate\", \"base_price_list_rate\", \"base_amount\", \"base_rate_with_margin\"], function(i, fname) {\n\t\t\tif(frappe.meta.get_docfield(item_grid.doctype, fname))\n\t\t\t\titem_grid.set_column_disp(fname, me.frm.doc.currency != company_currency);\n\t\t});\n\n\t\tvar show = (cint(cur_frm.doc.discount_amount)) ||\n\t\t\t((cur_frm.doc.taxes || []).filter(function(d) {return d.included_in_print_rate===1}).length);\n\n\t\t$.each([\"net_rate\", \"net_amount\"], function(i, fname) {\n\t\t\tif(frappe.meta.get_docfield(item_grid.doctype, fname))\n\t\t\t\titem_grid.set_column_disp(fname, show);\n\t\t});\n\n\t\t$.each([\"base_net_rate\", \"base_net_amount\"], function(i, fname) {\n\t\t\tif(frappe.meta.get_docfield(item_grid.doctype, fname))\n\t\t\t\titem_grid.set_column_disp(fname, (show && (me.frm.doc.currency != company_currency)));\n\t\t});\n\n\t\t// set labels\n\t\tvar $wrapper = $(this.frm.wrapper);\n\t},\n\n\trecalculate: function() {\n\t\tthis.calculate_taxes_and_totals();\n\t},\n\n\trecalculate_values: function() {\n\t\tthis.calculate_taxes_and_totals();\n\t},\n\n\tcalculate_charges: function() {\n\t\tthis.calculate_taxes_and_totals();\n\t},\n\n\tignore_pricing_rule: function() {\n\t\tif(this.frm.doc.ignore_pricing_rule) {\n\t\t\tvar me = this;\n\t\t\tvar item_list = [];\n\n\t\t\t$.each(this.frm.doc[\"items\"] || [], function(i, d) {\n\t\t\t\tif (d.item_code && !d.is_free_item) {\n\t\t\t\t\titem_list.push({\n\t\t\t\t\t\t\"doctype\": d.doctype,\n\t\t\t\t\t\t\"name\": d.name,\n\t\t\t\t\t\t\"item_code\": d.item_code,\n\t\t\t\t\t\t\"pricing_rules\": d.pricing_rules,\n\t\t\t\t\t\t\"parenttype\": d.parenttype,\n\t\t\t\t\t\t\"parent\": d.parent\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t});\n\t\t\treturn this.frm.call({\n\t\t\t\tmethod: \"erpnext.accounts.doctype.pricing_rule.pricing_rule.remove_pricing_rules\",\n\t\t\t\targs: { item_list: item_list },\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tif (!r.exc && r.message) {\n\t\t\t\t\t\tr.message.forEach(row_item => {\n\t\t\t\t\t\t\tme.remove_pricing_rule(row_item);\n\t\t\t\t\t\t});\n\t\t\t\t\t\tme._set_values_for_item_list(r.message);\n\t\t\t\t\t\tme.calculate_taxes_and_totals();\n\t\t\t\t\t\tif(me.frm.doc.apply_discount_on) me.frm.trigger(\"apply_discount_on\");\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t} else {\n\t\t\tthis.apply_pricing_rule();\n\t\t}\n\t},\n\n\tapply_pricing_rule: function(item, calculate_taxes_and_totals) {\n\t\tvar me = this;\n\t\tvar args = this._get_args(item);\n\t\tif (!(args.items && args.items.length)) {\n\t\t\tif(calculate_taxes_and_totals) me.calculate_taxes_and_totals();\n\t\t\treturn;\n\t\t}\n\n\t\treturn this.frm.call({\n\t\t\tmethod: \"erpnext.accounts.doctype.pricing_rule.pricing_rule.apply_pricing_rule\",\n\t\t\targs: {\targs: args, doc: me.frm.doc },\n\t\t\tcallback: function(r) {\n\t\t\t\tif (!r.exc && r.message) {\n\t\t\t\t\tme._set_values_for_item_list(r.message);\n\t\t\t\t\tif(item) me.set_gross_profit(item);\n\t\t\t\t\tif(me.frm.doc.apply_discount_on) me.frm.trigger(\"apply_discount_on\")\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t},\n\n\t_get_args: function(item) {\n\t\tvar me = this;\n\t\treturn {\n\t\t\t\"items\": this._get_item_list(item),\n\t\t\t\"customer\": me.frm.doc.customer || me.frm.doc.party_name,\n\t\t\t\"quotation_to\": me.frm.doc.quotation_to,\n\t\t\t\"customer_group\": me.frm.doc.customer_group,\n\t\t\t\"territory\": me.frm.doc.territory,\n\t\t\t\"supplier\": me.frm.doc.supplier,\n\t\t\t\"supplier_group\": me.frm.doc.supplier_group,\n\t\t\t\"currency\": me.frm.doc.currency,\n\t\t\t\"conversion_rate\": me.frm.doc.conversion_rate,\n\t\t\t\"price_list\": me.frm.doc.selling_price_list || me.frm.doc.buying_price_list,\n\t\t\t\"price_list_currency\": me.frm.doc.price_list_currency,\n\t\t\t\"plc_conversion_rate\": me.frm.doc.plc_conversion_rate,\n\t\t\t\"company\": me.frm.doc.company,\n\t\t\t\"transaction_date\": me.frm.doc.transaction_date || me.frm.doc.posting_date,\n\t\t\t\"campaign\": me.frm.doc.campaign,\n\t\t\t\"sales_partner\": me.frm.doc.sales_partner,\n\t\t\t\"ignore_pricing_rule\": me.frm.doc.ignore_pricing_rule,\n\t\t\t\"doctype\": me.frm.doc.doctype,\n\t\t\t\"name\": me.frm.doc.name,\n\t\t\t\"is_return\": cint(me.frm.doc.is_return),\n\t\t\t\"update_stock\": in_list(['Sales Invoice', 'Purchase Invoice'], me.frm.doc.doctype) ? cint(me.frm.doc.update_stock) : 0,\n\t\t\t\"conversion_factor\": me.frm.doc.conversion_factor,\n\t\t\t\"pos_profile\": me.frm.doc.doctype == 'Sales Invoice' ? me.frm.doc.pos_profile : '',\n\t\t\t\"coupon_code\": me.frm.doc.coupon_code\n\t\t};\n\t},\n\n\t_get_item_list: function(item) {\n\t\tvar item_list = [];\n\t\tvar append_item = function(d) {\n\t\t\tif (d.item_code) {\n\t\t\t\titem_list.push({\n\t\t\t\t\t\"doctype\": d.doctype,\n\t\t\t\t\t\"name\": d.name,\n\t\t\t\t\t\"child_docname\": d.name,\n\t\t\t\t\t\"item_code\": d.item_code,\n\t\t\t\t\t\"item_group\": d.item_group,\n\t\t\t\t\t\"brand\": d.brand,\n\t\t\t\t\t\"qty\": d.qty,\n\t\t\t\t\t\"stock_qty\": d.stock_qty,\n\t\t\t\t\t\"uom\": d.uom,\n\t\t\t\t\t\"stock_uom\": d.stock_uom,\n\t\t\t\t\t\"parenttype\": d.parenttype,\n\t\t\t\t\t\"parent\": d.parent,\n\t\t\t\t\t\"pricing_rules\": d.pricing_rules,\n\t\t\t\t\t\"warehouse\": d.warehouse,\n\t\t\t\t\t\"serial_no\": d.serial_no,\n\t\t\t\t\t\"batch_no\": d.batch_no,\n\t\t\t\t\t\"price_list_rate\": d.price_list_rate,\n\t\t\t\t\t\"conversion_factor\": d.conversion_factor || 1.0\n\t\t\t\t});\n\n\t\t\t\t// if doctype is Quotation Item / Sales Order Iten then add Margin Type and rate in item_list\n\t\t\t\tif (in_list([\"Quotation Item\", \"Sales Order Item\", \"Delivery Note Item\", \"Sales Invoice Item\", \"Purchase Invoice Item\", \"Purchase Order Item\", \"Purchase Receipt Item\"]), d.doctype) {\n\t\t\t\t\titem_list[0][\"margin_type\"] = d.margin_type;\n\t\t\t\t\titem_list[0][\"margin_rate_or_amount\"] = d.margin_rate_or_amount;\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\tif (item) {\n\t\t\tappend_item(item);\n\t\t} else {\n\t\t\t$.each(this.frm.doc[\"items\"] || [], function(i, d) {\n\t\t\t\tappend_item(d);\n\t\t\t});\n\t\t}\n\t\treturn item_list;\n\t},\n\n\t_set_values_for_item_list: function(children) {\n\t\tvar me = this;\n\t\tvar price_list_rate_changed = false;\n\t\tvar items_rule_dict = {};\n\n\t\tfor(var i=0, l=children.length; i<l; i++) {\n\t\t\tvar d = children[i];\n\t\t\tvar existing_pricing_rule = frappe.model.get_value(d.doctype, d.name, \"pricing_rules\");\n\t\t\tfor(var k in d) {\n\t\t\t\tvar v = d[k];\n\t\t\t\tif ([\"doctype\", \"name\"].indexOf(k)===-1) {\n\t\t\t\t\tif(k==\"price_list_rate\") {\n\t\t\t\t\t\tif(flt(v) != flt(d.price_list_rate)) price_list_rate_changed = true;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (k !== 'free_item_data') {\n\t\t\t\t\t\tfrappe.model.set_value(d.doctype, d.name, k, v);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// if pricing rule set as blank from an existing value, apply price_list\n\t\t\tif(!me.frm.doc.ignore_pricing_rule && existing_pricing_rule && !d.pricing_rules) {\n\t\t\t\tme.apply_price_list(frappe.get_doc(d.doctype, d.name));\n\t\t\t} else if(!d.pricing_rules) {\n\t\t\t\tme.remove_pricing_rule(frappe.get_doc(d.doctype, d.name));\n\t\t\t}\n\n\t\t\tif (d.free_item_data) {\n\t\t\t\tme.apply_product_discount(d);\n\t\t\t}\n\n\t\t\tif (d.apply_rule_on_other_items) {\n\t\t\t\titems_rule_dict[d.name] = d;\n\t\t\t}\n\t\t}\n\n\t\tme.apply_rule_on_other_items(items_rule_dict);\n\n\t\tif(!price_list_rate_changed) me.calculate_taxes_and_totals();\n\t},\n\n\tapply_rule_on_other_items: function(args) {\n\t\tconst me = this;\n\t\tconst fields = [\"discount_percentage\", \"pricing_rules\", \"discount_amount\", \"rate\"];\n\n\t\tfor(var k in args) {\n\t\t\tlet data = args[k];\n\n\t\t\tif (data && data.apply_rule_on_other_items) {\n\t\t\t\tme.frm.doc.items.forEach(d => {\n\t\t\t\t\tif (in_list(data.apply_rule_on_other_items, d[data.apply_rule_on])) {\n\t\t\t\t\t\tfor(var k in data) {\n\t\t\t\t\t\t\tif (in_list(fields, k) && data[k] && (data.price_or_product_discount === 'price' || k === 'pricing_rules')) {\n\t\t\t\t\t\t\t\tfrappe.model.set_value(d.doctype, d.name, k, data[k]);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t},\n\n\tapply_product_discount: function(args) {\n\t\tconst items = this.frm.doc.items.filter(d => (d.is_free_item)) || [];\n\n\t\tconst exist_items = items.map(row => (row.item_code, row.pricing_rules));\n\n\t\targs.free_item_data.forEach(pr_row => {\n\t\t\tlet row_to_modify = {};\n\t\t\tif (!items || !in_list(exist_items, (pr_row.item_code, pr_row.pricing_rules))) {\n\n\t\t\t\trow_to_modify = frappe.model.add_child(this.frm.doc,\n\t\t\t\t\tthis.frm.doc.doctype + ' Item', 'items');\n\n\t\t\t} else if(items) {\n\t\t\t\trow_to_modify = items.filter(d => (d.item_code === pr_row.item_code\n\t\t\t\t\t&& d.pricing_rules === pr_row.pricing_rules))[0];\n\t\t\t}\n\n\t\t\tfor (let key in pr_row) {\n\t\t\t\trow_to_modify[key] = pr_row[key];\n\t\t\t}\n\t\t});\n\n\t\t// free_item_data is a temporary variable\n\t\targs.free_item_data = '';\n\t\trefresh_field('items');\n\t},\n\n\tapply_price_list: function(item, reset_plc_conversion) {\n\t\t// We need to reset plc_conversion_rate sometimes because the call to\n\t\t// `erpnext.stock.get_item_details.apply_price_list` is sensitive to its value\n\t\tif (!reset_plc_conversion) {\n\t\t\tthis.frm.set_value(\"plc_conversion_rate\", \"\");\n\t\t}\n\n\t\tvar me = this;\n\t\tvar args = this._get_args(item);\n\t\tif (!((args.items && args.items.length) || args.price_list)) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (me.in_apply_price_list == true) return;\n\n\t\tme.in_apply_price_list = true;\n\t\treturn this.frm.call({\n\t\t\tmethod: \"erpnext.stock.get_item_details.apply_price_list\",\n\t\t\targs: {\targs: args },\n\t\t\tcallback: function(r) {\n\t\t\t\tif (!r.exc) {\n\t\t\t\t\tfrappe.run_serially([\n\t\t\t\t\t\t() => me.frm.set_value(\"price_list_currency\", r.message.parent.price_list_currency),\n\t\t\t\t\t\t() => me.frm.set_value(\"plc_conversion_rate\", r.message.parent.plc_conversion_rate),\n\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\tif(args.items.length) {\n\t\t\t\t\t\t\t\tme._set_values_for_item_list(r.message.children);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t\t() => { me.in_apply_price_list = false; }\n\t\t\t\t\t]);\n\n\t\t\t\t} else {\n\t\t\t\t\tme.in_apply_price_list = false;\n\t\t\t\t}\n\t\t\t}\n\t\t}).always(() => {\n\t\t\tme.in_apply_price_list = false;\n\t\t});\n\t},\n\n\tremove_pricing_rule: function(item) {\n\t\tlet me = this;\n\t\tconst fields = [\"discount_percentage\",\n\t\t\t\"discount_amount\", \"margin_rate_or_amount\", \"rate_with_margin\"];\n\n\t\tif(item.remove_free_item) {\n\t\t\tvar items = [];\n\n\t\t\tme.frm.doc.items.forEach(d => {\n\t\t\t\tif(d.item_code != item.remove_free_item || !d.is_free_item) {\n\t\t\t\t\titems.push(d);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tme.frm.doc.items = items;\n\t\t\trefresh_field('items');\n\t\t} else if(item.applied_on_items && item.apply_on) {\n\t\t\tconst applied_on_items = item.applied_on_items.split(',');\n\t\t\tme.frm.doc.items.forEach(row => {\n\t\t\t\tif(applied_on_items.includes(row[item.apply_on])) {\n\t\t\t\t\tfields.forEach(f => {\n\t\t\t\t\t\trow[f] = 0;\n\t\t\t\t\t});\n\n\t\t\t\t\t[\"pricing_rules\", \"margin_type\"].forEach(field => {\n\t\t\t\t\t\tif (row[field]) {\n\t\t\t\t\t\t\trow[field] = '';\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tme.trigger_price_list_rate();\n\t\t}\n\t},\n\n\ttrigger_price_list_rate: function() {\n\t\tvar me  = this;\n\n\t\tthis.frm.doc.items.forEach(child_row => {\n\t\t\tme.frm.script_manager.trigger(\"price_list_rate\",\n\t\t\t\tchild_row.doctype, child_row.name);\n\t\t})\n\t},\n\n\tvalidate_company_and_party: function() {\n\t\tvar me = this;\n\t\tvar valid = true;\n\n\t\t$.each([\"company\", \"customer\"], function(i, fieldname) {\n\t\t\tif(frappe.meta.has_field(me.frm.doc.doctype, fieldname) && me.frm.doc.doctype != \"Purchase Order\") {\n\t\t\t\tif (!me.frm.doc[fieldname]) {\n\t\t\t\t\tfrappe.msgprint(__(\"Please specify\") + \": \" +\n\t\t\t\t\t\t__(frappe.meta.get_label(me.frm.doc.doctype, fieldname, me.frm.doc.name)) +\n\t\t\t\t\t\t\". \" + __(\"It is needed to fetch Item Details.\"));\n\t\t\t\t\tvalid = false;\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t\treturn valid;\n\t},\n\n\tget_terms: function() {\n\t\tvar me = this;\n\n\t\terpnext.utils.get_terms(this.frm.doc.tc_name, this.frm.doc, function(r) {\n\t\t\tif(!r.exc) {\n\t\t\t\tme.frm.set_value(\"terms\", r.message);\n\t\t\t}\n\t\t});\n\t},\n\n\ttaxes_and_charges: function() {\n\t\tvar me = this;\n\t\tif(this.frm.doc.taxes_and_charges) {\n\t\t\treturn this.frm.call({\n\t\t\t\tmethod: \"erpnext.controllers.accounts_controller.get_taxes_and_charges\",\n\t\t\t\targs: {\n\t\t\t\t\t\"master_doctype\": frappe.meta.get_docfield(this.frm.doc.doctype, \"taxes_and_charges\",\n\t\t\t\t\t\tthis.frm.doc.name).options,\n\t\t\t\t\t\"master_name\": this.frm.doc.taxes_and_charges\n\t\t\t\t},\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tif(!r.exc) {\n\t\t\t\t\t\tif(me.frm.doc.shipping_rule && me.frm.doc.taxes) {\n\t\t\t\t\t\t\tfor (let tax of r.message) {\n\t\t\t\t\t\t\t\tme.frm.add_child(\"taxes\", tax);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\trefresh_field(\"taxes\");\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tme.frm.set_value(\"taxes\", r.message);\n\t\t\t\t\t\t\tme.calculate_taxes_and_totals();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t},\n\n\ttax_category: function() {\n\t\tvar me = this;\n\t\tif(me.frm.updating_party_details) return;\n\n\t\tfrappe.run_serially([\n\t\t\t() => this.update_item_tax_map(),\n\t\t\t() => erpnext.utils.set_taxes(this.frm, \"tax_category\"),\n\t\t]);\n\t},\n\n\titem_tax_template: function(doc, cdt, cdn) {\n\t\tvar me = this;\n\t\tif(me.frm.updating_party_details) return;\n\n\t\tvar item = frappe.get_doc(cdt, cdn);\n\n\t\tif(item.item_tax_template) {\n\t\t\treturn this.frm.call({\n\t\t\t\tmethod: \"erpnext.stock.get_item_details.get_item_tax_map\",\n\t\t\t\targs: {\n\t\t\t\t\tcompany: me.frm.doc.company,\n\t\t\t\t\titem_tax_template: item.item_tax_template,\n\t\t\t\t\tas_json: true\n\t\t\t\t},\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tif(!r.exc) {\n\t\t\t\t\t\titem.item_tax_rate = r.message;\n\t\t\t\t\t\tme.add_taxes_from_item_tax_template(item.item_tax_rate);\n\t\t\t\t\t\tme.calculate_taxes_and_totals();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t} else {\n\t\t\titem.item_tax_rate = \"{}\";\n\t\t\tme.calculate_taxes_and_totals();\n\t\t}\n\t},\n\n\tupdate_item_tax_map: function() {\n\t\tvar me = this;\n\t\tvar item_codes = [];\n\t\t$.each(this.frm.doc.items || [], function(i, item) {\n\t\t\tif(item.item_code) {\n\t\t\t\titem_codes.push(item.item_code);\n\t\t\t}\n\t\t});\n\n\t\tif(item_codes.length) {\n\t\t\treturn this.frm.call({\n\t\t\t\tmethod: \"erpnext.stock.get_item_details.get_item_tax_info\",\n\t\t\t\targs: {\n\t\t\t\t\tcompany: me.frm.doc.company,\n\t\t\t\t\ttax_category: cstr(me.frm.doc.tax_category),\n\t\t\t\t\titem_codes: item_codes\n\t\t\t\t},\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tif(!r.exc) {\n\t\t\t\t\t\t$.each(me.frm.doc.items || [], function(i, item) {\n\t\t\t\t\t\t\tif(item.item_code && r.message.hasOwnProperty(item.item_code)) {\n\t\t\t\t\t\t\t\tif (!item.item_tax_template) {\n\t\t\t\t\t\t\t\t\titem.item_tax_template = r.message[item.item_code].item_tax_template;\n\t\t\t\t\t\t\t\t\titem.item_tax_rate = r.message[item.item_code].item_tax_rate;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tme.add_taxes_from_item_tax_template(item.item_tax_rate);\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\titem.item_tax_template = \"\";\n\t\t\t\t\t\t\t\titem.item_tax_rate = \"{}\";\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t\tme.calculate_taxes_and_totals();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t},\n\n\tis_recurring: function() {\n\t\t// set default values for recurring documents\n\t\tif(this.frm.doc.is_recurring && this.frm.doc.__islocal) {\n\t\t\tfrappe.msgprint(__(\"Please set recurring after saving\"));\n\t\t\tthis.frm.set_value('is_recurring', 0);\n\t\t\treturn;\n\t\t}\n\n\t\tif(this.frm.doc.is_recurring) {\n\t\t\tif(!this.frm.doc.recurring_id) {\n\t\t\t\tthis.frm.set_value('recurring_id', this.frm.doc.name);\n\t\t\t}\n\n\t\t\tvar owner_email = this.frm.doc.owner==\"Administrator\"\n\t\t\t\t? frappe.user_info(\"Administrator\").email\n\t\t\t\t: this.frm.doc.owner;\n\n\t\t\tthis.frm.doc.notification_email_address = $.map([cstr(owner_email),\n\t\t\t\tcstr(this.frm.doc.contact_email)], function(v) { return v || null; }).join(\", \");\n\t\t\tthis.frm.doc.repeat_on_day_of_month = frappe.datetime.str_to_obj(this.frm.doc.posting_date).getDate();\n\t\t}\n\n\t\trefresh_many([\"notification_email_address\", \"repeat_on_day_of_month\"]);\n\t},\n\n\tfrom_date: function() {\n\t\t// set to_date\n\t\tif(this.frm.doc.from_date) {\n\t\t\tvar recurring_type_map = {'Monthly': 1, 'Quarterly': 3, 'Half-yearly': 6,\n\t\t\t\t'Yearly': 12};\n\n\t\t\tvar months = recurring_type_map[this.frm.doc.recurring_type];\n\t\t\tif(months) {\n\t\t\t\tvar to_date = frappe.datetime.add_months(this.frm.doc.from_date,\n\t\t\t\t\tmonths);\n\t\t\t\tthis.frm.doc.to_date = frappe.datetime.add_days(to_date, -1);\n\t\t\t\trefresh_field('to_date');\n\t\t\t}\n\t\t}\n\t},\n\n\tset_gross_profit: function(item) {\n\t\tif ([\"Sales Order\", \"Quotation\"].includes(this.frm.doc.doctype) && item.valuation_rate) {\n\t\t\tvar rate = flt(item.rate) * flt(this.frm.doc.conversion_rate || 1);\n\t\t\titem.gross_profit = flt(((rate - item.valuation_rate) * item.stock_qty), precision(\"amount\", item));\n\t\t}\n\t},\n\n\tsetup_item_selector: function() {\n\t\t// TODO: remove item selector\n\n\t\treturn;\n\t\t// if(!this.item_selector) {\n\t\t// \tthis.item_selector = new erpnext.ItemSelector({frm: this.frm});\n\t\t// }\n\t},\n\n\tget_advances: function() {\n\t\tconst me = this;\n\t\tif(!this.frm.is_return) {\n\t\t\treturn this.frm.call({\n\t\t\t\tmethod: \"set_advances\",\n\t\t\t\tdoc: this.frm.doc,\n\t\t\t\tcallback: function(r, rt) {\n\t\t\t\t\trefresh_field(\"advances\");\n\t\t\t\t\tme.frm.dirty();\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\t},\n\n\tmake_payment_entry: function() {\n\t\treturn frappe.call({\n\t\t\tmethod: cur_frm.cscript.get_method_for_payment(),\n\t\t\targs: {\n\t\t\t\t\"dt\": cur_frm.doc.doctype,\n\t\t\t\t\"dn\": cur_frm.doc.name\n\t\t\t},\n\t\t\tcallback: function(r) {\n\t\t\t\tvar doclist = frappe.model.sync(r.message);\n\t\t\t\tfrappe.set_route(\"Form\", doclist[0].doctype, doclist[0].name);\n\t\t\t\t// cur_frm.refresh_fields()\n\t\t\t}\n\t\t});\n\t},\n\n\tget_method_for_payment: function(){\n\t\tvar method = \"erpnext.accounts.doctype.payment_entry.payment_entry.get_payment_entry\";\n\t\tif(cur_frm.doc.__onload && cur_frm.doc.__onload.make_payment_via_journal_entry){\n\t\t\tif(in_list(['Sales Invoice', 'Purchase Invoice'],  cur_frm.doc.doctype)){\n\t\t\t\tmethod = \"erpnext.accounts.doctype.journal_entry.journal_entry.get_payment_entry_against_invoice\";\n\t\t\t}else {\n\t\t\t\tmethod= \"erpnext.accounts.doctype.journal_entry.journal_entry.get_payment_entry_against_order\";\n\t\t\t}\n\t\t}\n\n\t\treturn method\n\t},\n\n\tset_query_for_batch: function(doc, cdt, cdn) {\n\t\t// Show item's batches in the dropdown of batch no\n\n\t\tvar me = this;\n\t\tvar item = frappe.get_doc(cdt, cdn);\n\n\t\tif(!item.item_code) {\n\t\t\tfrappe.throw(__(\"Please enter Item Code to get batch no\"));\n\t\t} else if (doc.doctype == \"Purchase Receipt\" ||\n\t\t\t(doc.doctype == \"Purchase Invoice\" && doc.update_stock)) {\n\t\t\treturn {\n\t\t\t\tfilters: {'item': item.item_code}\n\t\t\t}\n\t\t} else {\n\t\t\tlet filters = {\n\t\t\t\t'item_code': item.item_code,\n\t\t\t\t'posting_date': me.frm.doc.posting_date || frappe.datetime.nowdate(),\n\t\t\t}\n\n\t\t\tif (doc.is_return) {\n\t\t\t\tfilters[\"is_return\"] = 1;\n\t\t\t}\n\n\t\t\tif (item.warehouse) filters[\"warehouse\"] = item.warehouse;\n\n\t\t\treturn {\n\t\t\t\tquery : \"erpnext.controllers.queries.get_batch_no\",\n\t\t\t\tfilters: filters\n\t\t\t}\n\t\t}\n\t},\n\n\tset_query_for_item_tax_template: function(doc, cdt, cdn) {\n\n\t\tvar item = frappe.get_doc(cdt, cdn);\n\t\tif(!item.item_code) {\n\t\t\treturn doc.company ? {filters: {company: doc.company}} : {};\n\t\t} else {\n\t\t\tlet filters = {\n\t\t\t\t'item_code': item.item_code,\n\t\t\t\t'valid_from': [\"<=\", doc.transaction_date || doc.bill_date || doc.posting_date],\n\t\t\t\t'item_group': item.item_group,\n\t\t\t}\n\n\t\t\tif (doc.tax_category)\n\t\t\t\tfilters['tax_category'] = doc.tax_category;\n\t\t\tif (doc.company)\n\t\t\t\tfilters['company'] = doc.company;\n\n\t\t\treturn {\n\t\t\t\tquery: \"erpnext.controllers.queries.get_tax_template\",\n\t\t\t\tfilters: filters\n\t\t\t}\n\t\t}\n\t},\n\n\tpayment_terms_template: function() {\n\t\tvar me = this;\n\t\tconst doc = this.frm.doc;\n\t\tif(doc.payment_terms_template && doc.doctype !== 'Delivery Note') {\n\t\t\tvar posting_date = doc.posting_date || doc.transaction_date;\n\t\t\tfrappe.call({\n\t\t\t\tmethod: \"erpnext.controllers.accounts_controller.get_payment_terms\",\n\t\t\t\targs: {\n\t\t\t\t\tterms_template: doc.payment_terms_template,\n\t\t\t\t\tposting_date: posting_date,\n\t\t\t\t\tgrand_total: doc.rounded_total || doc.grand_total,\n\t\t\t\t\tbill_date: doc.bill_date\n\t\t\t\t},\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tif(r.message && !r.exc) {\n\t\t\t\t\t\tme.frm.set_value(\"payment_schedule\", r.message);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\t},\n\n\tpayment_term: function(doc, cdt, cdn) {\n\t\tvar row = locals[cdt][cdn];\n\t\tif(row.payment_term) {\n\t\t\tfrappe.call({\n\t\t\t\tmethod: \"erpnext.controllers.accounts_controller.get_payment_term_details\",\n\t\t\t\targs: {\n\t\t\t\t\tterm: row.payment_term,\n\t\t\t\t\tbill_date: this.frm.doc.bill_date,\n\t\t\t\t\tposting_date: this.frm.doc.posting_date || this.frm.doc.transaction_date,\n\t\t\t\t\tgrand_total: this.frm.doc.rounded_total || this.frm.doc.grand_total\n\t\t\t\t},\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tif(r.message && !r.exc) {\n\t\t\t\t\t\tfor (var d in r.message) {\n\t\t\t\t\t\t\tfrappe.model.set_value(cdt, cdn, d, r.message[d]);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\t},\n\n\tagainst_blanket_order: function(doc, cdt, cdn) {\n\t\tvar item = locals[cdt][cdn];\n\t\tif(!item.against_blanket_order) {\n\t\t\tfrappe.model.set_value(this.frm.doctype + \" Item\", item.name, \"blanket_order\", null);\n\t\t\tfrappe.model.set_value(this.frm.doctype + \" Item\", item.name, \"blanket_order_rate\", 0.00);\n\t\t}\n\t},\n\n\tblanket_order: function(doc, cdt, cdn) {\n\t\tvar me = this;\n\t\tvar item = locals[cdt][cdn];\n\t\tif (item.blanket_order && (item.parenttype==\"Sales Order\" || item.parenttype==\"Purchase Order\")) {\n\t\t\tfrappe.call({\n\t\t\t\tmethod: \"erpnext.stock.get_item_details.get_blanket_order_details\",\n\t\t\t\targs: {\n\t\t\t\t\targs:{\n\t\t\t\t\t\titem_code: item.item_code,\n\t\t\t\t\t\tcustomer: doc.customer,\n\t\t\t\t\t\tsupplier: doc.supplier,\n\t\t\t\t\t\tcompany: doc.company,\n\t\t\t\t\t\ttransaction_date: doc.transaction_date,\n\t\t\t\t\t\tblanket_order: item.blanket_order\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tif (!r.message) {\n\t\t\t\t\t\tfrappe.throw(__(\"Invalid Blanket Order for the selected Customer and Item\"));\n\t\t\t\t\t} else {\n\t\t\t\t\t\tfrappe.run_serially([\n\t\t\t\t\t\t\t() => frappe.model.set_value(cdt, cdn, \"blanket_order_rate\", r.message.blanket_order_rate),\n\t\t\t\t\t\t\t() => me.frm.script_manager.trigger(\"price_list_rate\", cdt, cdn)\n\t\t\t\t\t\t]);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\t},\n\n\tset_reserve_warehouse: function() {\n\t\tthis.autofill_warehouse(this.frm.doc.supplied_items, \"reserve_warehouse\", this.frm.doc.set_reserve_warehouse);\n\t},\n\n\tset_warehouse: function() {\n\t\tthis.autofill_warehouse(this.frm.doc.items, \"warehouse\", this.frm.doc.set_warehouse);\n\t},\n\n\tset_target_warehouse: function() {\n\t\tthis.autofill_warehouse(this.frm.doc.items, \"target_warehouse\", this.frm.doc.set_target_warehouse);\n\t},\n\n\tset_from_warehouse: function() {\n\t\tthis.autofill_warehouse(this.frm.doc.items, \"from_warehouse\", this.frm.doc.set_from_warehouse);\n\t},\n\n\tautofill_warehouse : function (child_table, warehouse_field, warehouse) {\n\t\tif (warehouse && child_table && child_table.length) {\n\t\t\tlet doctype = child_table[0].doctype;\n\t\t\t$.each(child_table || [], function(i, item) {\n\t\t\t\tfrappe.model.set_value(doctype, item.name, warehouse_field, warehouse);\n\t\t\t});\n\t\t}\n\t},\n\n\tcoupon_code: function() {\n\t\tvar me = this;\n\t\tfrappe.run_serially([\n\t\t\t() => this.frm.doc.ignore_pricing_rule=1,\n\t\t\t() => me.ignore_pricing_rule(),\n\t\t\t() => this.frm.doc.ignore_pricing_rule=0,\n\t\t\t() => me.apply_pricing_rule()\n\t\t]);\n\t}\n});\n\nerpnext.show_serial_batch_selector = function (frm, d, callback, on_close, show_dialog) {\n\tlet warehouse, receiving_stock, existing_stock;\n\tif (frm.doc.is_return) {\n\t\tif ([\"Purchase Receipt\", \"Purchase Invoice\"].includes(frm.doc.doctype)) {\n\t\t\texisting_stock = true;\n\t\t\twarehouse = d.warehouse;\n\t\t} else if ([\"Delivery Note\", \"Sales Invoice\"].includes(frm.doc.doctype)) {\n\t\t\treceiving_stock = true;\n\t\t}\n\t} else {\n\t\tif (frm.doc.doctype == \"Stock Entry\") {\n\t\t\tif (frm.doc.purpose == \"Material Receipt\") {\n\t\t\t\treceiving_stock = true;\n\t\t\t} else {\n\t\t\t\texisting_stock = true;\n\t\t\t\twarehouse = d.s_warehouse;\n\t\t\t}\n\t\t} else {\n\t\t\texisting_stock = true;\n\t\t\twarehouse = d.warehouse;\n\t\t}\n\t}\n\n\tif (!warehouse) {\n\t\tif (receiving_stock) {\n\t\t\twarehouse = [\"like\", \"\"];\n\t\t} else if (existing_stock) {\n\t\t\twarehouse = [\"!=\", \"\"];\n\t\t}\n\t}\n\n\tfrappe.require(\"assets/erpnext/js/utils/serial_no_batch_selector.js\", function() {\n\t\tnew erpnext.SerialNoBatchSelector({\n\t\t\tfrm: frm,\n\t\t\titem: d,\n\t\t\twarehouse_details: {\n\t\t\t\ttype: \"Warehouse\",\n\t\t\t\tname: warehouse\n\t\t\t},\n\t\t\tcallback: callback,\n\t\t\ton_close: on_close\n\t\t}, show_dialog);\n\t});\n}\n\nerpnext.apply_putaway_rule = (frm, purpose=null) => {\n\tif (!frm.doc.company) {\n\t\tfrappe.throw({message: __(\"Please select a Company first.\"), title: __(\"Mandatory\")});\n\t}\n\tif (!frm.doc.items.length) return;\n\n\tfrappe.call({\n\t\tmethod: \"erpnext.stock.doctype.putaway_rule.putaway_rule.apply_putaway_rule\",\n\t\targs: {\n\t\t\tdoctype: frm.doctype,\n\t\t\titems: frm.doc.items,\n\t\t\tcompany: frm.doc.company,\n\t\t\tsync: true,\n\t\t\tpurpose: purpose\n\t\t},\n\t\tcallback: (result) => {\n\t\t\tif (!result.exc && result.message) {\n\t\t\t\tfrm.clear_table(\"items\");\n\n\t\t\t\tlet items =  result.message;\n\t\t\t\titems.forEach((row) => {\n\t\t\t\t\tdelete row[\"name\"]; // dont overwrite name from server side\n\t\t\t\t\tlet child = frm.add_child(\"items\");\n\t\t\t\t\tObject.assign(child, row);\n\t\t\t\t\tfrm.script_manager.trigger(\"qty\", child.doctype, child.name);\n\t\t\t\t});\n\t\t\t\tfrm.get_field(\"items\").grid.refresh();\n\t\t\t}\n\t\t}\n\t});\n};","erpnext.ItemSelector = Class.extend({\n\tinit: function(opts) {\n\t\t$.extend(this, opts);\n\n\t\tif (!this.item_field) {\n\t\t\tthis.item_field = 'item_code';\n\t\t}\n\n\t\tif (!this.item_query) {\n\t\t\tthis.item_query = erpnext.queries.item().query;\n\t\t}\n\n\t\tthis.grid = this.frm.get_field(\"items\").grid;\n\t\tthis.setup();\n\t},\n\n\tsetup: function() {\n\t\tvar me = this;\n\t\tif(!this.grid.add_items_button) {\n\t\t\tthis.grid.add_items_button = this.grid.add_custom_button(__('Add Items'), function() {\n\t\t\t\tif(!me.dialog) {\n\t\t\t\t\tme.make_dialog();\n\t\t\t\t}\n\t\t\t\tme.dialog.show();\n\t\t\t\tme.render_items();\n\t\t\t\tsetTimeout(function() { me.dialog.input.focus(); }, 1000);\n\t\t\t});\n\t\t}\n\t},\n\n\tmake_dialog: function() {\n\t\tthis.dialog = new frappe.ui.Dialog({\n\t\t\ttitle: __('Add Items')\n\t\t});\n\t\tvar body = $(this.dialog.body);\n\t\tbody.html('<div><p><input type=\"text\" class=\"form-control\"></p>\\\n\t\t\t<br><div class=\"results\"></div></div>');\n\n\t\tthis.dialog.input = body.find('.form-control');\n\t\tthis.dialog.results = body.find('.results');\n\n\t\tvar me = this;\n\t\tthis.dialog.results.on('click', '.image-view-item', function() {\n\t\t\tme.add_item($(this).attr('data-name'));\n\t\t});\n\n\t\tthis.dialog.input.on('keyup', function() {\n\t\t\tif(me.timeout_id) {\n\t\t\t\tclearTimeout(me.timeout_id);\n\t\t\t}\n\t\t\tme.timeout_id = setTimeout(function() {\n\t\t\t\tme.render_items();\n\t\t\t\tme.timeout_id = undefined;\n\t\t\t}, 500);\n\t\t});\n\t},\n\n\tadd_item: function(item_code) {\n\t\t// add row or update qty\n\t\tvar added = false;\n\n\t\t// find row with item if exists\n\t\t$.each(this.frm.doc.items || [], (i, d) => {\n\t\t\tif(d[this.item_field]===item_code) {\n\t\t\t\tfrappe.model.set_value(d.doctype, d.name, 'qty', d.qty + 1);\n\t\t\t\tfrappe.show_alert({message: __(\"Added {0} ({1})\", [item_code, d.qty]), indicator: 'green'});\n\t\t\t\tadded = true;\n\t\t\t\treturn false;\n\t\t\t}\n\t\t});\n\n\t\tif(!added) {\n\t\t\tvar d = null;\n\t\t\tfrappe.run_serially([\n\t\t\t\t() => { d = this.grid.add_new_row(); },\n\t\t\t\t() => frappe.model.set_value(d.doctype, d.name, this.item_field, item_code),\n\t\t\t\t() => frappe.timeout(0.1),\n\t\t\t\t() => {\n\t\t\t\t\tfrappe.model.set_value(d.doctype, d.name, 'qty', 1);\n\t\t\t\t\tfrappe.show_alert({message: __(\"Added {0} ({1})\", [item_code, 1]), indicator: 'green'});\n\t\t\t\t}\n\t\t\t]);\n\t\t}\n\n\t},\n\n\trender_items: function() {\n\t\tlet args = {\n\t\t\tquery: this.item_query,\n\t\t\tfilters: {}\n\t\t};\n\t\targs.txt = this.dialog.input.val();\n\t\targs.as_dict = 1;\n\n\t\tif (this.get_filters) {\n\t\t\t$.extend(args.filters, this.get_filters() || {});\n\t\t}\n\n\t\tvar me = this;\n\t\tfrappe.link_search(\"Item\", args, function(r) {\n\t\t\t$.each(r.values, function(i, d) {\n\t\t\t\tif(!d.image) {\n\t\t\t\t\td.abbr = frappe.get_abbr(d.item_name);\n\t\t\t\t\td.color = frappe.get_palette(d.item_name);\n\t\t\t\t}\n\t\t\t});\n\t\t\tme.dialog.results.html(frappe.render_template('item_selector', {'data':r.values}));\n\t\t});\n\t}\n});","frappe.provide(\"frappe.help.help_links\");\n\nconst lang = frappe.boot.user.language == \"fr\" ? \"/fr/\" : \"/\"\nconst docsUrl = `https://doc.dokos.io${lang}`;\n\nfrappe.help.help_links['Form/Asset'] = [\n\t{\n\t\tlabel: __('Getting started with assets'),\n\t\turl: docsUrl + 'assets/getting-started'\n\t}\n]","frappe.provide('frappe.ui.form');\n\nfrappe.ui.form.ItemQuickEntryForm = frappe.ui.form.QuickEntryForm.extend({\n\tinit: function(doctype, after_insert) {\n\t\tthis._super(doctype, after_insert);\n\t},\n\n\trender_dialog: function() {\n\t\tthis.mandatory = this.get_variant_fields().concat(this.mandatory);\n\t\tthis.mandatory = this.mandatory.concat(this.get_attributes_fields());\n\t\tthis.check_naming_series_based_on();\n\t\tthis._super();\n\t\tthis.init_post_render_dialog_operations();\n\t\tthis.preset_fields_for_template();\n\t\tthis.dialog.$wrapper.find('.edit-full').text(__('Edit in full page for more options like assets, serial nos, batches etc.'))\n\t},\n\n\tcheck_naming_series_based_on: function() {\n\t\tif (frappe.defaults.get_default(\"item_naming_by\") === \"Naming Series\") {\n\t\t\tthis.mandatory = this.mandatory.filter(d => d.fieldname !== \"item_code\");\n\t\t}\n\t},\n\n\tinit_post_render_dialog_operations: function() {\n\t\tthis.dialog.fields_dict.attribute_html.$wrapper.append(frappe.render_template(\"item_quick_entry\"));\n\t\tthis.init_for_create_variant_trigger();\n\t\tthis.init_for_item_template_trigger();\n\t\t// explicitly hide manufacturing fields as hidden not working.\n\t\tthis.toggle_manufacturer_fields();\n\t\tthis.dialog.get_field(\"item_template\").df.hidden = 1;\n\t\tthis.dialog.get_field(\"item_template\").refresh();\n\t},\n\n\tregister_primary_action: function() {\n\t\tvar me = this;\n\t\tthis.dialog.set_primary_action(__('Save'), function() {\n\t\t\tif (me.dialog.working) return;\n\n\t\t\tvar data = me.dialog.get_values();\n\t\t\tvar variant_values = {};\n\n\t\t\tif (me.dialog.fields_dict.create_variant.$input.prop(\"checked\")) {\n\t\t\t\tvariant_values = me.get_variant_doc();\n\t\t\t\tif (!Object.keys(variant_values).length) {\n\t\t\t\t\tdata = null;\n\t\t\t\t}\n\t\t\t\tvariant_values.stock_uom = me.template_doc.stock_uom;\n\t\t\t\tvariant_values.item_group = me.template_doc.item_group;\n\t\t\t}\n\n\t\t\tif (data) {\n\t\t\t\tme.dialog.working = true;\n\t\t\t\tvar values = me.update_doc();\n\t\t\t\t//patch for manufacturer type variants as extend is overwriting it.\n\t\t\t\tif (variant_values['variant_based_on'] == \"Manufacturer\") {\n\t\t\t\t\tvalues['variant_based_on'] = \"Manufacturer\";\n\t\t\t\t}\n\t\t\t\t$.extend(variant_values, values);\n\t\t\t\tme.insert(variant_values);\n\t\t\t}\n\t\t});\n\t},\n\n\tinsert: function(variant_values) {\n\t\tlet me = this;\n\t\treturn new Promise(resolve => {\n\t\t\tfrappe.call({\n\t\t\t\tmethod: \"frappe.client.insert\",\n\t\t\t\targs: {\n\t\t\t\t\tdoc: variant_values\n\t\t\t\t},\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tme.dialog.hide();\n\t\t\t\t\t// delete the old doc\n\t\t\t\t\tfrappe.model.clear_doc(me.dialog.doc.doctype, me.dialog.doc.name);\n\t\t\t\t\tme.dialog.doc = r.message;\n\t\t\t\t\tif (frappe._from_link) {\n\t\t\t\t\t\tfrappe.ui.form.update_calling_link(me.dialog.doc);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif (me.after_insert) {\n\t\t\t\t\t\t\tme.after_insert(me.dialog.doc);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tme.open_form_if_not_list();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\terror: function() {\n\t\t\t\t\tme.open_doc();\n\t\t\t\t},\n\t\t\t\talways: function() {\n\t\t\t\t\tme.dialog.working = false;\n\t\t\t\t\tresolve(me.dialog.doc);\n\t\t\t\t},\n\t\t\t\tfreeze: true\n\t\t\t});\n\t\t});\n\t},\n\n\topen_doc: function() {\n\t\tthis.dialog.hide();\n\t\tthis.update_doc();\n\t\tif (this.dialog.fields_dict.create_variant.$input.prop(\"checked\")) {\n\t\t\tvar template = this.dialog.fields_dict.item_template.input.value;\n\t\t\tif (template)\n\t\t\t\tfrappe.set_route(\"Form\", this.doctype, template);\n\t\t} else {\n\t\t\tfrappe.set_route('Form', this.doctype, this.doc.name);\n\t\t}\n\t},\n\n\tget_variant_fields: function() {\n\t\tvar variant_fields = [{\n\t\t\tfieldname: \"create_variant\",\n\t\t\tfieldtype: \"Check\",\n\t\t\tlabel: __(\"Create Variant\")\n\t\t},\n\t\t{\n\t\t\tfieldname: 'item_template',\n\t\t\tlabel: __('Item Template'),\n\t\t\treqd: 0,\n\t\t\tfieldtype: 'Link',\n\t\t\toptions: \"Item\",\n\t\t\tget_query: function() {\n\t\t\t\treturn {\n\t\t\t\t\tfilters: {\n\t\t\t\t\t\t\"has_variants\": 1\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t}\n\t\t}];\n\n\t\treturn variant_fields;\n\t},\n\n\tget_manufacturing_fields: function() {\n\t\tthis.manufacturer_fields = [{\n\t\t\tfieldtype: 'Link',\n\t\t\toptions: 'Manufacturer',\n\t\t\tlabel: 'Manufacturer',\n\t\t\tfieldname: \"manufacturer\",\n\t\t\thidden: 1,\n\t\t\treqd: 0\n\t\t}, {\n\t\t\tfieldtype: 'Data',\n\t\t\tlabel: 'Manufacturer Part Number',\n\t\t\tfieldname: 'manufacturer_part_no',\n\t\t\thidden: 1,\n\t\t\treqd: 0\n\t\t}];\n\t\treturn this.manufacturer_fields;\n\t},\n\n\tget_attributes_fields: function() {\n\t\tvar attribute_fields = [{\n\t\t\tfieldname: 'attribute_html',\n\t\t\tfieldtype: 'HTML'\n\t\t}]\n\n\t\tattribute_fields = attribute_fields.concat(this.get_manufacturing_fields());\n\t\treturn attribute_fields;\n\t},\n\n\tinit_for_create_variant_trigger: function() {\n\t\tvar me = this;\n\n\t\tthis.dialog.fields_dict.create_variant.$input.on(\"click\", function() {\n\t\t\tme.preset_fields_for_template();\n\t\t\tme.init_post_template_trigger_operations(false, [], true);\n\t\t});\n\t},\n\n\tpreset_fields_for_template: function() {\n\t\tvar for_variant = this.dialog.get_value('create_variant');\n\n\t\t// setup template field, seen and mandatory if variant\n\t\tlet template_field = this.dialog.get_field(\"item_template\");\n\t\ttemplate_field.df.reqd = for_variant;\n\t\ttemplate_field.set_value('');\n\t\ttemplate_field.df.hidden = !for_variant;\n\t\ttemplate_field.refresh();\n\n\t\t// hide properties for variant\n\t\t['item_code', 'item_name', 'item_group', 'stock_uom'].forEach((d) => {\n\t\t\tlet f = this.dialog.get_field(d);\n\t\t\tf.df.hidden = for_variant;\n\t\t\tf.refresh();\n\t\t});\n\n\t\tthis.dialog.get_field('attribute_html').toggle(false);\n\n\t\t// non mandatory for variants\n\t\t['item_code', 'stock_uom', 'item_group'].forEach((d) => {\n\t\t\tlet f = this.dialog.get_field(d);\n\t\t\tf.df.reqd = !for_variant;\n\t\t\tf.refresh();\n\t\t});\n\n\t},\n\n\tinit_for_item_template_trigger: function() {\n\t\tvar me = this;\n\n\t\tme.dialog.fields_dict[\"item_template\"].df.onchange = () => {\n\t\t\tvar template = me.dialog.fields_dict.item_template.input.value;\n\t\t\tme.template_doc = null;\n\t\t\tif (template) {\n\t\t\t\tfrappe.call({\n\t\t\t\t\tmethod: \"frappe.client.get\",\n\t\t\t\t\targs: {\n\t\t\t\t\t\tdoctype: \"Item\",\n\t\t\t\t\t\tname: template\n\t\t\t\t\t},\n\t\t\t\t\tcallback: function(r) {\n\t\t\t\t\t\tme.template_doc = r.message;\n\t\t\t\t\t\tme.is_manufacturer = false;\n\n\t\t\t\t\t\tif (me.template_doc.variant_based_on === \"Manufacturer\") {\n\t\t\t\t\t\t\tme.init_post_template_trigger_operations(true, [], true);\n\t\t\t\t\t\t} else {\n\n\t\t\t\t\t\t\tme.init_post_template_trigger_operations(false, me.template_doc.attributes, false);\n\t\t\t\t\t\t\tme.render_attributes(me.template_doc.attributes);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tme.dialog.get_field('attribute_html').toggle(false);\n\t\t\t\tme.init_post_template_trigger_operations(false, [], true);\n\t\t\t}\n\t\t}\n\t},\n\n\tinit_post_template_trigger_operations: function(is_manufacturer, attributes, attributes_flag) {\n\t\tthis.attributes = attributes;\n\t\tthis.attribute_values = {};\n\t\tthis.attributes_count = attributes.length;\n\n\t\tthis.dialog.fields_dict.attribute_html.$wrapper.find(\".attributes\").empty();\n\t\tthis.is_manufacturer = is_manufacturer;\n\t\tthis.toggle_manufacturer_fields();\n\t\tthis.dialog.fields_dict.attribute_html.$wrapper.find(\".attributes\").toggleClass(\"hide-control\", attributes_flag);\n\t\tthis.dialog.fields_dict.attribute_html.$wrapper.find(\".attributes-header\").toggleClass(\"hide-control\", attributes_flag);\n\t},\n\n\ttoggle_manufacturer_fields: function() {\n\t\tvar me = this;\n\t\t$.each(this.manufacturer_fields, function(i, dialog_field) {\n\t\t\tme.dialog.get_field(dialog_field.fieldname).df.hidden = !me.is_manufacturer;\n\t\t\tme.dialog.get_field(dialog_field.fieldname).df.reqd = dialog_field.fieldname == 'manufacturer' ? me.is_manufacturer : false;\n\t\t\tme.dialog.get_field(dialog_field.fieldname).refresh();\n\t\t});\n\t},\n\n\tinitiate_render_attributes: function() {\n\t\tthis.dialog.fields_dict.attribute_html.$wrapper.find(\".attributes\").empty();\n\t\tthis.render_attributes(this.attributes);\n\t},\n\n\trender_attributes: function(attributes) {\n\t\tvar me = this;\n\n\t\tthis.dialog.get_field('attribute_html').toggle(true);\n\n\t\t$.each(attributes, function(index, row) {\n\t\t\tvar desc = \"\";\n\t\t\tvar fieldtype = \"Data\";\n\t\t\tif (row.numeric_values) {\n\t\t\t\tfieldtype = \"Float\";\n\t\t\t\tdesc = \"Min Value: \" + row.from_range + \" , Max Value: \" + row.to_range + \", in Increments of: \" + row.increment;\n\t\t\t}\n\n\t\t\tme.init_make_control(fieldtype, row);\n\t\t\tme[row.attribute].set_value(me.attribute_values[row.attribute] || \"\");\n\t\t\tme[row.attribute].$wrapper.toggleClass(\"has-error\", me.attribute_values[row.attribute] ? false : true);\n\n\t\t\t// Set Label explicitly as make_control is not displaying label\n\t\t\t$(me[row.attribute].label_area).text(__(row.attribute));\n\n\t\t\tif (desc) {\n\t\t\t\t$(repl(`<p class=\"help-box small text-muted hidden-xs\">%(desc)s</p>`, {\n\t\t\t\t\t\"desc\": desc\n\t\t\t\t})).insertAfter(me[row.attribute].input_area);\n\t\t\t}\n\n\t\t\tif (!row.numeric_values) {\n\t\t\t\tme.init_awesomplete_for_attribute(row);\n\t\t\t} else {\n\t\t\t\tme[row.attribute].$input.on(\"change\", function() {\n\t\t\t\t\tme.attribute_values[row.attribute] = $(this).val();\n\t\t\t\t\t$(this).closest(\".frappe-control\").toggleClass(\"has-error\", $(this).val() ? false : true);\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t},\n\n\tinit_make_control: function(fieldtype, row) {\n\t\tthis[row.attribute] = frappe.ui.form.make_control({\n\t\t\tdf: {\n\t\t\t\t\"fieldtype\": fieldtype,\n\t\t\t\t\"label\": row.attribute,\n\t\t\t\t\"fieldname\": row.attribute,\n\t\t\t\t\"options\": row.options || \"\"\n\t\t\t},\n\t\t\tparent: $(this.dialog.fields_dict.attribute_html.wrapper).find(\".attributes\"),\n\t\t\tonly_input: false\n\t\t});\n\t\tthis[row.attribute].make_input();\n\t},\n\n\tinit_awesomplete_for_attribute: function(row) {\n\t\tvar me = this;\n\n\t\tthis[row.attribute].input.awesomplete = new Awesomplete(this[row.attribute].input, {\n\t\t\tminChars: 0,\n\t\t\tmaxItems: 99,\n\t\t\tautoFirst: true,\n\t\t\tlist: [],\n\t\t});\n\n\t\tthis[row.attribute].$input.on('input', function(e) {\n\t\t\tfrappe.call({\n\t\t\t\tmethod: \"frappe.client.get_list\",\n\t\t\t\targs: {\n\t\t\t\t\tdoctype: \"Item Attribute Value\",\n\t\t\t\t\tfilters: [\n\t\t\t\t\t\t[\"parent\", \"=\", $(e.target).attr(\"data-fieldname\")],\n\t\t\t\t\t\t[\"attribute_value\", \"like\", e.target.value + \"%\"]\n\t\t\t\t\t],\n\t\t\t\t\tfields: [\"attribute_value\"],\n\t\t\t\t\tparent: \"Item Attribute\"\n\t\t\t\t},\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tif (r.message) {\n\t\t\t\t\t\te.target.awesomplete.list = r.message.map(function(d) {\n\t\t\t\t\t\t\treturn d.attribute_value;\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}).on('focus', function(e) {\n\t\t\t$(e.target).val('').trigger('input');\n\t\t}).on(\"awesomplete-close\", function (e) {\n\t\t\tme.attribute_values[$(e.target).attr(\"data-fieldname\")] = e.target.value;\n\t\t\t$(e.target).closest(\".frappe-control\").toggleClass(\"has-error\", e.target.value ? false : true);\n\t\t});\n\t},\n\n\tget_variant_doc: function() {\n\t\tvar me = this;\n\t\tvar variant_doc = {};\n\t\tvar attribute = this.validate_mandatory_attributes();\n\n\t\tif (Object.keys(attribute).length) {\n\t\t\tfrappe.call({\n\t\t\t\tmethod: \"erpnext.controllers.item_variant.create_variant_doc_for_quick_entry\",\n\t\t\t\targs: {\n\t\t\t\t\t\"template\": me.dialog.fields_dict.item_template.$input.val(),\n\t\t\t\t\targs: attribute\n\t\t\t\t},\n\t\t\t\tasync: false,\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tif (Object.prototype.toString.call(r.message) == \"[object Object]\") {\n\t\t\t\t\t\tvariant_doc = r.message;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tvar msgprint_dialog = frappe.msgprint(__(\"Item Variant {0} already exists with same attributes\", [repl('<a class=\"strong variant-click\" data-item-code=\"%(item)s\" \\\n\t\t\t\t\t\t\t\t>%(item)s</a>', {\n\t\t\t\t\t\t\t\titem: r.message\n\t\t\t\t\t\t\t})]));\n\n\t\t\t\t\t\tmsgprint_dialog.$wrapper.find(\".variant-click\").on(\"click\", function() {\n\t\t\t\t\t\t\tmsgprint_dialog.hide();\n\t\t\t\t\t\t\tme.dialog.hide();\n\t\t\t\t\t\t\tif (frappe._from_link) {\n\t\t\t\t\t\t\t\tfrappe._from_link.set_value($(this).attr(\"data-item-code\"));\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tfrappe.set_route('Form', \"Item\", $(this).attr(\"data-item-code\"));\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\t\treturn variant_doc;\n\t},\n\n\tvalidate_mandatory_attributes: function() {\n\t\tvar me = this;\n\t\tvar attribute = {};\n\t\tvar mandatory = [];\n\n\t\t$.each(this.attributes, function(index, attr) {\n\t\t\tvar value = me.attribute_values[attr.attribute] || \"\";\n\t\t\tif (value) {\n\t\t\t\tattribute[attr.attribute] = attr.numeric_values ? flt(value) : value;\n\t\t\t} else {\n\t\t\t\tmandatory.push(attr.attribute);\n\t\t\t}\n\t\t})\n\n\t\tif (this.is_manufacturer) {\n\t\t\t$.each(this.manufacturer_fields, function(index, field) {\n\t\t\t\tattribute[field.fieldname] = me.dialog.fields_dict[field.fieldname].input.value;\n\t\t\t});\n\t\t}\n\t\treturn attribute;\n\t}\n});","frappe.provide('frappe.ui.form');\n\nfrappe.ui.form.CustomerQuickEntryForm = frappe.ui.form.QuickEntryForm.extend({\n\tinit: function(doctype, after_insert) {\n\t\tthis.skip_redirect_on_error = true;\n\t\tthis._super(doctype, after_insert);\n\t},\n\n\trender_dialog: function() {\n\t\tthis.mandatory = this.mandatory.concat(this.get_variant_fields());\n\t\tthis._super();\n\t},\n\n\tget_variant_fields: function() {\n\t\tvar variant_fields = [{\n\t\t\tfieldtype: \"Section Break\",\n\t\t\tlabel: __(\"Primary Contact Details\"),\n\t\t\tcollapsible: 1\n\t\t},\n\t\t{\n\t\t\tlabel: __(\"Email Id\"),\n\t\t\tfieldname: \"email_id\",\n\t\t\tfieldtype: \"Data\"\n\t\t},\n\t\t{\n\t\t\tfieldtype: \"Column Break\"\n\t\t},\n\t\t{\n\t\t\tlabel: __(\"Mobile Number\"),\n\t\t\tfieldname: \"mobile_no\",\n\t\t\tfieldtype: \"Data\"\n\t\t},\n\t\t{\n\t\t\tfieldtype: \"Section Break\",\n\t\t\tlabel: __(\"Primary Address Details\"),\n\t\t\tcollapsible: 1\n\t\t},\n\t\t{\n\t\t\tlabel: __(\"Address Line 1\"),\n\t\t\tfieldname: \"address_line1\",\n\t\t\tfieldtype: \"Data\"\n\t\t},\n\t\t{\n\t\t\tlabel: __(\"Address Line 2\"),\n\t\t\tfieldname: \"address_line2\",\n\t\t\tfieldtype: \"Data\"\n\t\t},\n\t\t{\n\t\t\tlabel: __(\"ZIP Code\"),\n\t\t\tfieldname: \"pincode\",\n\t\t\tfieldtype: \"Data\"\n\t\t},\n\t\t{\n\t\t\tfieldtype: \"Column Break\"\n\t\t},\n\t\t{\n\t\t\tlabel: __(\"City\"),\n\t\t\tfieldname: \"city\",\n\t\t\tfieldtype: \"Data\"\n\t\t},\n\t\t{\n\t\t\tlabel: __(\"State\"),\n\t\t\tfieldname: \"state\",\n\t\t\tfieldtype: \"Data\"\n\t\t},\n\t\t{\n\t\t\tlabel: __(\"Country\"),\n\t\t\tfieldname: \"country\",\n\t\t\tfieldtype: \"Link\",\n\t\t\toptions: \"Country\"\n\t\t},\n\t\t{\n\t\t\tlabel: __(\"Customer POS Id\"),\n\t\t\tfieldname: \"customer_pos_id\",\n\t\t\tfieldtype: \"Data\",\n\t\t\thidden: 1\n\t\t}];\n\n\t\treturn variant_fields;\n\t},\n})","frappe.provide('erpnext.accounts');\n\nerpnext.accounts.dimensions = {\n\tsetup_dimension_filters(frm, doctype) {\n\t\tthis.accounting_dimensions = [];\n\t\tthis.default_dimensions = {};\n\t\tthis.fetch_custom_dimensions(frm, doctype);\n\t},\n\n\tfetch_custom_dimensions(frm, doctype) {\n\t\tlet me = this;\n\t\tfrappe.call({\n\t\t\tmethod: \"erpnext.accounts.doctype.accounting_dimension.accounting_dimension.get_dimensions\",\n\t\t\targs: {\n\t\t\t\t'with_cost_center_and_project': true\n\t\t\t},\n\t\t\tcallback: function(r) {\n\t\t\t\tme.accounting_dimensions = r.message[0];\n\t\t\t\tme.default_dimensions = r.message[1];\n\t\t\t\tme.setup_filters(frm, doctype);\n\t\t\t}\n\t\t});\n\t},\n\n\tsetup_filters(frm, doctype) {\n\t\tif (this.accounting_dimensions) {\n\t\t\tthis.accounting_dimensions.forEach((dimension) => {\n\t\t\t\tfrappe.model.with_doctype(dimension['document_type'], () => {\n\t\t\t\t\tlet parent_fields = [];\n\t\t\t\t\tfrappe.meta.get_docfields(doctype).forEach((df) => {\n\t\t\t\t\t\tif (df.fieldtype === 'Link' && df.options === 'Account') {\n\t\t\t\t\t\t\tparent_fields.push(df.fieldname);\n\t\t\t\t\t\t} else if (df.fieldtype === 'Table') {\n\t\t\t\t\t\t\tthis.setup_child_filters(frm, df.options, df.fieldname, dimension['fieldname']);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (frappe.meta.has_field(doctype, dimension['fieldname'])) {\n\t\t\t\t\t\t\tthis.setup_account_filters(frm, dimension['fieldname'], parent_fields);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\t},\n\n\tsetup_child_filters(frm, doctype, parentfield, dimension) {\n\t\tlet fields = [];\n\n\t\tif (frappe.meta.has_field(doctype, dimension)) {\n\t\t\tfrappe.model.with_doctype(doctype, () => {\n\t\t\t\tfrappe.meta.get_docfields(doctype).forEach((df) => {\n\t\t\t\t\tif (df.fieldtype === 'Link' && df.options === 'Account') {\n\t\t\t\t\t\tfields.push(df.fieldname);\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\t\tfrm.set_query(dimension, parentfield, function(doc, cdt, cdn) {\n\t\t\t\t\tlet row = locals[cdt][cdn];\n\t\t\t\t\treturn erpnext.queries.get_filtered_dimensions(row, fields, dimension, doc.company);\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\t},\n\n\tsetup_account_filters(frm, dimension, fields) {\n\t\tfrm.set_query(dimension, function(doc) {\n\t\t\treturn erpnext.queries.get_filtered_dimensions(doc, fields, dimension, doc.company);\n\t\t});\n\t},\n\n\tupdate_dimension(frm, doctype) {\n\t\tif (this.accounting_dimensions) {\n\t\t\tthis.accounting_dimensions.forEach((dimension) => {\n\t\t\t\tif (frm.is_new()) {\n\t\t\t\t\tif (frm.doc.company && Object.keys(this.default_dimensions || {}).length > 0\n\t\t\t\t\t\t&& this.default_dimensions[frm.doc.company]) {\n\n\t\t\t\t\t\tlet default_dimension = this.default_dimensions[frm.doc.company][dimension['fieldname']];\n\n\t\t\t\t\t\tif (default_dimension) {\n\t\t\t\t\t\t\tif (frappe.meta.has_field(doctype, dimension['fieldname'])) {\n\t\t\t\t\t\t\t\tfrm.set_value(dimension['fieldname'], default_dimension);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t$.each(frm.doc.items || frm.doc.accounts || [], function(i, row) {\n\t\t\t\t\t\t\t\tfrappe.model.set_value(row.doctype, row.name, dimension['fieldname'], default_dimension);\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t},\n\n\tcopy_dimension_from_first_row(frm, cdt, cdn, fieldname) {\n\t\tif (frappe.meta.has_field(frm.doctype, fieldname) && this.accounting_dimensions) {\n\t\t\tthis.accounting_dimensions.forEach((dimension) => {\n\t\t\t\tlet row = frappe.get_doc(cdt, cdn);\n\t\t\t\tfrm.script_manager.copy_from_first_row(fieldname, row, [dimension['fieldname']]);\n\t\t\t});\n\t\t}\n\t}\n};","frappe.ui.form.ControlData = frappe.ui.form.ControlData.extend( {\n\tmake_input() {\n\t\tthis._super();\n\n\t\tif (this.df.options == 'Phone') {\n\t\t\tthis.setup_phone();\n\t\t}\n\n\t\tif (this.frm && this.frm.fields_dict) {\n\t\t\tObject.values(this.frm.fields_dict).forEach(function(field) {\n\t\t\t\tif (field.df.read_only === 1 && field.df.options === 'Phone' \n\t\t\t\t\t&& field.disp_area.style[0] != 'display' && !field.has_icon) {\n\t\t\t\t\tfield.setup_phone();\n\t\t\t\t\tfield.has_icon = true;\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t},\n\tsetup_phone() {\n\t\tif (frappe.phone_call.handler) {\n\t\t\tlet control = this.df.read_only ? '.control-value' : '.control-input';\n\t\t\tthis.$wrapper.find(control)\n\t\t\t\t.append(`\n\t\t\t\t\t<span class=\"phone-btn\">\n\t\t\t\t\t\t<a class=\"btn-open no-decoration\" title=\"${__('Make a call')}\">\n\t\t\t\t\t\t\t${frappe.utils.icon('call')}\n\t\t\t\t\t</span>\n\t\t\t\t`)\n\t\t\t\t.find('.phone-btn')\n\t\t\t\t.click(() => {\n\t\t\t\t\tfrappe.phone_call.handler(this.get_value(), this.frm);\n\t\t\t\t});\n\t\t}\n\t}\n});"],"names":["frappe","provide","$","extend","breadcrumbs","preferred","Item Group","Customer Group","Supplier Group","Territory","Sales Person","Sales Partner","Brand","Maintenance Schedule","Maintenance Visit","module_map","ERPNext Integrations","Geo","Portal","Utilities","Shopping Cart","Contacts","Accounts","erpnext","get_currency","company","cur_frm","doc","get_doc","default_currency","boot","sysdefaults","currency","get_presentation_currency_list","const","currency_list","docs","filter","d","doctype","map","name","unshift","toggle_naming_series","fields_dict","naming_series","toggle_display","__islocal","hide_company","companies","Object","keys","locals","length","set_value","last_selected_company","is_perpetual_inventory_enabled","enable_perpetual_inventory","stale_rate_allowed","cint","allow_stale","setup_serial_no","grid_row","open_grid_row","grid_form","serial_no","get_status","$btn","__","appendTo","css","margin-bottom","margin-top","$wrapper","me","this","on","model","get_value","item_code","data","has_serial_no","show_serial_batch_selector","frm","route_to_adjustment_jv","args","with_doctype","let","journal_entry","get_new_doc","accounts","forEach","je_account","child_row","add_child","account","debit_in_account_currency","credit_in_account_currency","party_type","set_route","utils","set_party_dashboard_indicators","__onload","dashboard_info","company_wise_info","info","add_indicator_for_multicompany","dashboard","add_indicator","format_currency","billing_this_year","total_unpaid","loyalty_points","stats_area","removeClass","stats_area_row","addClass","color","indicator","get_party_name","Customer","Supplier","Employee","Member","copy_value_in_all_rows","dt","dn","table_fieldname","fieldname","cl","i","refresh_field","get_terms","tc_name","callback","call","method","template_name","r","make_bank_account","docname","freeze","doclist","sync","message","add_dimensions","report_name","index","filters","query_reports","dimension","some","el","splice","label","fieldtype","options","make_auto_repeat","make_pricing_rule","first_row_is_empty","child_table","isArray","remove_empty_first_row","child_table_name","rows","get_tree_options","option","unscrub_option","unscrub","user_permission","defaults","get_user_permissions","perm","c","sort","value","self","indexOf","get_tree_default","includes","get_default","overrides_parent_value_in_all_rows","parent_fieldname","create_new_doc","update_fields","new_doc","entries","key","ui","form","make_quick_entry","select_alternate_items","opts","warehouse_field","item_field","dialog","Dialog","title","fields","cannot_add_rows","in_place_edit","get_data","hidden","in_list_view","read_only","disabled","default","onchange","warehouse","on_grid_fields_dict","actual_qty","get_query","e","query","primary_action","get_values","alternate_item","row","child_doctype","qty","required_qty","script_manager","trigger","then","original_item_field","child_docname","hide","primary_action_label","condition","alternative_items","df","push","grid","refresh","show","update_child_items","cannot_add_row","child_meta","get_meta","get_precision","find","f","precision","reqd","uom","exc","conversion_factor","trans_items","parent_doctype","parent_doctype_name","reload_doc","delivery_date","schedule_date","rate","map_current_doc","_map","items","items_doctype","meta","get_docfield","link_fieldname","source_doctype","already_set","item_qty_map","each","source_name","src","flt","with_doc","source_doc","msgprint","type","source_names","target_doc","dirty","query_args","get_query_filters","get_query_method","MultiSelectDialog","target","date_field","undefined","setters","add_filters_group","action","selections","values","link_formatters","item_name","employee_name","document","datetime","is_timezone_same","set_df_property","sys_defaults","time_zone","queries","user","lead","customer","supplier","item","bom","task","customer_filter","throw","get_label","contact_query","dynamic_link","link_doctype","link_name","address_query","company_address_query","is_your_company_address","supplier_filter","lead_filter","not_a_group_filter","is_group","employee","cstr","get_filtered_dimensions","child_fields","field","setup_queries","query_fn","set_query","parentfield","link_fields","get_docfields","setup_warehouse_query","cdt","cdn","SMSManager","setup","default_msg","Lead","Opportunity","Quotation","Sales Order","quotation_no","po_no","Delivery Note","Sales Invoice","Material Request","Purchase Order","Purchase Receipt","in_list","contact_person","party_name","mobile_no","contact_no","get_contact_number","contact","ref_doctype","ref_name","contact_name","number","show_dialog","mobile_nos","make_dialog","set_values","width","send","input","onclick","btn","v","set_working","receiver_list","msg","done_working","get_party_details","company_address","shipping_address","quotation_to","party","price_list","selling_price_list","bill_date","buying_price_list","shipping_address_name","posting_date","transaction_date","validate_mandatory","supplier_tds","updating_party_details","run_serially","add_item","is_new","prev_route","get_prev_route","get_address_display","address_field","display_field","address_dict","set_taxes_from_address","triggered_from_field","billing_address_field","shipping_address_field","tax_category","billing_address","set_taxes","customer_group","supplier_group","get_contact_details","trigger_on","get_shipping_address","inter_com_order_reference","internal_invoice_reference","internal_order_reference","address","stock","StockController","Controller","onload","setup_posting_date_time_check","docstatus","set_posting_time","nowdate","posting_time","now_time","show_stock_ledger","add_custom_button","route_options","voucher_no","from_date","to_date","moment","modified","format","show_cancelled_entries","show_general_ledger","group_by","payments","make_payment","$body","body","set_payment_primary_action","make_keyboard","select_text","click","select","set_primary_action","amount","submit_invoice","empty","html","render_template","show_payment_details","bind_keyboard_event","clear_amount","make_multimode_payment","change_amount","payment_val","outstanding_amount","mode_of_payment","multimode_payments","idx","paid_amount","selected_mode","repl","highlight_selected_row","bind_amount_change_event","set_outstanding_amount","val","conversion_rate","update_payment_amount","bind_form_control_event","bind_numeric_keys_event","attr","update_paid_amount","change","write_off_amount","selected_row","text","slice","stopPropagation","base_write_off_amount","calculate_outstanding_amount","show_amounts","calculate_write_off_amount","update_write_off","update_invoice","taxes_and_totals","fetch_round_off_accounts","apply_pricing_rule_on_item","effective_item_rate","price_list_rate","item_rate","parenttype","blanket_order_rate","margin_type","rate_with_margin","margin_rate_or_amount","base_rate_with_margin","discount_percentage","discount_amount","calculate_taxes_and_totals","discount_amount_applied","_calculate_taxes_and_totals","calculate_discount_amount","is_return","calculate_total_advance","is_pos","update_paid_amount_for_return","calculate_commission","calculate_contribution","grand_total","refresh_fields","set_discount_amount","apply_discount_amount","validate_conversion_rate","calculate_item_values","initialize_taxes","determine_exclusive_rate","calculate_net_total","calculate_taxes","manipulate_grand_total_for_inclusive_tax","calculate_totals","_cleanup","conversion_rate_label","company_currency","get_company_currency","subs","err_message","round_floats_in","net_rate","net_amount","item_tax_amount","total_weight","weight_per_unit","stock_qty","set_in_company_currency","tax","item_wise_tax_detail","tax_fields","charge_type","apply_discount_on","cscript","validate_taxes_and_charges","validate_inclusive_tax","flags","round_off_applicable_accounts","account_list","has_inclusive_tax","included_in_print_rate","n","item_tax_map","_load_item_tax_rate","item_tax_rate","cumulated_tax_fraction","total_inclusive_tax_amount_per_qty","current_tax_fraction","get_current_tax_fraction","tax_fraction_for_current_item","inclusive_tax_amount_per_qty","grand_total_fraction_for_current_item","tax_rate","_get_tax_rate","row_id","add_deduct_tax","item_tax","account_head","total_qty","total","base_total","net_total","base_net_total","base_amount","base_net_amount","rounding_adjustment","actual_tax_dict","tax_amount","current_tax_amount","get_current_tax_amount","tax_amount_for_current_item","tax_amount_after_discount_amount","category","grand_total_for_current_item","round_off_totals","set_cumulative_total","row_idx","JSON","parse","actual","get_final_tax_amount","set_item_wise_tax","Math","round","tax_detail","item_wise_tax_amount","any_inclusive_tax","taxes","last_tax","non_inclusive_tax_amount","sum","diff","abs","pow","tax_count","base_grand_total","taxes_and_charges_added","taxes_and_charges_deducted","total_taxes_and_charges","set_rounded_total","disable_rounded_total","rounded_total","base_rounded_total","round_based_on_smallest_currency_fraction","base_in_words","in_words","temporary_fields","stringify","additional_discount_percentage","scrub","distributed_amount","base_discount_amount","total_for_discount_amount","get_total_for_discount_amount","discount_amount_loss","total_actual_tax","actual_taxes_dict","actual_tax_amount","total_allocated_amount","adv","allocated_amount","total_advance","is_internal_invoice","represents_company","calculate_paid_amount","party_account_currency","total_amount_to_pay","total_amount_for_payment","redeem_loyalty_points","loyalty_amount","set_default_payment","calculate_change_amount","base_paid_amount","pay","base_change_amount","payment_types","TransactionController","_super","hide_serial_batch_dialog","has_margin_field","has_field","set_gross_profit","calculate_stock_uom_rate","tax_table","set_dynamic_labels","via_discount_percentage","items_add","set_warehouse","target_warehouse","set_target_warehouse","from_warehouse","set_from_warehouse","dimensions","copy_dimension_from_first_row","get_field","set_query_for_batch","payment_terms_template","payment_schedule","calculate_net_weight","set_indicator_formatter","batch_no_field","get_route_options_for_new_doc","blanket_order_type","taxes_and_charges","get_user_default","amended_from","return_against","setup_quality_inspection","inspection_type","reference_type","reference_name","description","item_serial_no","split","batch_no","make_payment_request","recipient_id","contact_email","onload_post_render","load_after_mapping","after_ajax","apply_default_taxes","setup_item_selector","set_multiple_add","setup_sms","scan_barcode_field","set_new_description","is_mobile","$input_wrapper","$input_group","append","$input","barcode","scan_barcode","search_value","exist","cur_grid","row_to_modify","existing_item_row","blank_item_row","show_alert","from_barcode","taxes_and_charges_field","master_doctype","tax_template","debounce","status","page","add_menu_item","send_sms","update_stock","show_batch_dialog","validate_company_and_party","child","price_list_currency","plc_conversion_rate","order_type","is_subcontracted","ignore_pricing_rule","project","weight_uom","manufacturer","stock_uom","pos_profile","cost_center","item_tax_template","add_taxes_from_item_tax_template","free_item_data","apply_product_discount","is_internal_customer","is_internal_supplier","get_incoming_rate","toggle_conversion_factor","db","has_batch_no","get_single_value","k","remove_pricing_rule","apply_rule_on_other_items","is_down_payment_item","grid_rows","remove","voucher_type","item_args","allow_zero_valuation_rate","replace","user_defaults","set_qty_in_transactions_based_on_serial_no_input","setTimeout","update_qty","serialnos","valid_serial_nos","validate","set_default_internal_warehouse","default_in_transit_warehouse","set_pricing","company_doc","default_letter_head","letter_head","default_selling_terms","default_buying_terms","update_item_tax_map","apply_pricing_rule","set_party_account","party_account_field","rt","due_date","recalculate_terms","message1","message2","final_message","term","payment_term","get_exchange_rate","exchange_rate","set_margin_amount_based_on_currency","set_actual_charges_based_on_currency","in_apply_price_list","apply_price_list","shipping_rule","fail","from_currency","to_currency","freeze_message","dont_fetch_price_list_rate","fields_map","toggle_enable","stock_uom_rate","service_stop_date","start_date","Date","service_start_date","end_date","service_end_date","stop_date","total_net_weight","toggle_reqd","price_list_name","change_form_labels","change_grid_labels","set_currency_labels","item_grid","fname","set_column_disp","wrapper","recalculate","recalculate_values","calculate_charges","item_list","is_free_item","pricing_rules","parent","row_item","_set_values_for_item_list","_get_args","_get_item_list","territory","campaign","sales_partner","coupon_code","append_item","item_group","brand","children","price_list_rate_changed","items_rule_dict","l","existing_pricing_rule","apply_rule_on","price_or_product_discount","exist_items","pr_row","reset_plc_conversion","always","remove_free_item","applied_on_items","apply_on","trigger_price_list_rate","valid","master_name","as_json","item_codes","hasOwnProperty","is_recurring","recurring_id","owner_email","owner","user_info","email","notification_email_address","join","repeat_on_day_of_month","str_to_obj","getDate","refresh_many","months","Monthly","Quarterly","Half-yearly","Yearly","recurring_type","add_months","add_days","valuation_rate","gross_profit","get_advances","make_payment_entry","get_method_for_payment","make_payment_via_journal_entry","set_query_for_item_tax_template","valid_from","terms_template","against_blanket_order","blanket_order","set_reserve_warehouse","autofill_warehouse","supplied_items","on_close","receiving_stock","existing_stock","purpose","s_warehouse","require","SerialNoBatchSelector","warehouse_details","apply_putaway_rule","result","clear_table","assign","ItemSelector","Class","init","item_query","add_items_button","render_items","focus","results","timeout_id","clearTimeout","added","add_new_row","timeout","txt","as_dict","get_filters","link_search","image","abbr","get_abbr","get_palette","docsUrl","language","help","help_links","url","ItemQuickEntryForm","QuickEntryForm","after_insert","render_dialog","mandatory","get_variant_fields","concat","get_attributes_fields","check_naming_series_based_on","init_post_render_dialog_operations","preset_fields_for_template","attribute_html","init_for_create_variant_trigger","init_for_item_template_trigger","toggle_manufacturer_fields","register_primary_action","working","variant_values","create_variant","prop","get_variant_doc","template_doc","update_doc","insert","Promise","resolve","clear_doc","_from_link","update_calling_link","open_form_if_not_list","error","open_doc","template","item_template","has_variants","get_manufacturing_fields","manufacturer_fields","attribute_fields","init_post_template_trigger_operations","for_variant","template_field","toggle","is_manufacturer","variant_based_on","attributes","render_attributes","attributes_flag","attribute_values","attributes_count","toggleClass","dialog_field","initiate_render_attributes","desc","numeric_values","from_range","to_range","increment","init_make_control","attribute","label_area","insertAfter","input_area","closest","init_awesomplete_for_attribute","make_control","only_input","make_input","awesomplete","Awesomplete","minChars","maxItems","autoFirst","list","attribute_value","variant_doc","validate_mandatory_attributes","async","prototype","toString","msgprint_dialog","CustomerQuickEntryForm","skip_redirect_on_error","collapsible","setup_dimension_filters","accounting_dimensions","default_dimensions","fetch_custom_dimensions","with_cost_center_and_project","setup_filters","parent_fields","setup_child_filters","setup_account_filters","update_dimension","default_dimension","copy_from_first_row","ControlData","setup_phone","disp_area","style","has_icon","phone_call","handler","control","icon"],"mappings":"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"}